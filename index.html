<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>æœƒè­°ç®¡ç† 28.0 - éŸ¿æ‡‰å¼ + è‡ªé©æ‡‰ Dock + å¼·åŒ–æœå°‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ========= ä¸»é¡Œè®Šæ•¸ ========= */
    :root{
      --bg:#f1f5f9; --card-bg:#fff; --text-main:#0f172a; --text-muted:#64748b;
      --border:#e2e8f0; --sidebar-bg:#fff; --accent:#0284c7; --input-bg:#f8fafc;

      /* éŸ¿æ‡‰å¼å°ºå¯¸ï¼ˆæœƒä¾ viewport å‹•æ…‹è®ŠåŒ–ï¼‰ */
      --gap: clamp(10px, 1.2vw, 16px);
      --pad: clamp(12px, 1.6vw, 20px);
      --radius: clamp(10px, 1.2vw, 16px);
      --icon: clamp(34px, 4.2vw, 40px);
      --col-min: clamp(280px, 28vw, 420px);
      --font-base: clamp(16px, 1.2vw, 18px);
    }
    [data-theme="dark"]{
      --bg:#0f172a; --card-bg:#1e293b; --text-main:#f8fafc; --text-muted:#94a3b8;
      --border:#334155; --sidebar-bg:#1e293b; --accent:#38bdf8; --input-bg:#0f172a;
    }

    html{ font-size: var(--font-base); height:100%; }
    body, input, select, textarea, button{ font-size: inherit; }
    *{ box-sizing:border-box; transition:.2s ease; }

    /* === å…¨é ç”± body æ²å‹•ï¼ˆå³å´ç€è¦½å™¨å·è»¸ï¼‰ === */
    body{
      font-family:"PingFang TC","Microsoft JhengHei",sans-serif;
      background:var(--bg); color:var(--text-main);
      margin:0; display:flex; min-height:100dvh; overflow:auto;
      -webkit-overflow-scrolling:touch;
    }

    /* å´é‚Šæ¬„ï¼ˆäº¤ç”± body æ²ï¼‰ */
    .sidebar{
      width: clamp(64px, 7vw, 80px);
      background:var(--sidebar-bg); border-right:1px solid var(--border);
      display:flex; flex-direction:column; align-items:center; padding: calc(var(--pad) - 4px) 0;
      overflow:visible; flex-shrink:0;
    }
    .side-icon{
      width: clamp(46px, 5.2vw, 50px);
      height: clamp(46px, 5.2vw, 50px);
      border-radius: clamp(10px, 1.2vw, 12px);
      background:var(--bg); margin-bottom: var(--gap);
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      border:1px solid var(--border); color:var(--text-muted); font-size:1rem; user-select:none; text-align:center;
    }
    .side-icon.active{ background:var(--accent); color:#fff; border-color:var(--accent); box-shadow:0 4px 10px rgba(0,0,0,.1); }
    .side-add{ border:2px dashed var(--text-muted); font-size:1.35rem; }

    /* ä¸»å…§å®¹ï¼ˆä¸è‡ªå¸¶å·è»¸ï¼Œç”± body æ§ï¼‰ */
    .main{
      flex:1 1 auto; min-width:0; padding: var(--pad);
      display:flex; flex-direction:column; overflow:visible;
      max-width: 1320px; margin:0 auto;
      padding-bottom:var(--main-bottom-pad, 24px); /* å³ä¸‹ Dock é¿è®“ï¼ˆJS å‹•æ…‹ï¼‰ */
    }

    .header-section{
      background:var(--card-bg);
      border-radius: var(--radius);
      padding: var(--pad);
      margin-top: calc(var(--pad) - 4px);
      margin-bottom: var(--gap);
      border:1px solid var(--border);
    }

    .info-row{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: var(--gap);
      margin-bottom: 8px;
    }
    .status-row{
      display:grid;
      grid-template-columns: 1fr minmax(260px, 450px);
      gap: clamp(12px, 1.4vw, 20px);
      padding-top: 12px;
      border-top:1px solid var(--border);
    }

    .input-group label{ display:block; color:var(--text-muted); margin-bottom:6px; font-weight:bold; font-size: clamp(16px, 1.1vw, 18px); }
    .input-group select, .input-group input{
      background:var(--input-bg); border:1px solid var(--border); color:var(--text-main);
      padding:10px; border-radius:8px; width:100%; outline:none;
    }
    .input-group select:disabled, .input-group input:disabled{ opacity:.7; cursor:not-allowed; }

    .attendee-list{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; min-height:42px; padding:6px;
      background:var(--input-bg); border-radius:10px; border:1px dashed var(--border);
    }
    .tag{
      background:rgba(56,189,248,.1); color:var(--accent); padding:5px 14px; border-radius:50px;
      font-size:1rem; border:1px solid var(--accent); display:flex; align-items:center; gap:8px; font-weight:bold;
    }

    .del-x{ cursor:pointer; color:#ef4444; font-weight:bold; display:none; margin-left:5px; }
    body[data-edit="true"] .del-x{ display:inline-block !important; }

    /* çœ‹æ¿ */
    .board{
      display:flex; flex-wrap:wrap; gap: var(--gap); flex:1 1 auto; min-height:0;
      overflow:visible; align-content:flex-start; margin-bottom: calc(var(--pad) + 4px);
    }
    .column{
      background:rgba(0,0,0,.02);
      border-radius: var(--radius);
      flex: 1 1 var(--col-min);
      padding: var(--pad);
      display:flex; flex-direction:column;
      border:1px solid var(--border);
      min-height: clamp(220px, 40svh, 420px);
    }
    .column-title{
      font-weight:bold; margin-bottom: clamp(10px, 1vw, 14px);
      color:var(--accent); border-bottom:2px solid var(--accent);
      padding-bottom:6px; font-size: clamp(18px, 1.3vw, 20px);
    }

    .card{
      background:var(--card-bg); border-radius: calc(var(--radius) - 2px);
      padding: clamp(12px, 1.2vw, 14px);
      margin-bottom: var(--gap);
      border:1px solid var(--border); position:relative; display:flex; flex-direction:column;
    }
    .card textarea{ width:100%; background:transparent; border:none; color:var(--text-main); resize:none; font-family:inherit; outline:none; line-height:1.6; }
    .card textarea:disabled{ color:var(--text-main); opacity:1; cursor:default; }
    .card .c-title{ font-size:1rem; font-weight:bold; margin-bottom:6px; border-bottom:1px solid var(--border); padding-bottom:5px; min-height:35px; }
    .card .c-desc{ font-size:1rem; height:56px; overflow:hidden; transition:height .3s ease-in-out; margin-bottom:5px; }
    .card .c-desc.expanded{ overflow:visible; }
    .expand-btn{ font-size:1rem; color:var(--accent); text-align:center; cursor:pointer; padding:4px; margin-top:auto; border-top:1px dashed var(--border); font-weight:bold; user-select:none; opacity:.8; }
    .expand-btn:hover{ opacity:1; background:rgba(0,0,0,.02); }
    .card-meta{ display:flex; align-items:center; gap:10px; margin-top:5px; padding-top:10px; border-top:1px solid var(--border); flex-wrap:wrap; }
    .meta-item{ display:flex; align-items:center; gap:5px; flex:1; min-width:140px; }
    .meta-label{ color:var(--text-muted); font-weight:bold; white-space:nowrap; font-size: clamp(16px, 1.1vw, 18px); }
    .meta-select{ background:var(--input-bg); border:1px solid var(--border); color:var(--text-main); border-radius:6px; font-size:1rem; padding:4px; flex:1; cursor:pointer; }
    .meta-select:disabled{ cursor:not-allowed; opacity:.8; color:var(--text-main); }
    .add-btn-locked{ opacity:.5; cursor:not-allowed !important; pointer-events:none; }

    /* ===== Modal å…±ç”¨ ===== */
    .modal-overlay{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.6);
      z-index:1000; align-items:center; justify-content:center; padding:10px; overflow:auto;
    }
    .modal-content{
      background:var(--card-bg); color:var(--text-main); border:1px solid var(--border);
      border-radius: var(--radius);
      width:96%; max-width: 900px;
      max-height: min(92svh, 820px);
      padding:0; display:flex; flex-direction:column;
    }
    .modal-content h3{ font-size: clamp(18px, 1.3vw, 20px); margin:0; color:var(--accent); }
    #dateModal .modal-content{ max-width:380px; text-align:center; padding: var(--pad); }

    /* ===== æœå°‹é¢æ¿ï¼ˆsticky header + çµæœè‡ªæ²å‹• + åˆ†é  + å±•é–‹ï¼‰ ===== */
    .search-header{
      position:sticky; top:0; z-index:1; background:var(--card-bg);
      padding: 16px 16px 8px 16px; border-bottom:1px solid var(--border);
    }
    .search-bar{ display:grid; grid-template-columns:1fr auto; gap:10px; margin-top:8px; }
    .search-input{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:var(--input-bg); color:var(--text-main); outline:none;
    }
    .search-btn{
      padding:0 16px; border-radius:10px; border:1px solid var(--border);
      background:var(--accent); color:#fff; cursor:pointer; font-weight:800;
    }
    .search-meta{ color:var(--text-muted); font-size:.92rem; margin-top:6px; }
    .search-results{ flex:1 1 auto; overflow:auto; padding:12px 16px 16px 16px; }

    .result-item{ border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:var(--card-bg); margin-bottom:10px; }
    .result-head{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .badge{ display:inline-flex; align-items:center; padding:2px 8px; border-radius:999px; font-size:.82rem; font-weight:700; border:1px solid var(--border); background:var(--input-bg); color:var(--text-main); }
    .result-title{ font-weight:800; margin:6px 0 2px; }
    .result-snippet, .result-full{ color:var(--text-muted); font-size:.95rem; }
    .result-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
    .go-btn, .toggle-btn{
      background:transparent; color:var(--accent); border:1px dashed var(--accent);
      padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:800;
    }
    .search-empty{ color:var(--text-muted); text-align:center; padding:20px 8px; }
    .load-more{ display:flex; justify-content:center; margin-top:12px; }
    .load-more button{
      padding:8px 14px; border-radius:10px; border:1px solid var(--border);
      background:var(--input-bg); color:var(--text-main); cursor:pointer; font-weight:800;
    }

    /* å‰å¾€å¾Œçš„é«˜äº® */
    .flash{ box-shadow:0 0 0 3px rgba(14,165,233,.45); animation:flashBg 1.4s ease-out 1; }
    @keyframes flashBg{ 0%{ background:rgba(56,189,248,.18); } 100%{ background:transparent; } }

    /* ===== å³ä¸‹å°åœ–ç¤º Dockï¼ˆå°åœ“æŒ‰éˆ•ï¼Œç„¡é•·æ–‡å­—ï¼‰ ===== */
    .mini-dock{
      position:fixed;
      right:calc(16px + env(safe-area-inset-right));
      bottom:calc(16px + env(safe-area-inset-bottom));
      z-index:900;
      display:flex; flex-direction:column; gap:10px;
      align-items:flex-end;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.18));
    }
    .dock-btn{
      width: var(--icon); height: var(--icon); border-radius:50%;
      border:none; cursor:pointer; display:inline-flex; align-items:center; justify-content:center;
      color:#fff; background:#0ea5e9;
    }
    .dock-btn svg{ width: clamp(16px, 2vw, 18px); height: clamp(16px, 2vw, 18px); }
    .dock-search{ background:#0d9488; }  /* ç¶ è— */
    .dock-theme{  background:#64748b; }  /* çŸ³æ¿ç° */
    .dock-edit{   background:#f59e0b; }  /* æ©˜ */
    .dock-save{   background:#0284c7; }  /* æ·±è— */
    .dock-sync{   background:#0ea5e9; }  /* å¤©è— */
    .dock-btn:hover{ filter:brightness(1.06); }

    /* ======= éŸ¿æ‡‰å¼æ–·é» ======= */
    @media (max-width: 1200px){
      .status-row{ grid-template-columns: 1fr minmax(240px, 380px); }
      .board{ gap: clamp(8px, 1vw, 12px); }
    }
    /* å¹³æ¿ï¼šç‹€æ…‹å€æ”¹ç›´æ¬„ï¼›Dock è®Š 2Ã—3 ç¶²æ ¼ */
    @media (max-width: 900px){
      .status-row{ grid-template-columns: 1fr; }
      .mini-dock{
        display: grid;
        grid-auto-flow: column;
        grid-template-rows: repeat(3, var(--icon));
        grid-template-columns: repeat(2, var(--icon));
        gap: 10px;
        right:calc(12px + env(safe-area-inset-right));
        bottom:calc(12px + env(safe-area-inset-bottom));
      }
    }
    /* è¢å¹•é«˜åº¦è¼ƒçŸ®ï¼šDock ä»¥ 2Ã—3 æ’åˆ—ï¼Œé¿å…è¶…å‡ºè¦–çª—é«˜åº¦ */
    @media (max-height: 700px){
      .mini-dock{
        display: grid;
        grid-auto-flow: column;
        grid-template-rows: repeat(3, var(--icon));
        grid-template-columns: repeat(2, var(--icon));
        gap: 10px;
      }
    }
    /* å¾ˆçª„æˆ–å¾ˆçŸ®ï¼šDock åº•éƒ¨ç½®ä¸­æ©«æ’ï¼ˆå¯ 3+2 æ›è¡Œï¼‰ */
    @media (max-width: 540px), (max-height: 560px){
      .mini-dock{
        left: 50%; right: auto; transform: translateX(-50%);
        bottom: calc(10px + env(safe-area-inset-bottom));
        display: grid;
        grid-auto-flow: row;
        grid-template-columns: repeat(5, var(--icon));
        grid-template-rows: var(--icon);
        gap: 10px;
        justify-items: center;
      }
    }
    /* æ‰‹æ©Ÿï¼šæ¬„ä½å–®æ¬„ã€å…§è·æ›´ç·Šæ¹Š */
    @media (max-width: 520px){
      :root{ --gap: 10px; --pad: 12px; --radius: 12px; --col-min: 100%; }
      .header-section{ padding: 14px; margin-bottom: 12px; }
      .column{ flex: 1 1 100%; }
      .column-title{ font-size: 18px; }
    }
  </style>
</head>
<body data-theme="light" data-edit="false">

  <!-- ğŸ” å…¨åŸŸæœå°‹ï¼ˆsticky header + çµæœè‡ªæ² + è¼‰å…¥æ›´å¤š + å±•é–‹å…¨æ–‡ï¼‰ -->
  <div class="modal-overlay" id="searchModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-label="å…¨åŸŸæœå°‹">
      <div class="search-header">
        <h3>ğŸ” å…¨åŸŸæœå°‹ï¼ˆè·¨æ‰€æœ‰æ—¥æœŸçš„ä¸‰æ¬„å¡ç‰‡ï¼‰</h3>
        <div class="search-bar">
          <input id="globalSearchInput" class="search-input" type="search" placeholder="è¼¸å…¥é—œéµå­—ï¼ˆæ¨™é¡Œ / å…§å®¹ / åˆ†é¡ / è² è²¬äºº / æœƒè­°è³‡è¨Š*ï¼‰â€¦  Ctrl/âŒ˜ + K é–‹å•Ÿ" />
          <button class="search-btn" onclick="performGlobalSearch(true)">æœå°‹</button>
        </div>
        <div class="search-meta">æç¤ºï¼šæ¯”å°ä¸‰æ¬„å¡ç‰‡ï¼ˆæ¨™é¡Œã€å…§å®¹ã€åˆ†é¡ã€è² è²¬äººï¼‰ï¼Œä¹Ÿå¯å‹¾é¸ã€Œç´å…¥æœƒè­°è³‡è¨Šã€ï¼ˆä¸»å¸­/ç´€éŒ„/å‡ºå¸­/æ—©ã€ä¸­ç­ï¼‰ã€‚</div>
      </div>

      <div id="searchResults" class="search-results"></div>

      <div style="padding:10px 16px; border-top:1px solid var(--border); text-align:right;">
        <label style="margin-right:12px; color:var(--text-muted); font-size:.92rem;">
          <input type="checkbox" id="includeMeetingMeta" />
          ç´å…¥æœƒè­°è³‡è¨Š
        </label>
        <button class="go-btn" onclick="closeSearchModal()">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- æ—¥æœŸå»ºç«‹ -->
  <div class="modal-overlay" id="dateModal">
    <div class="modal-content">
      <h3 style="padding:16px 16px 0 16px;">ğŸ“… é¸æ“‡æ–°æœƒè­°æ—¥æœŸ</h3>
      <div style="padding:10px 16px 0 16px;">
        <input type="date" id="newMeetingDate" style="padding:8px; width:100%; max-width:260px;">
      </div>
      <div style="padding:12px 16px 16px 16px; text-align:center;">
        <button onclick="confirmNewMeeting()" style="background:var(--accent); color:#fff; border:none; padding:10px 20px; border-radius:50px; margin-top:8px; cursor:pointer;">å»ºç«‹å ±å‘Š</button>
        <p style="cursor:pointer; font-size:.9rem; color:var(--text-muted);" onclick="closeModal()">å–æ¶ˆ</p>
      </div>
    </div>
  </div>

  <!-- å´é‚Šæ¬„ï¼šæ—¥æœŸ -->
  <div class="sidebar" id="dateSidebar">
    <div class="side-icon side-add" id="btnSideAdd" onclick="openModal()">+</div>
  </div>

  <!-- ä¸»å…§å®¹ -->
  <div class="main">
    <div class="header-section">
      <div id="syncStatus" style="font-size:.9rem; color:var(--accent); margin-bottom:10px;">â˜ï¸ æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</div>

      <div class="info-row">
        <div class="input-group">
          <label>ğŸ“… å ±å‘Šæ—¥æœŸ</label>
          <input type="date" id="mDateDisplay" class="global-lock" onfocus="onDateFocus()" onchange="handleDateChange()" style="font-weight:bold; color:var(--accent);" />
        </div>
        <div class="input-group"><label>ğŸ‘¤ ä¸»å¸­</label><select id="mChair" class="global-lock"></select></div>
        <div class="input-group"><label>ğŸ“ ç´€éŒ„</label><select id="mRecorder" class="global-lock"></select></div>
      </div>

      <div class="status-row">
        <div class="attendance-section">
          <div class="input-group">
            <label>ğŸ‘¥ å‡ºå¸­äººå“¡ (éœ€è§£é–å¾Œæ–°å¢)</label>
            <select id="mAttendeeSelect" class="global-lock" onchange="addAttendee(this.value); this.value='';">
              <option value="">-- è«‹æŒ‘é¸äººå“¡ --</option>
              <option value="è˜‡æ¸…æº">è˜‡æ¸…æº</option><option value="æ›¾é›ªå¦®">æ›¾é›ªå¦®</option>
              <option value="é»ƒå©·éˆº">é»ƒå©·éˆº</option><option value="è”¡ç­‘ç">è”¡ç­‘ç</option>
              <option value="è•­ç¿Šç¿">è•­ç¿Šç¿</option><option value="é™³ç«è«­">é™³ç«è«­</option>
              <option value="æå®¶æ§¿">æå®¶æ§¿</option><option value="ä¿Šç”Ÿéƒ¨é•·">ä¿Šç”Ÿéƒ¨é•·</option>
            </select>
          </div>
          <div id="attendeeList" class="attendee-list"></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
          <div class="input-group" style="border-left:4px solid var(--accent); padding-left:12px;"><label>â˜€ï¸ æ—©ç­å ±å‘Š</label><select id="mRepMorning" class="global-lock"></select></div>
          <div class="input-group" style="border-left:4px solid #15803d; padding-left:12px;"><label>â›… ä¸­ç­å ±å‘Š</label><select id="mRepAfternoon" class="global-lock"></select></div>
        </div>
      </div>
    </div>

    <div class="board">
      <div class="column">
        <div class="column-title">ğŸ“ å¹¹éƒ¨æœƒè­°ç´€éŒ„å…§å®¹</div>
        <div id="col_record"></div>
        <button class="add-btn global-lock" onclick="addNewCard('col_record')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer; color:var(--text-muted);">+ æ–°å¢æ±ºè­°</button>
      </div>
      <div class="column">
        <div class="column-title" style="color:#15803d">ğŸ“ è¿½è¹¤äº‹é …ç›¤é»</div>
        <div id="col_tracking"></div>
        <button class="add-btn global-lock" onclick="addNewCard('col_tracking')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer; color:var(--text-muted);">+ æ–°å¢è¿½è¹¤</button>
      </div>
      <div class="column">
        <div class="column-title" style="color:#b45309">ğŸ“ 2026å¹´åº¦ç›®æ¨™é€²åº¦</div>
        <div id="col_target"></div>
        <button class="add-btn global-lock" onclick="addNewCard('col_target')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer; color:var(--text-muted);">+ æ–°å¢é€²åº¦</button>
      </div>
    </div>
  </div>

  <!-- å³ä¸‹ã€Œå°åœ–ç¤º Dockã€ -->
  <div class="mini-dock" id="miniDock" aria-label="å¿«é€Ÿå‹•ä½œ">
    <button class="dock-btn dock-search" title="å…¨åŸŸæœå°‹ï¼ˆCtrl/âŒ˜ + Kï¼‰" aria-label="æœå°‹" onclick="openSearchModal()">
      <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="11" cy="11" r="7" stroke="white" stroke-width="2" fill="none"/><line x1="16.5" y1="16.5" x2="21" y2="21" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
    <button class="dock-btn dock-theme" title="åˆ‡æ›é»‘/ç™½ä¸»é¡Œ" aria-label="ä¸»é¡Œ" onclick="toggleTheme()">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" fill="white"/></svg>
    </button>
    <button class="dock-btn dock-edit" title="é–‹å•Ÿ/é€€å‡ºç·¨è¼¯" aria-label="ç·¨è¼¯" onclick="toggleEditMode()">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 11V7a6 6 0 1112 0v4" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/><rect x="5" y="11" width="14" height="10" rx="2" stroke="white" stroke-width="2" fill="none"/></svg>
    </button>
    <button class="dock-btn dock-save" title="å„²å­˜åˆ°æœ¬æ©Ÿ" aria-label="å„²å­˜" onclick="saveCurrentData()">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 7a2 2 0 012-2h9l5 5v9a2 2 0 01-2 2H6a2 2 0 01-2-2V7z" stroke="white" stroke-width="2" fill="none"/><path d="M13 5v6H7V5" stroke="white" stroke-width="2" fill="none"/></svg>
    </button>
    <button class="dock-btn dock-sync" id="btnCloudSync" title="å„²å­˜ä¸¦åŒæ­¥é›²ç«¯" aria-label="åŒæ­¥" onclick="saveAndSyncToCloud()">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 18a4 4 0 010-8 6 6 0 1111.31 2.64A3.5 3.5 0 1117.5 18H7z" fill="white"/></svg>
    </button>
  </div>

  <script>
    // ====== é›²ç«¯ API ======
    const CLOUD_API_URL = "https://script.google.com/macros/s/AKfycbxtfU8YUXCQyea1qh8khk1XbUN-zd1XzoGsNJcjruVThrSt3r7uW1XtzAexOK5rQ6sfiA/exec";

    const ownerList = ["å…¨éƒ¨","è˜‡æ¸…æº","æ›¾é›ªå¦®","é»ƒå©·éˆº","è”¡ç­‘ç","è•­ç¿Šç¿","é™³ç«è«­","æå®¶æ§¿"];
    const categoryList = ["å®¢æœ","VIP","å…¨éƒ¨"];
    const cadres = ["è˜‡æ¸…æº","æ›¾é›ªå¦®","é»ƒå©·éˆº","è”¡ç­‘ç","è•­ç¿Šç¿","é™³ç«è«­","æå®¶æ§¿","ä¿Šç”Ÿéƒ¨é•·"];

    let meetings = JSON.parse(localStorage.getItem('MeetingV27_Data')) || {
      "2026-01-14":{
        attendees:[], chair:"è•­ç¿Šç¿", recorder:"é™³ç«è«­", morning:"è˜‡æ¸…æº", afternoon:"æ›¾é›ªå¦®",
        cards:{ col_record:[], col_tracking:[], col_target:[] },
        meta:{ recordSeeded:true, trackingSeeded:true }
      }
    };
    let currentDay = Object.keys(meetings).sort().reverse()[0] || "2026-01-14";
    let hasUnsaved = false;
    let _movedRecordToTracking = false;

    /* ===== å³ä¸‹ Dock é¿è®“ï¼šä¾ Dock é«˜åº¦å‹•æ…‹è¨­å®šä¸»å…§å®¹åº•éƒ¨ padding ===== */
    function recomputeDockPadding(){
      const dock = document.getElementById('miniDock');
      const main = document.querySelector('.main');
      if(!dock || !main) return;
      const r = dock.getBoundingClientRect();
      const base = 24;
      const pad = Math.ceil((r.height || 200) * 0.62) + 18; // é©åº¦ä¼°ç®—é¿è®“
      const safe = (window.visualViewport && window.visualViewport.height !== window.innerHeight) ? 16 : 0;
      main.style.setProperty('--main-bottom-pad', Math.max(base, pad + safe) + 'px');
    }

    function init(){
      // ä¸‹æ‹‰é¸å–®åˆå§‹åŒ–
      ['mChair','mRecorder','mRepMorning','mRepAfternoon'].forEach(id=>{
        const el = document.getElementById(id);
        el.add(new Option('', ''));
        cadres.forEach(name=>{ if(name!=='ä¿Šç”Ÿéƒ¨é•·') el.add(new Option(name, name)); });
      });

      // æ–°å¢æ—¥æœŸ modal æ—¥æœŸ
      const d = document.getElementById('newMeetingDate');
      if(d){
        const t = new Date(); const yyyy=t.getFullYear(); const mm=String(t.getMonth()+1).padStart(2,'0'); const dd=String(t.getDate()).padStart(2,'0');
        d.value = `${yyyy}-${mm}-${dd}`; d.min = "2024-01-01";
      }

      // å…ˆæŠ“é›²ç«¯ï¼ˆå¤±æ•—ç”¨æœ¬åœ°ï¼‰
      fetchCloudData().then(()=>{
        currentDay = Object.keys(meetings).sort().reverse()[0] || currentDay;
        refreshSidebar(); loadMeeting(currentDay);
        updateLocks(); bindDirtyWatcher();
        requestAnimationFrame(recomputeDockPadding);
      });

      // å°ºå¯¸/æ–¹å‘è®ŠåŒ– â†’ é¿è®“é‡ç®—
      window.addEventListener('resize', ()=>requestAnimationFrame(recomputeDockPadding));
      window.addEventListener('orientationchange', ()=>setTimeout(recomputeDockPadding, 120));
      // Dock è‡ªèº«å°ºå¯¸è®ŠåŒ–ä¹Ÿé‡ç®—
      if('ResizeObserver' in window){
        const ro = new ResizeObserver(()=>requestAnimationFrame(recomputeDockPadding));
        ro.observe(document.getElementById('miniDock'));
      }

      // å¿«æ·éµï¼šCtrl/âŒ˜+K é–‹æœå°‹ï¼›æœå°‹é–‹å•Ÿæ™‚ Enter ç›´æ¥æœå°‹
      document.addEventListener('keydown', (e)=>{
        const isMac = navigator.platform.toUpperCase().includes('MAC');
        if((isMac && e.metaKey && e.key.toLowerCase()==='k') || (!isMac && e.ctrlKey && e.key.toLowerCase()==='k')){
          e.preventDefault(); openSearchModal();
        }
        const modalOpen = document.getElementById('searchModal').style.display === 'flex';
        if(modalOpen && e.key === 'Enter'){ e.preventDefault(); performGlobalSearch(true); }
      });

      // é» overlay å¤–éƒ¨é—œé–‰æœå°‹çª—
      document.addEventListener('click', (ev)=>{
        const sm = document.getElementById('searchModal');
        if(sm && sm.style.display==='flex'){
          const content = sm.querySelector('.modal-content');
          if(content && !content.contains(ev.target) && !ev.target.closest('.dock-btn')){
            closeSearchModal();
          }
        }
      });

      // é›¢é–‹è­¦ç¤º
      window.addEventListener('beforeunload', (e)=>{ if(hasUnsaved){ e.preventDefault(); e.returnValue=''; } });
    }

    /* ===== é›²ç«¯å­˜å– ===== */
    async function fetchCloudData(){
      const status = document.getElementById('syncStatus');
      const controller = new AbortController(); const timer = setTimeout(()=>controller.abort(), 15000);
      try{
        const res = await fetch(CLOUD_API_URL, { signal:controller.signal, mode:'cors', credentials:'omit' });
        clearTimeout(timer);
        if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
        const data = await res.json();
        if(data && Object.keys(data).length>0){
          meetings = data;
          status.innerText = "â˜ï¸ é›²ç«¯åŒæ­¥å®Œæˆ";
          try{ localStorage.setItem('MeetingV27_Data', JSON.stringify(meetings)); }catch{}
          return;
        }
        throw new Error('ç©ºè³‡æ–™');
      }catch(e){
        clearTimeout(timer);
        console.warn('é›²ç«¯æŠ“å–å¤±æ•—ï¼Œæ”¹è¼‰å…¥æœ¬åœ°å‚™ä»½ï¼š', e);
        const backup = localStorage.getItem('MeetingV27_Data');
        if(backup){ meetings = JSON.parse(backup); status.innerText = "ğŸ’¾ å·²è¼‰å…¥æœ¬åœ°å‚™ä»½ (é›²ç«¯æœªé€£ç·š)"; }
        else{ status.innerText = "âš ï¸ ä½¿ç”¨æœ¬åœ°æš«å­˜ (å°šæœªåŒæ­¥)"; }
      }
    }

    async function saveAndSyncToCloud(){
      saveCurrentToVariable();
      const btn = document.getElementById('btnCloudSync');
      if(btn){ btn.disabled=true; btn.innerHTML='â³'; }
      try{ await syncToCloud(); }
      finally{
        if(btn){
          btn.disabled=false;
          btn.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 18a4 4 0 010-8 6 6 0 1111.31 2.64A3.5 3.5 0 1117.5 18H7z" fill="white"/></svg>';
        }
      }
    }
    async function syncToCloud(){
      const payload = JSON.parse(JSON.stringify(meetings));
      if(_movedRecordToTracking && payload[currentDay]?.cards){
        payload[currentDay].cards.col_record = [];
        payload[currentDay].meta = payload[currentDay].meta || {};
        payload[currentDay].meta.recordSeeded = true;
      }

      const status = document.getElementById('syncStatus');
      status.innerText = "â³ æ­£åœ¨åŒæ­¥è‡³é›²ç«¯...";
      const controller = new AbortController(); const timer = setTimeout(()=>controller.abort(), 15000);

      try{
        const res = await fetch(CLOUD_API_URL, {
          method:'POST', body:JSON.stringify(payload), signal:controller.signal, mode:'cors', credentials:'omit'
        });
        clearTimeout(timer);
        if(!res.ok){ const txt = await res.text().catch(()=> ''); throw new Error(`HTTP ${res.status} ${res.statusText} ${txt}`); }
        const text = await res.text();
        alert("âœ… " + text);
        status.innerText = "â˜ï¸ é›²ç«¯åŒæ­¥å®Œæˆ";

        if(_movedRecordToTracking && meetings[currentDay]?.cards){
          meetings[currentDay].cards.col_record = [];
          meetings[currentDay].meta = meetings[currentDay].meta || {};
          meetings[currentDay].meta.recordSeeded = true;
          _movedRecordToTracking = false;
          loadMeeting(currentDay);
        }

        try{ localStorage.setItem('MeetingV27_Data', JSON.stringify(meetings)); }catch{}
        if(document.body.getAttribute('data-edit')==='true') toggleEditMode();
      }catch(e){
        clearTimeout(timer);
        console.error(e);
        let msg = "âŒ åŒæ­¥å¤±æ•—ã€‚";
        if(e.name==='AbortError') msg += "ï¼ˆé€¾æ™‚æœªå›æ‡‰ï¼‰";
        else if(String(e).includes('TypeError') || String(e.message).includes('Failed to fetch')) msg += "ï¼ˆCORS/æ¬Šé™æˆ–ç¶²è·¯è¢«é˜»æ“‹ï¼‰";
        alert(msg + " è©³ç´°ï¼š" + (e.message || e));
        status.innerText = "âš ï¸ ä½¿ç”¨æœ¬åœ°æš«å­˜ (å°šæœªåŒæ­¥)";
      }
    }

    /* ===== ç·¨è¼¯é– ===== */
    function toggleEditMode(){
      const isEdit = document.body.getAttribute('data-edit')==='true';
      document.body.setAttribute('data-edit', !isEdit);
      updateLocks();
    }
    function updateLocks(){
      const isEdit = document.body.getAttribute('data-edit')==='true';
      document.querySelectorAll('.global-lock').forEach(el=>{
        el.disabled = !isEdit;
        if(el.tagName==='BUTTON') el.classList.toggle('add-btn-locked', !isEdit);
      });
      const addBtn = document.getElementById('btnSideAdd');
      addBtn.classList.toggle('add-btn-locked', !isEdit);
      addBtn.onclick = isEdit ? openModal : null;

      document.querySelectorAll('.card').forEach(card=>{
        card.querySelectorAll('textarea, select, input[type="checkbox"]').forEach(el=>el.disabled=!isEdit);
        const delBtn = card.querySelector('.del-x'); if(delBtn) delBtn.style.display = isEdit ? 'block':'none';
      });
      document.querySelectorAll('.attendee-list .del-x').forEach(x=>x.style.display = isEdit ? 'inline-block':'none');
    }

    /* ===== Modal & ä¸»é¡Œ ===== */
    function openModal(){ document.getElementById('dateModal').style.display='flex'; }
    function closeModal(){ document.getElementById('dateModal').style.display='none'; }
    function openSearchModal(){
      if(document.body.getAttribute('data-edit')==='true' && hasUnsaved){
        try{ saveCurrentToVariable(); }catch{}
      }
      const m = document.getElementById('searchModal');
      m.style.display = 'flex';
      setTimeout(()=>{ const inp = document.getElementById('globalSearchInput'); if(inp) inp.focus(); }, 30);
    }
    function closeSearchModal(){ document.getElementById('searchModal').style.display='none'; }
    function toggleTheme(){
      const cur = document.body.getAttribute('data-theme');
      document.body.setAttribute('data-theme', cur==='dark' ? 'light' : 'dark');
    }

    /* ===== ç¹¼æ‰¿æ©Ÿåˆ¶ ===== */
    function findPreviousDate(currentIso){
      const dates = Object.keys(meetings).filter(d=>d<currentIso).sort().reverse();
      return dates[0] || null;
    }
    function maybeSeedTracking(targetDate){
      const m = meetings[targetDate]; if(!m) return;
      m.meta = m.meta || {};
      if(m.meta.trackingSeeded===true) return;
      const prevDate = findPreviousDate(targetDate); if(!prevDate){ m.meta.trackingSeeded=true; return; }
      const prev = meetings[prevDate]; const prevTracking = prev?.cards?.col_tracking || [];
      const inherit = prevTracking
        .filter(it => (it.keep===undefined ? true : !!it.keep))
        .map(it => ({ ...it, keep:(it.keep===undefined ? true : !!it.keep) }));
      m.cards = m.cards || {};
      if(!m.cards.col_tracking || m.cards.col_tracking.length===0){
        m.cards.col_tracking = JSON.parse(JSON.stringify(inherit));
      }
      m.meta.trackingSeeded = true;
    }
    function maybeSeedRecord(targetDate){
      const m = meetings[targetDate]; if(!m) return;
      m.meta = m.meta || {};
      if(m.meta.recordSeeded===true) return;
      const prevDate = findPreviousDate(targetDate); if(!prevDate){ m.meta.recordSeeded=true; return; }
      const prev = meetings[prevDate]; const prevRecords = prev?.cards?.col_record || [];
      m.cards = m.cards || {};
      if(!m.cards.col_record || m.cards.col_record.length===0){
        m.cards.col_record = JSON.parse(JSON.stringify(prevRecords));
      }
      m.meta.recordSeeded = true;
    }

    /* ===== å»ºç«‹/åˆ‡æ›æ—¥æœŸ ===== */
    function confirmNewMeeting(){
      const date = document.getElementById('newMeetingDate').value; if(!date) return;
      if(document.body.getAttribute('data-edit')==='true' && hasUnsaved) saveCurrentToVariable();

      if(!meetings[date]){
        const prev = meetings[currentDay] || {
          attendees:[], chair:'', recorder:'', morning:'', afternoon:'',
          cards:{ col_record:[], col_tracking:[], col_target:[] }, meta:{}
        };
        meetings[date] = {
          attendees:[],
          chair: prev.chair || '',
          recorder: prev.recorder || '',
          morning: prev.morning || '',
          afternoon: prev.afternoon || '',
          cards:{
            col_record:[],
            col_tracking:[],
            col_target: JSON.parse(JSON.stringify(prev.cards?.col_target || []))
          },
          meta:{ recordSeeded:false, trackingSeeded:false }
        };
      }

      currentDay = date;
      maybeSeedRecord(date);
      maybeSeedTracking(date);

      closeModal(); refreshSidebar(); loadMeeting(date);
      requestAnimationFrame(recomputeDockPadding);
    }

    function refreshSidebar(){
      const bar = document.getElementById('dateSidebar');
      Array.from(bar.querySelectorAll('.side-icon:not(.side-add)')).forEach(el=>el.remove());
      Object.keys(meetings).sort().reverse().forEach(date=>{
        const btn = document.createElement('div');
        btn.className = `side-icon ${date===currentDay ? 'active':''}`;
        btn.innerHTML = date.substring(5).replace('-', '/');
        btn.onclick = ()=>loadMeeting(date);
        bar.insertBefore(btn, bar.lastElementChild);
      });
    }

    function ensureOption(selectEl, value){
      const found = Array.from(selectEl.options).some(o=>o.value === (value ?? ""));
      if(!found) selectEl.add(new Option(value ?? "", value ?? ""));
    }

    const _origLoadMeeting = function(date){
      currentDay = date;
      if(!meetings[date]){
        meetings[date] = {
          attendees:[], chair:'', recorder:'', morning:'', afternoon:'',
          cards:{ col_record:[], col_tracking:[], col_target:[] },
          meta:{ recordSeeded:false, trackingSeeded:false }
        };
      }

      maybeSeedRecord(date);
      maybeSeedTracking(date);

      const data = meetings[date];
      document.getElementById('mDateDisplay').value = date;

      const mChair = document.getElementById('mChair');
      const mRecorder = document.getElementById('mRecorder');
      const mRepMorning = document.getElementById('mRepMorning');
      const mRepAfternoon = document.getElementById('mRepAfternoon');

      ensureOption(mChair, data.chair ?? ""); mChair.value = data.chair ?? "";
      ensureOption(mRecorder, data.recorder ?? "");  mRecorder.value = data.recorder ?? "";
      ensureOption(mRepMorning, data.morning ?? ""); mRepMorning.value = data.morning ?? "";
      ensureOption(mRepAfternoon, data.afternoon ?? ""); mRepAfternoon.value = data.afternoon ?? "";

      const list = document.getElementById('attendeeList');
      list.innerHTML = ""; (data.attendees || []).forEach(n=>addAttendee(n));

      ['col_record','col_tracking','col_target'].forEach(id=>{
        const cont = document.getElementById(id); cont.innerHTML = "";
        if(data.cards && data.cards[id]) data.cards[id].forEach(c=>addNewCard(id, c));
      });

      refreshSidebar(); updateLocks(); hasUnsaved = false;
    };

    function loadMeeting(date){
      if(document.body.getAttribute('data-edit')==='true' && hasUnsaved) saveCurrentToVariable();
      _origLoadMeeting(date); bindDirtyWatcher();
      requestAnimationFrame(recomputeDockPadding);
    }

    /* ===== å ±å‘Šæ—¥æœŸè®Šæ›´ ===== */
    let _dateBeforeEdit = null;
    function onDateFocus(){ _dateBeforeEdit = currentDay; }
    function handleDateChange(){
      const input = document.getElementById('mDateDisplay');
      const newDate = (input.value || '').trim(); const oldDate = _dateBeforeEdit || currentDay;
      if(!newDate || newDate===oldDate){ input.value = oldDate; return; }
      if(!/^\d{4}-\d{2}-\d{2}$/.test(newDate)){ alert('â— è«‹è¼¸å…¥æ­£ç¢ºçš„æ—¥æœŸæ ¼å¼ï¼ˆYYYY-MM-DDï¼‰'); input.value = oldDate; return; }
      if(document.body.getAttribute('data-edit')!=='true'){ alert('è«‹å…ˆé–‹å•Ÿç·¨è¼¯æ¨¡å¼å†ä¿®æ”¹æ—¥æœŸã€‚'); input.value = oldDate; return; }

      saveCurrentToVariable();
      if(meetings[newDate]){
        const ok = confirm(`æ—¥æœŸ ${newDate} å·²å­˜åœ¨ã€‚\nè¦è¦†å¯«è©²æ—¥æœŸè³‡æ–™å—ï¼Ÿ\nï¼ˆè¦†å¯«å¾Œï¼Œä»¥ç›®å‰ç•«é¢å…§å®¹ç‚ºä¸»ï¼‰`);
        if(!ok){ input.value = oldDate; return; }
      }

      const snapshot = meetings[oldDate];
      meetings[newDate] = snapshot; if(newDate!==oldDate) delete meetings[oldDate];

      currentDay = newDate; hasUnsaved = true;
      refreshSidebar(); loadMeeting(newDate);
      try{ localStorage.setItem('MeetingV27_Data', JSON.stringify(meetings)); }catch{}
    }

    /* ===== å‡ºå¸­åå–® ===== */
    function addAttendee(name){
      if(!name) return;
      const list = document.getElementById('attendeeList');
      const exists = Array.from(list.querySelectorAll('.tag')).some(t=>t.dataset.name===name);
      if(exists) return;
      const tag = document.createElement('div'); tag.className='tag'; tag.dataset.name=name;
      const text = document.createElement('span'); text.textContent = name;
      const del = document.createElement('span'); del.className='del-x'; del.textContent='âœ•';
      del.onclick=()=>{ tag.remove(); markDirty(); };
      tag.appendChild(text); tag.appendChild(del); list.appendChild(tag);
      updateLocks(); markDirty();
    }
    function getAttendees(){ return Array.from(document.querySelectorAll('.attendee-list .tag')).map(t=>t.dataset.name); }

    /* ===== å¡ç‰‡å±•é–‹/æ”¶åˆ ===== */
    function toggleExpand(btn){
      const desc = btn.parentElement.querySelector('.c-desc'); if(!desc) return;
      if(desc.classList.contains('expanded')){ desc.classList.remove('expanded'); desc.style.height='56px'; btn.innerHTML='â–¼ å±•é–‹'; }
      else{ desc.classList.add('expanded'); desc.style.height = desc.scrollHeight + 'px'; btn.innerHTML='â–² æ”¶åˆ'; }
    }

    /* ===== å¹¹éƒ¨æœƒè­°ç´€éŒ„ â†’ è¿½è¹¤ ===== */
    function moveToTracking(btn){
      const card = btn.closest('.card'); if(!card) return;
      const data = {
        title: card.querySelector('.c-title')?.value || '',
        desc:  card.querySelector('.c-desc')?.value || '',
        cat:   card.querySelector('.m-cat')?.value || 'å…¨éƒ¨',
        owner: card.querySelector('.m-own')?.value || 'å…¨éƒ¨',
        keep:  true
      };
      card.remove(); addNewCard('col_tracking', data);
      _movedRecordToTracking = true; markDirty(); updateLocks();
    }

    function addNewCard(colId, data=null){
      const col = document.getElementById(colId);
      const card = document.createElement('div'); card.className='card';
      const d = data || { title:'äº‹é …åç¨±', desc:'å…§å®¹è©³æƒ…...', cat:'å…¨éƒ¨', owner:'å…¨éƒ¨', keep:(colId==='col_tracking' ? true : undefined) };
      const keepBlock = (colId==='col_tracking')
        ? `<div class="meta-item"><label class="meta-label" style="display:flex; align-items:center; gap:6px;">
             <input type="checkbox" class="m-keep global-lock" ${(d.keep===undefined || d.keep) ? 'checked':''} />ä¿ç•™åˆ°ä¸‹æ¬¡
           </label></div>` : '';
      const moveBlock = (colId==='col_record')
        ? `<div class="meta-item" style="justify-content:flex-end;">
             <button class="global-lock" style="padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--input-bg); cursor:pointer;" onclick="moveToTracking(this)">â¡ ç§»åˆ°è¿½è¹¤</button>
           </div>` : '';
      card.innerHTML = `
        <div class="del-x" style="position:absolute; top:10px; right:15px; cursor:pointer;" onclick="this.parentElement.remove(); markDirty();">ç§»é™¤âœ•</div>
        <textarea class="c-title" rows="1">${d.title ?? ''}</textarea>
        <textarea class="c-desc">${d.desc ?? ''}</textarea>
        <div class="expand-btn" onclick="toggleExpand(this)">â–¼ å±•é–‹</div>
        <div class="card-meta">
          <div class="meta-item"><span class="meta-label">é …ç›®åˆ†é¡:</span>
            <select class="m-cat meta-select">${categoryList.map(c=>`<option value="${c}" ${d.cat===c?'selected':''}>${c}</option>`).join('')}</select>
          </div>
          <div class="meta-item"><span class="meta-label">è² è²¬äººå“¡:</span>
            <select class="m-own meta-select">${ownerList.map(n=>`<option value="${n}" ${d.owner===n?'selected':''}>${n}</option>`).join('')}</select>
          </div>
          ${keepBlock}${moveBlock}
        </div>`;
      col.appendChild(card); updateLocks();
      card.querySelectorAll('textarea, select, input[type="checkbox"]').forEach(el=>{
        el.addEventListener('input', markDirty); el.addEventListener('change', markDirty);
      });
    }

    /* ===== å„²å­˜ï¼ˆæœ¬æ©Ÿ/è®Šæ•¸ï¼‰ ===== */
    function getCardData(id){
      return Array.from(document.getElementById(id).querySelectorAll('.card')).map(c=>{
        const base = {
          title: c.querySelector('.c-title')?.value || '',
          desc:  c.querySelector('.c-desc')?.value || '',
          cat:   c.querySelector('.m-cat')?.value || 'å…¨éƒ¨',
          owner: c.querySelector('.m-own')?.value || 'å…¨éƒ¨'
        };
        if(id==='col_tracking') base.keep = !!(c.querySelector('.m-keep')?.checked);
        return base;
      });
    }
    function saveCurrentToVariable(){
      const rec = getCardData('col_record');
      const trk = getCardData('col_tracking');
      const tgt = getCardData('col_target');

      meetings[currentDay] = meetings[currentDay] || {};
      meetings[currentDay].cards = meetings[currentDay].cards || {};
      meetings[currentDay].meta  = meetings[currentDay].meta  || {};

      meetings[currentDay].chair     = document.getElementById('mChair').value;
      meetings[currentDay].recorder  = document.getElementById('mRecorder').value;
      meetings[currentDay].morning   = document.getElementById('mRepMorning').value;
      meetings[currentDay].afternoon = document.getElementById('mRepAfternoon').value;
      meetings[currentDay].attendees = getAttendees();
      meetings[currentDay].cards.col_record   = rec;
      meetings[currentDay].cards.col_tracking = trk;
      meetings[currentDay].cards.col_target   = tgt;

      if(rec.length===0) meetings[currentDay].meta.recordSeeded = true;
      if(trk.length===0) meetings[currentDay].meta.trackingSeeded = true;

      try{ localStorage.setItem('MeetingV27_Data', JSON.stringify(meetings)); }catch{}
      hasUnsaved = false;
    }
    function saveCurrentData(){
      saveCurrentToVariable();
      alert('âœ… å·²å„²å­˜åˆ°æœ¬æ©Ÿä¸¦é–å®šï¼');
      if(document.body.getAttribute('data-edit')==='true') toggleEditMode();
    }

    /* ===== è®Šæ›´è¿½è¹¤ ===== */
    function markDirty(){ hasUnsaved = true; }
    function bindDirtyWatcher(){
      document.querySelectorAll('textarea, select, input').forEach(el=>{
        if(!el.dataset._bindDirty){
          el.addEventListener('input', markDirty); el.addEventListener('change', markDirty);
          el.dataset._bindDirty = '1';
        }
      });
    }

    /* ===== ğŸ” å…¨åŸŸæœå°‹ï¼ˆåˆ†é  + å±•é–‹ + å¯ç´å…¥æœƒè­°è³‡è¨Šï¼‰ ===== */
    const COL_LABELS = {
      col_record:'å¹¹éƒ¨æœƒè­°ç´€éŒ„å…§å®¹',
      col_tracking:'è¿½è¹¤äº‹é …ç›¤é»',
      col_target:'2026å¹´åº¦ç›®æ¨™é€²åº¦'
    };
    const SEARCH_PAGE_SIZE = 40;
    let _searchCache = { q:'', includeMeta:false, results:[], shown:0 };

    function escapeHTML(s){ return (s ?? '').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function highlight(text, q){
      if(!q) return escapeHTML(text);
      const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'ig');
      return escapeHTML(text).replace(re, m=>`<mark>${escapeHTML(m)}</mark>`);
    }
    function makeSnippet(full, q, span=50){
      const str = full || '';
      if(!q) return escapeHTML(str.slice(0, span*2));
      const idx = str.toLowerCase().indexOf(q.toLowerCase());
      if(idx<0) return escapeHTML(str.slice(0, span*2));
      const start = Math.max(0, idx - span);
      const end = Math.min(str.length, idx + q.length + span);
      return (start>0?'â€¦':'') + highlight(str.slice(start,end), q) + (end<str.length?'â€¦':'');
    }

    function buildCardResults(q){
      const dates = Object.keys(meetings).sort().reverse();
      const list = [];
      dates.forEach(date=>{
        const cards = meetings[date]?.cards || {};
        ['col_record','col_tracking','col_target'].forEach(colId=>{
          const arr = cards[colId] || [];
          arr.forEach((c, idx)=>{
            const hay = [c.title||'', c.desc||'', c.cat||'', c.owner||''].join(' ');
            if(q && hay.toLowerCase().indexOf(q.toLowerCase()) === -1) return;
            const full = (c.title||'') + '\n' + (c.desc||'');
            list.push({
              type:'card', date, colId, index:idx,
              title: c.title || '(æœªå‘½å)',
              cat: c.cat || 'å…¨éƒ¨',
              owner: c.owner || 'å…¨éƒ¨',
              fullText: full,
              snippet: makeSnippet(full, q)
            });
          });
        });
      });
      return list;
    }
    function buildMeetingMetaResults(q){
      const dates = Object.keys(meetings).sort().reverse();
      const list = [];
      dates.forEach(date=>{
        const m = meetings[date] || {};
        const f = [
          `ä¸»å¸­: ${m.chair||''}`,
          `ç´€éŒ„: ${m.recorder||''}`,
          `æ—©ç­: ${m.morning||''}`,
          `ä¸­ç­: ${m.afternoon||''}`,
          `å‡ºå¸­: ${(m.attendees||[]).join('ã€')}`
        ].join('  ');
        if(q && f.toLowerCase().indexOf(q.toLowerCase()) === -1) return;
        list.push({
          type:'meta', date, colId:'', index:-1,
          title:'æœƒè­°è³‡è¨Š', cat:'è³‡è¨Š', owner:'',
          fullText:f, snippet: makeSnippet(f, q)
        });
      });
      return list;
    }

    function renderSearchBatch(append=false){
      const resBox = document.getElementById('searchResults');
      if(!append) resBox.innerHTML = '';

      const { q, results } = _searchCache;
      const start = _searchCache.shown;
      const end = Math.min(results.length, start + SEARCH_PAGE_SIZE);

      for(let i=start; i<end; i++){
        const r = results[i];
        const item = document.createElement('div');
        item.className = 'result-item';
        const headerBadges = (r.type==='card')
          ? `
            <span class="badge">ğŸ“… ${escapeHTML(r.date)}</span>
            <span class="badge">ğŸ“ ${escapeHTML(COL_LABELS[r.colId] || r.colId)}</span>
            <span class="badge">ğŸ‘¤ ${escapeHTML(r.owner)}</span>
            <span class="badge">ğŸ·ï¸ ${escapeHTML(r.cat)}</span>
          `
          : `<span class="badge">ğŸ“… ${escapeHTML(r.date)}</span><span class="badge">â„¹ï¸ æœƒè­°è³‡è¨Š</span>`;

        item.innerHTML = `
          <div class="result-head">${headerBadges}</div>
          <div class="result-title">${highlight(r.title, q)}</div>
          <div class="result-snippet">${r.snippet}</div>
          <div class="result-full" style="display:none; white-space:pre-wrap;">${escapeHTML(r.fullText)}</div>
          <div class="result-actions">
            ${r.type==='card'
              ? `<button class="go-btn" onclick="goToSearchResult('${r.date}','${r.colId}',${r.index})">å‰å¾€</button>`
              : `<button class="go-btn" onclick="goToDate('${r.date}')">å‰å¾€æ—¥æœŸ</button>`
            }
            <button class="toggle-btn" onclick="toggleResultFull(this)">é¡¯ç¤ºæ›´å¤š</button>
          </div>
        `;
        resBox.appendChild(item);
      }

      _searchCache.shown = end;

      // è¼‰å…¥æ›´å¤š
      const hasMore = end < results.length;
      const oldMore = resBox.querySelector('.load-more');
      if(oldMore) oldMore.remove();
      if(hasMore){
        const box = document.createElement('div');
        box.className = 'load-more';
        box.innerHTML = `<button onclick="renderSearchBatch(true)">è¼‰å…¥æ›´å¤šï¼ˆ${results.length - end}ï¼‰</button>`;
        resBox.appendChild(box);
      }
    }

    function toggleResultFull(btn){
      const item = btn.closest('.result-item');
      const s = item.querySelector('.result-snippet');
      const f = item.querySelector('.result-full');
      const expanded = f.style.display !== 'none';
      if(expanded){ f.style.display='none'; s.style.display=''; btn.textContent='é¡¯ç¤ºæ›´å¤š'; }
      else{ f.style.display=''; s.style.display='none'; btn.textContent='æ”¶åˆ'; }
    }

    function performGlobalSearch(reset=false){
      const q = (document.getElementById('globalSearchInput').value || '').trim();
      const includeMeta = !!document.getElementById('includeMeetingMeta')?.checked;
      const resBox = document.getElementById('searchResults');

      if(!q && !includeMeta){
        resBox.innerHTML = `<div class="search-empty">è«‹è¼¸å…¥é—œéµå­—ï¼ˆæˆ–å‹¾é¸ã€Œç´å…¥æœƒè­°è³‡è¨Šã€ï¼‰å¾Œå†æœå°‹ã€‚</div>`;
        _searchCache = { q, includeMeta, results:[], shown:0 };
        return;
      }

      const cardList = buildCardResults(q);
      const metaList = includeMeta ? buildMeetingMetaResults(q) : [];
      const results = [...cardList, ...metaList];

      if(results.length===0){
        resBox.innerHTML = `<div class="search-empty">æ‰¾ä¸åˆ°ç¬¦åˆã€Œ${escapeHTML(q)}ã€çš„å…§å®¹ã€‚</div>`;
        _searchCache = { q, includeMeta, results:[], shown:0 };
        return;
      }

      _searchCache = { q, includeMeta, results, shown:0 };
      renderSearchBatch(false);
    }

    function goToDate(date){
      closeSearchModal();
      loadMeeting(date);
      setTimeout(()=>{
        const top = document.querySelector('.header-section');
        if(top) top.scrollIntoView({ behavior:'smooth', block:'start' });
      }, 50);
    }

    function goToSearchResult(date, colId, idx){
      closeSearchModal();
      loadMeeting(date);
      setTimeout(()=>{
        const list = document.querySelectorAll('#' + colId + ' .card');
        const target = list[idx];
        if(target){
          target.scrollIntoView({ behavior:'smooth', block:'center' });
          target.classList.add('flash');
          setTimeout(()=>target.classList.remove('flash'), 1600);
        }else{
          alert('å·²åˆ‡æ›åˆ° ' + date + 'ï¼Œä½†æ‰¾ä¸åˆ°æŒ‡å®šå¡ç‰‡ï¼ˆå¯èƒ½ä½ç½®å·²è®Šæ›´ï¼‰ã€‚');
        }
      }, 50);
    }

    /* ===== åŸºæœ¬è¼‰å…¥ ===== */
    window.onload = init;
  </script>
</body>
</html>
