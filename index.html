<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>æœƒè­°ç®¡ç† 27.8 - å®Œæ•´æ¸…å–®å¡«æ»¿ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    :root{
      --bg:#f1f5f9; --card-bg:#fff; --text-main:#0f172a; --text-muted:#64748b;
      --border:#e2e8f0; --sidebar-bg:#fff; --accent:#0284c7; --input-bg:#f8fafc;

      --prio-high:#ef4444;    /* ç´… */
      --prio-mid:#f59e0b;     /* æ©˜ */
      --prio-low:#16a34a;     /* ç¶  */

      --toast-bg:#0f172a;
      --toast-ok:#10b981;
      --toast-warn:#f59e0b;
      --toast-err:#ef4444;
    }
    [data-theme="dark"]{
      --bg:#0f172a; --card-bg:#1e293b; --text-main:#f8fafc; --text-muted:#94a3b8;
      --border:#334155; --sidebar-bg:#1e293b; --accent:#38bdf8; --input-bg:#0f172a;

      --toast-bg:#0b1220;
    }

    html{ font-size:18px; height:100%; }
    body, input, select, textarea, button{ font-size:18px; }
    *{ box-sizing:border-box; transition:.15s ease; }

    /* === ä½ˆå±€ï¼šç¢ºä¿ä¸­é–“å¡«æ»¿ === */
    body{
      font-family:"PingFang TC","Microsoft JhengHei",sans-serif;
      background:var(--bg); color:var(--text-main);
      margin:0; display:flex; min-height:100dvh; overflow:auto;
    }

    /* å´é‚Šæ¬„ï¼šä¿ç•™æ—¥æœŸæ¸…å–®é¡¯ç¤º */
    .sidebar{
      width:80px; background:var(--sidebar-bg); border-right:1px solid var(--border);
      display:flex; flex-direction:column; align-items:center; padding:20px 0;
      flex-shrink:0; position: sticky; top: 0; height: 100vh; overflow-y: auto;
    }
    .side-icon{
      width:55px; height:50px; border-radius:12px; background:var(--bg); margin-bottom:15px;
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      border:1px solid var(--border); color:var(--text-muted); font-size:0.85rem; user-select:none; text-align:center;
      flex-shrink: 0;
    }
    .side-icon.active{ background:var(--accent); color:#fff; border-color:var(--accent); box-shadow:0 4px 10px rgba(0,0,0,.1); }
    .side-add{ border:2px dashed var(--text-muted); font-size:1.5rem; order: 999; margin-top: 10px; }

    /* ä¸»å…§å®¹å€ï¼šæ’¤é™¤å›ºå®šå¯¬åº¦é™åˆ¶ï¼Œæ”¹ç‚ºå¡«æ»¿ */
    .main{
      flex:1; min-width:0; padding:20px; display:flex; flex-direction:column;
      max-width: 100%;
      padding-bottom:var(--main-bottom-pad, 24px);
    }

    .header-section{ background:var(--card-bg); border-radius:16px; padding:20px; margin-bottom:20px; border:1px solid var(--border); }

    /* éŸ¿æ‡‰å¼ç¶²æ ¼ï¼šå¯¬åº¦å¡«æ»¿ */
    .info-row{ display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:12px; }
    .status-row{ display:grid; grid-template-columns: 1.5fr 1fr; gap:20px; padding-top:15px; border-top:1px solid var(--border); }

    .input-group label{ display:block; color:var(--text-muted); margin-bottom:6px; font-weight:bold; }
    .input-group select, .input-group input{
      background:var(--input-bg); border:1px solid var(--border); color:var(--text-main);
      padding:10px; border-radius:8px; width:100%; outline:none;
    }

    /* å‡ºå¸­äººå“¡æ¨™ç±¤ */
    .attendee-list{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; min-height:42px; padding:6px; background:var(--input-bg); border-radius:10px; border:1px dashed var(--border); }
    .tag{ background:rgba(56,189,248,.1); color:var(--accent); padding:5px 14px; border-radius:50px; font-size:1rem; border:1px solid var(--accent); display:flex; align-items:center; gap:8px; font-weight:bold; }
    .del-x{ cursor:pointer; color:#ef4444; font-weight:bold; display:none; }
    body[data-edit="true"] .del-x{ display:inline-block !important; }

    /* === çœ‹æ¿ === */
    .board{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:20px; flex:1; align-content:flex-start; margin-bottom:24px;
    }
    .column{
      background:rgba(0,0,0,0.02); border-radius:16px;
      padding:16px; display:flex; flex-direction:column; border:1px solid var(--border);
      min-height:300px; position:relative;
    }
    .column.drag-over{ outline:2px dashed var(--accent); outline-offset:4px; }
    .column-title{ font-weight:bold; margin-bottom:12px; color:var(--accent); border-bottom:2px solid var(--accent); padding-bottom:6px; font-size:20px; }

    /* ç©ºç‹€æ…‹ */
    .empty-state{
      flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
      color:var(--text-muted); gap:12px; padding:16px; text-align:center;
    }
    .empty-state svg{ width:80px; height:80px; opacity:.6; }

    /* å¡ç‰‡èˆ‡å…§å®¹ */
    .card{
      background:var(--card-bg); border-radius:14px; padding:14px; margin-bottom:12px;
      border:1px solid var(--border); position:relative; display:flex; flex-direction:column;
      /* ä¾å„ªå…ˆç´šï¼Œå·¦å´é¡¯ç¤ºç²—è‰²æ¢ */
      border-left:6px solid transparent;
    }
    .card.dragging{ opacity:.6; }
    .card[data-prio="é«˜"]{ border-left-color: var(--prio-high); }
    .card[data-prio="ä¸­"]{ border-left-color: var(--prio-mid); }
    .card[data-prio="ä½"]{ border-left-color: var(--prio-low); }

    .card textarea{ width:100%; background:transparent; border:none; color:var(--text-main); resize:none; font-family:inherit; outline:none; line-height:1.6; }
    .card .c-title{ font-size:1rem; font-weight:bold; margin-bottom:6px; border-bottom:1px solid var(--border); padding-bottom:5px; }
    .card .c-desc{
      font-size:1rem;
      height:56px; overflow:hidden;            /* ä¸å‡ºç¾å…§éƒ¨æ²è»¸ */
    }
    .card .c-desc.expanded{ height:auto; overflow:visible; }
    .expand-btn{ font-size:1rem; color:var(--accent); text-align:center; cursor:pointer; padding:4px; margin-top:10px; border-top:1px dashed var(--border); font-weight:bold; }

    .card-meta{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; padding-top:10px; border-top:1px solid var(--border); align-items:center; }
    .meta-item{ display:flex; align-items:center; gap:6px; }
    .meta-label{ color:var(--text-muted); font-weight:bold; white-space:nowrap; }

    /* å„ªå…ˆç´šæ¨™ç±¤ï¼ˆåªæœ‰ç·¨è¼¯æ¨¡å¼å¯é»ï¼‰ */
    .prio-group{ display:flex; gap:6px; }
    .prio-chip{
      padding:4px 12px; border-radius:999px; border:2px solid transparent;
      cursor:pointer; user-select:none; font-weight:800; font-size:.9rem; color:#fff;
      opacity:.75; transform: translateY(0); transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease, border-color .12s ease;
      outline: none;
    }
    .prio-high{ background:var(--prio-high); }
    .prio-mid { background:var(--prio-mid); }
    .prio-low { background:var(--prio-low); }
    .prio-chip.active{
      opacity:1;
      box-shadow: 0 0 0 3px rgba(0,0,0,.08);
      border-color: #000; /* âœ… å·²æ”¹ç‚ºé»‘è‰²ç²—é‚Š */
      transform: translateY(-1px);
    }
    /* æª¢è¦–æ¨¡å¼ç¦ç”¨é»æ“Š */
    body[data-edit="false"] .prio-chip{
      pointer-events:none; cursor:default; opacity:.45;
    }

    /* é™„ä»¶ç¸®åœ– */
    .attachments{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .thumb{
      width:88px; height:88px; border-radius:8px; overflow:hidden; border:1px solid var(--border); position:relative; background:#fff;
      display:flex; align-items:center; justify-content:center;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .thumb .remove{
      position:absolute; top:4px; right:4px; background:rgba(0,0,0,.6); color:#fff; border:none; border-radius:50%; width:22px; height:22px; cursor:pointer; display:none;
    }
    body[data-edit="true"] .thumb .remove{ display:block; }
    .add-thumb-btn{
      border:1px dashed var(--border); background:transparent; color:var(--text-muted);
      width:88px; height:88px; border-radius:8px; cursor:pointer;
    }
    .hidden{ display:none !important; }

    /* å³ä¸‹ Dock */
    .mini-dock{ position:fixed; right:20px; bottom:20px; z-index:900; display:flex; flex-direction:column; gap:10px; }
    .dock-btn{ width:44px; height:44px; border-radius:50%; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.2); }
    .dock-search{ background:#0d9488; } .dock-theme{ background:#64748b; } .dock-edit{ background:#f59e0b; } .dock-save{ background:#0284c7; } .dock-sync{ background:#0ea5e9; }

    /* Dock æç¤ºæ–‡å­—ï¼ˆæ»‘é¼ æ‡¸åœé¡¯ç¤ºä¸­æ–‡ï¼‰ */
    .dock-btn{ position: relative; }
    .dock-btn::after{
      content: attr(data-tip);
      position: absolute;
      right: 54px; top: 50%; transform: translateY(-50%);
      background: rgba(15, 23, 42, 0.9); color: #fff; padding: 6px 10px; border-radius: 6px; white-space: nowrap; font-size: 0.85rem; opacity: 0; pointer-events: none; transition: opacity .15s ease;
    }
    .dock-btn:hover::after{ opacity: 1; }
    .dock-btn::before{
      content: ""; position: absolute; right: 46px; top: 50%; transform: translateY(-50%); border-width: 6px; border-style: solid; border-color: transparent transparent transparent rgba(15, 23, 42, 0.9);
      opacity: 0; transition: opacity .15s ease;
    }
    .dock-btn:hover::before{ opacity: 1; }

    /* Toast */
    .toast-wrap{ position:fixed; right:20px; bottom:20px; display:flex; flex-direction:column; gap:8px; z-index:1000; pointer-events:none; }
    .toast{
      background:var(--toast-bg); color:#fff; border-radius:10px; padding:10px 14px; box-shadow:0 6px 20px rgba(0,0,0,.25);
      display:flex; align-items:center; gap:10px; pointer-events:auto; opacity:0; transform: translateY(10px);
      animation: toast-in .18s ease forwards;
    }
    .toast.ok{ border-left:4px solid var(--toast-ok); }
    .toast.warn{ border-left:4px solid var(--toast-warn); }
    .toast.err{ border-left:4px solid var(--toast-err); }
    @keyframes toast-in{ to{ opacity:1; transform: translateY(0); } }

    /* æ‰‹æ©Ÿè‡ªé©æ‡‰ */
    @media (max-width: 1024px) { .board { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) {
      body { flex-direction: column; }
      .sidebar { width: 100%; height: auto; flex-direction: row; border-right: none; border-bottom: 1px solid var(--border); overflow-x: auto; }
      .side-icon { margin-bottom: 0; margin-right: 10px; }
      .board { grid-template-columns: 1fr; }
      .status-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body data-theme="light" data-edit="false">

  <!-- Toast å®¹å™¨ -->
  <div class="toast-wrap" id="toastWrap"></div>

  <!-- æœå°‹ Modal -->
  <div class="modal-overlay" id="searchModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1000; align-items:center; justify-content:center;">
    <div class="modal-content" style="background:var(--card-bg); border-radius:16px; width:90%; max-width:800px; max-height:80vh; overflow:hidden; display:flex; flex-direction:column;">
      <div style="padding:20px; border-bottom:1px solid var(--border);">
        <h3>ğŸ” å…¨åŸŸæœå°‹</h3>
        <div style="display:flex; gap:10px;">
          <input id="globalSearchInput" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border);" type="search" placeholder="é—œéµå­—..." />
          <button onclick="performGlobalSearch(true)" style="background:var(--accent); color:#fff; border:none; padding:0 20px; border-radius:8px; cursor:pointer;">æœå°‹</button>
        </div>
      </div>
      <div id="searchResults" style="flex:1; overflow-y:auto; padding:20px;"></div>
      <div style="padding:15px; text-align:right;"><button onclick="closeSearchModal()">é—œé–‰</button></div>
    </div>
  </div>

  <!-- æ—¥æœŸ Modal -->
  <div class="modal-overlay" id="dateModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1000; align-items:center; justify-content:center;">
    <div class="modal-content" style="background:var(--card-bg); border-radius:16px; padding:25px; text-align:center;">
      <h3>ğŸ“… å»ºç«‹æ–°å ±å‘Š</h3>
      <input type="date" id="newMeetingDate" style="width:100%; padding:10px; margin:15px 0; border:1px solid var(--border); border-radius:8px;">
      <button onclick="confirmNewMeeting()" style="width:100%; background:var(--accent); color:#fff; border:none; padding:12px; border-radius:8px; cursor:pointer;">å»ºç«‹å ±å‘Š</button>
      <p style="margin-top:15px; color:var(--text-muted); cursor:pointer;" onclick="closeModal()">å–æ¶ˆ</p>
    </div>
  </div>

  <!-- å´é‚Šæ—¥æœŸåˆ— -->
  <div class="sidebar" id="dateSidebar">
    <div class="side-icon side-add" id="btnSideAdd" onclick="openModal()">+</div>
  </div>

  <!-- ä¸»å…§å®¹ -->
  <div class="main">
    <div class="header-section">

      <!-- å…¨éƒ¨å±•é–‹ / æ”¶åˆï¼šä»»ä½•æ¨¡å¼å¯ç”¨ -->
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-bottom:12px;">
        <button id="btnExpandAll" onclick="expandAllCards()"
          style="background:var(--accent); color:#fff; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:bold;">
          â–¼ å…¨éƒ¨å±•é–‹
        </button>
        <button id="btnCollapseAll" onclick="collapseAllCards()"
          style="background:#64748b; color:#fff; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:bold;">
          â–² å…¨éƒ¨æ”¶åˆ
        </button>
      </div>

      <div id="syncStatus" style="font-size:0.9rem; color:var(--accent); margin-bottom:10px; font-weight:bold;">â˜ï¸ æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</div>
      <div class="info-row">
        <div class="input-group"><label>ğŸ“… å ±å‘Šæ—¥æœŸ</label><input type="date" id="mDateDisplay" class="global-lock" onchange="handleDateChange()"></div>
        <div class="input-group"><label>ğŸ‘¤ ä¸»å¸­</label><select id="mChair" class="global-lock"></select></div>
        <div class="input-group"><label>ğŸ“ ç´€éŒ„</label><select id="mRecorder" class="global-lock"></select></div>
      </div>
      <div class="status-row">
        <div>
          <div class="input-group"><label>ğŸ‘¥ å‡ºå¸­äººå“¡</label><select id="mAttendeeSelect" class="global-lock" onchange="addAttendee(this.value); this.value='';">
            <option value="">-- è«‹æŒ‘é¸äººå“¡ --</option>
            <option value="è˜‡æ¸…æº">è˜‡æ¸…æº</option><option value="æ›¾é›ªå¦®">æ›¾é›ªå¦®</option><option value="é»ƒå©·éˆº">é»ƒå©·éˆº</option><option value="è”¡ç­‘ç">è”¡ç­‘ç</option><option value="è•­ç¿Šç¿">è•­ç¿Šç¿</option><option value="é™³ç«è«­">é™³ç«è«­</option><option value="æå®¶æ§¿">æå®¶æ§¿</option><option value="ä¿Šç”Ÿéƒ¨é•·">ä¿Šç”Ÿéƒ¨é•·</option>
          </select></div>
          <div id="attendeeList" class="attendee-list"></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
          <div class="input-group"><label>â˜€ï¸ æ—©ç­å ±å‘Š</label><select id="mRepMorning" class="global-lock"></select></div>
          <div class="input-group"><label>â›… ä¸­ç­å ±å‘Š</label><select id="mRepAfternoon" class="global-lock"></select></div>
        </div>
      </div>
    </div>

    <div class="board">
      <!-- å¹¹éƒ¨æœƒè­°ç´€éŒ„ -->
      <div class="column" data-col="col_record">
        <div class="column-title">ğŸ“ å¹¹éƒ¨æœƒè­°ç´€éŒ„å…§å®¹</div>
        <div id="col_record"></div>
        <div class="empty-state" data-empty="col_record" style="display:none;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="9"></circle><path d="M8 12h8M12 8v8"/></svg>
          <div>ä»Šå¤©é‚„æ²’æœ‰ç´€éŒ„ï¼Œé»æ“Šå³ä¸‹è§’é–‹å§‹å§ï¼</div>
        </div>
        <button class="global-lock" onclick="addNewCard('col_record')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer;">+ æ–°å¢æ±ºè­°</button>
      </div>

      <!-- è¿½è¹¤äº‹é … -->
      <div class="column" data-col="col_tracking">
        <div class="column-title" style="color:#15803d">ğŸ“ è¿½è¹¤äº‹é …ç›¤é»</div>
        <div id="col_tracking"></div>
        <div class="empty-state" data-empty="col_tracking" style="display:none;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 8h8M8 12h8M8 16h6"/></svg>
          <div>ç›®å‰æ²’æœ‰è¿½è¹¤äº‹é …ï¼Œæ–°å¢ä¸€ç­†å§ï¼</div>
        </div>
        <button class="global-lock" onclick="addNewCard('col_tracking')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer;">+ æ–°å¢è¿½è¹¤</button>
      </div>

      <!-- ç›®æ¨™é€²åº¦ -->
      <div class="column" data-col="col_target">
        <div class="column-title" style="color:#b45309">ğŸ“ 2026å¹´åº¦ç›®æ¨™é€²åº¦</div>
        <div id="col_target"></div>
        <div class="empty-state" data-empty="col_target" style="display:none;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 3v18h18"/><path d="M7 15l4-4 3 3 5-6"/></svg>
          <div>é‚„æ²’æœ‰é€²åº¦å›å ±ï¼Œè£œä¸Šæœ€æ–°é€²åº¦å§ï¼</div>
        </div>
        <button class="global-lock" onclick="addNewCard('col_target')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer;">+ æ–°å¢é€²åº¦</button>
      </div>
    </div>
  </div>

  <!-- å³ä¸‹ Dock -->
  <div class="mini-dock" id="miniDock">
    <button class="dock-btn dock-search" data-tip="å…¨åŸŸæœå°‹" title="å…¨åŸŸæœå°‹" onclick="openSearchModal()">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    </button>
    <button class="dock-btn dock-theme" data-tip="åˆ‡æ›ä¸»é¡Œ" title="åˆ‡æ›ä¸»é¡Œ" onclick="toggleTheme()">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
    </button>
    <button class="dock-btn dock-edit" data-tip="åˆ‡æ›ç·¨è¼¯æ¨¡å¼" title="åˆ‡æ›ç·¨è¼¯æ¨¡å¼" onclick="toggleEditMode()">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 113 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
    </button>
    <button class="dock-btn dock-save" data-tip="å„²å­˜åˆ°æœ¬æ©Ÿ" title="å„²å­˜åˆ°æœ¬æ©Ÿ" onclick="saveCurrentData()">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
    </button>
    <button class="dock-btn dock-sync" id="btnCloudSync" data-tip="åŒæ­¥åˆ°é›²ç«¯" title="åŒæ­¥åˆ°é›²ç«¯" onclick="saveAndSyncToCloud()">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.5 19a3.5 3.5 0 11-5.83-2.66 7 7 0 1110.59-4.84"/><path d="M12 13v8l-3-3m6 0l-3 3"/></svg>
    </button>
  </div>

  <script>
    /* ====== åŸºæœ¬è³‡æ–™ / è¨­å®š ====== */
    const CLOUD_API_URL = "https://script.google.com/macros/s/AKfycbxtfU8YUXCQyea1qh8khk1XbUN-zd1XzoGsNJcjruVThrSt3r7uW1XtzAexOK5rQ6sfiA/exec";
    const cadres = ["è˜‡æ¸…æº","æ›¾é›ªå¦®","é»ƒå©·éˆº","è”¡ç­‘ç","è•­ç¿Šç¿","é™³ç«è«­","æå®¶æ§¿","ä¿Šç”Ÿéƒ¨é•·"];  // å·²ä¿®æ­£å§“å
    const ownerList = ["å…¨éƒ¨","è˜‡æ¸…æº","æ›¾é›ªå¦®","é»ƒå©·éˆº","è”¡ç­‘ç","è•­ç¿Šç¿","é™³ç«è«­","æå®¶æ§¿"];      // å·²ä¿®æ­£å§“å
    const categoryList = ["å®¢æœ","VIP","å…¨éƒ¨"];
    const PRIORITY = ["é«˜","ä¸­","ä½"];

    // åœ–ç‰‡å£“ç¸®è¨­å®š
    const IMG_MAX_WH = 1280;
    const IMG_QUALITY = 0.8;
    const IMG_PER_CARD_LIMIT = 3;
    const AUTOSAVE_INTERVAL_MS = 30000;

    let meetings = JSON.parse(localStorage.getItem('MeetingV27_Data')) || {};
    let currentDay = Object.keys(meetings).sort().reverse()[0] || new Date().toISOString().split('T')[0];
    let unsavedChanges = false;
    let autosaveTimer = null;
    let searchOffset = 0;
    const SEARCH_PAGE = 50;

    /* ====== å·¥å…·ï¼šToast ====== */
    function showToast(msg, type='ok', timeout=1800){
      const wrap = document.getElementById('toastWrap');
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<span>${msg}</span>`;
      wrap.appendChild(t);
      setTimeout(()=>{ t.style.opacity=0; t.style.transform='translateY(10px)'; setTimeout(()=>t.remove(),180); }, timeout);
    }

    /* ====== é›²ç«¯å­˜å– ====== */
    async function fetchCloudData(){
      const status = document.getElementById('syncStatus');
      try{
        const res = await fetch(CLOUD_API_URL, { method:'GET', mode:'cors', headers:{'Accept':'application/json'} });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if(data && typeof data === 'object'){
          meetings = data;
          status.innerText = "â˜ï¸ é›²ç«¯åŒæ­¥å®Œæˆ";
          localStorage.setItem('MeetingV27_Data', JSON.stringify(meetings));
          refreshSidebar();
          loadMeeting(currentDay);
        }else{
          status.innerText = "âš ï¸ é›²ç«¯è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºï¼Œæ”¹ç”¨æœ¬åœ°æš«å­˜";
        }
      }catch(e){
        status.innerText = "âš ï¸ ä½¿ç”¨æœ¬åœ°æš«å­˜ (é›²ç«¯æœªé€£ç·š)";
      }
    }

    async function saveAndSyncToCloud(){
      saveCurrentToVariable();
      const status = document.getElementById('syncStatus');
      status.innerText = "â³ åŒæ­¥ä¸­...";
      try{
        const res = await fetch(CLOUD_API_URL, { method:'POST', body:JSON.stringify(meetings), mode:'cors', headers:{'Content-Type':'application/json'} });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const out = await res.json().catch(()=>({ok:true}));
        if(out.ok){
          showToast("â˜ï¸ å·²åŒæ­¥åˆ°é›²ç«¯","ok");
          status.innerText = "â˜ï¸ é›²ç«¯åŒæ­¥å®Œæˆ";
          unsavedChanges = false;
        }else{
          throw new Error(out.message || 'åŒæ­¥å¤±æ•—');
        }
      }catch(e){
        showToast("âŒ åŒæ­¥å¤±æ•—","err");
        status.innerText = "âš ï¸ åŒæ­¥å¤±æ•— (å·²ä¿ç•™æœ¬æ©Ÿè³‡æ–™)";
      }
    }

    /* ====== åˆå§‹åŒ– ====== */
    function init(){
      // æ¬„ä½åå–®
      ['mChair','mRecorder','mRepMorning','mRepAfternoon'].forEach(id=>{
        const el = document.getElementById(id); el.add(new Option('', ''));
        cadres.forEach(name=>{ if(name!=='ä¿Šç”Ÿéƒ¨é•·') el.add(new Option(name, name)); });
      });

      // æœå°‹æ¡†é˜²æŠ–
      const searchInput = document.getElementById('globalSearchInput');
      searchInput.addEventListener('input', debounce(()=>performGlobalSearch(false), 300));

      // ç·¨è¼¯æé†’ï¼ˆæœªå„²å­˜é›¢é–‹ï¼‰
      window.addEventListener('beforeunload', (e)=>{
        if(unsavedChanges && document.body.getAttribute('data-edit')==='true'){
          e.preventDefault(); e.returnValue = '';
        }
      });

      // è‡ªå‹•å„²å­˜
      autosaveTimer = setInterval(()=>{
        if(unsavedChanges){
          saveCurrentToVariable();
          showToast("ğŸ’¾ å·²è‡ªå‹•å„²å­˜","ok",1200);
          unsavedChanges = false;
        }
      }, AUTOSAVE_INTERVAL_MS);

      fetchCloudData().then(()=>{
        refreshSidebar();
        loadMeeting(currentDay);
        updateLocks();
      });
    }

    function refreshSidebar(){
      const bar = document.getElementById('dateSidebar');
      Array.from(bar.querySelectorAll('.side-icon:not(.side-add)')).forEach(el=>el.remove());
      Object.keys(meetings).sort().reverse().forEach(date=>{
        const btn = document.createElement('div');
        btn.className = `side-icon ${date===currentDay ? 'active' : ''}`;
        btn.innerText = date.split('-').slice(1).join('/');
        const [y,m,d] = date.split('-');
        btn.title = `${y} å¹´ ${parseInt(m)} æœˆ ${parseInt(d)} æ—¥`;
        btn.onclick = () => loadMeeting(date);
        bar.insertBefore(btn, bar.lastElementChild);
      });
    }

    function updateEmptyStates(){
      ['col_record','col_tracking','col_target'].forEach(id=>{
        const cont = document.getElementById(id);
        const empty = document.querySelector(`[data-empty="${id}"]`);
        if(empty) empty.style.display = cont.children.length ? 'none' : 'flex';
      });
    }

    /* ====== ä¸»æµç¨‹ ====== */
    function loadMeeting(date){
      currentDay = date;
      if(!meetings[date]) meetings[date] = { attendees:[], cards:{col_record:[], col_tracking:[], col_target:[]} };

      const data = meetings[date];
      document.getElementById('mDateDisplay').value = date;
      document.getElementById('mChair').value = data.chair || '';
      document.getElementById('mRecorder').value = data.recorder || '';
      document.getElementById('mRepMorning').value = data.morning || '';
      document.getElementById('mRepAfternoon').value = data.afternoon || '';

      const list = document.getElementById('attendeeList');
      list.innerHTML = ""; (data.attendees || []).forEach(n=>renderAttendee(n));

      ['col_record','col_tracking','col_target'].forEach(id=>{
        const cont = document.getElementById(id); cont.innerHTML = "";
        (data.cards[id] || []).forEach(c=>addNewCard(id, c));
      });

      refreshSidebar();
      updateLocks();
      collapseAllCards();      // è¼‰å…¥å¾Œé è¨­æ”¶åˆ
      enableDnD();             // å•Ÿç”¨æ‹–æ‹‰ï¼ˆåªåœ¨ç·¨è¼¯æ¨¡å¼ä¸­å¯ç”¨ï¼‰
      updateEmptyStates();
      unsavedChanges = false;
    }

    function renderAttendee(name){
      const list = document.getElementById('attendeeList');
      const tag = document.createElement('div'); tag.className='tag'; tag.dataset.name=name;
      tag.innerHTML = `<span>${name}</span><span class="del-x" onclick="this.parentElement.remove(); markDirty(); updateEmptyStates();">âœ•</span>`;
      list.appendChild(tag);
    }
    function addAttendee(name){ if(name){ renderAttendee(name); markDirty(); } }

    function addNewCard(colId, data=null){
      const col = document.getElementById(colId);
      const card = document.createElement('div'); card.className='card';
      const d = data || { title:'', desc:'', cat:'å…¨éƒ¨', owner:'å…¨éƒ¨', keep:true, priority:'ä¸­', images:[] };
      card.dataset.prio = d.priority || 'ä¸­'; // è®“å·¦å´è‰²æ¢é¡¯ç¤º

      const keepCheck = colId==='col_tracking' ? `<label class="meta-label"><input type="checkbox" class="m-keep" ${d.keep?'checked':''}>ä¿ç•™</label>` : '';

      // å¡ç‰‡å…§å®¹
      card.innerHTML = `
        <div class="del-x" style="position:absolute; top:10px; right:15px; cursor:pointer;" onclick="this.parentElement.remove(); markDirty(); updateEmptyStates();">âœ•</div>
        <textarea class="c-title" placeholder="æ¨™é¡Œ">${esc(d.title)}</textarea>
        <textarea class="c-desc" placeholder="å…§å®¹...">${esc(d.desc)}</textarea>

        <div class="attachments"></div>
        <div class="card-meta">
          <div class="meta-item"><span class="meta-label">åˆ†é¡:</span>
            <select class="m-cat meta-select">${["å®¢æœ","VIP","å…¨éƒ¨"].map(c=>`<option ${d.cat===c?'selected':''}>${c}</option>`).join('')}</select>
          </div>
          <div class="meta-item"><span class="meta-label">è² è²¬:</span>
            <select class="m-own meta-select">${["å…¨éƒ¨","è˜‡æ¸…æº","æ›¾é›ªå¦®","é»ƒå©·éˆº","è”¡ç­‘ç","è•­ç¿Šç¿","é™³ç«è«­","æå®¶æ§¿"].map(o=>`<option ${d.owner===o?'selected':''}>${o}</option>`).join('')}</select>
          </div>
          <div class="meta-item"><span class="meta-label">å„ªå…ˆ:</span>
            <div class="prio-group">
              <div class="prio-chip prio-high ${d.priority==='é«˜'?'active':''}" data-prio="é«˜" tabindex="0" role="button" aria-pressed="${d.priority==='é«˜'}">é«˜</div>
              <div class="prio-chip prio-mid  ${d.priority==='ä¸­'?'active':''}" data-prio="ä¸­" tabindex="0" role="button" aria-pressed="${d.priority==='ä¸­'}">ä¸­</div>
              <div class="prio-chip prio-low  ${d.priority==='ä½'?'active':''}" data-prio="ä½" tabindex="0" role="button" aria-pressed="${d.priority==='ä½'}">ä½</div>
            </div>
          </div>
          ${keepCheck}
        </div>
        <div class="expand-btn" onclick="toggleExpand(this)">â–¼ å±•é–‹</div>
        <input type="file" class="m-file hidden" accept="image/*" multiple>
        <button class="add-thumb-btn global-lock" onclick="this.previousElementSibling.click()">ï¼‹ åœ–ç‰‡</button>
      `;

      // è¼¸å…¥æ”¹å‹• â†’ æ¨™è¨˜æœªå„²å­˜
      card.querySelectorAll('textarea, select, input[type="checkbox"]').forEach(el=>{
        el.addEventListener('input', markDirty);
        el.addEventListener('change', markDirty);
      });

      // è‡ªå‹•é«˜åº¦
      const desc = card.querySelector('.c-desc');
      if(desc){ desc.addEventListener('input', ()=> autoResizeTextarea(desc)); }

      // å„ªå…ˆç´šé»é¸ï¼ˆåƒ…ç·¨è¼¯æ¨¡å¼ï¼‰
      card.querySelectorAll('.prio-chip').forEach(chip=>{
        chip.addEventListener('click', ()=> setPriority(card, chip.dataset.prio));
        chip.addEventListener('keydown', (e)=>{
          if(e.key==='Enter' || e.key===' '){ e.preventDefault(); setPriority(card, chip.dataset.prio); }
        });
      });

      // åœ–ç‰‡åˆå§‹åŒ–èˆ‡äº‹ä»¶
      const att = card.querySelector('.attachments');
      const fileInput = card.querySelector('.m-file');
      fileInput.addEventListener('change', async (e)=>{
        const files = Array.from(e.target.files || []);
        if(!files.length) return;
        const existed = att.querySelectorAll('.thumb').length;
        const quota = IMG_PER_CARD_LIMIT - existed;
        const use = files.slice(0, quota);
        for(const f of use){
          try{
            const url = await handleImageUpload(f);
            addThumb(att, url);
            markDirty();
          }catch(err){
            showToast('åœ–ç‰‡è™•ç†å¤±æ•—','err');
          }
        }
        fileInput.value = '';
      });
      (d.images||[]).forEach(u=> addThumb(att, u));

      // æ‹–æ›³å±¬æ€§ï¼ˆåœ¨ enableDnD ä¸­çµ±ä¸€é–‹é—œï¼‰
      card.setAttribute('draggable','false');

      col.appendChild(card);
      updateLocks();
      resetTextareaToCollapsed(desc);
      updateEmptyStates();
      return card;
    }

    /* ====== å„ªå…ˆç´šé‚è¼¯ ====== */
    function setPriority(card, prio){
      if(document.body.getAttribute('data-edit')!=='true') return; // éç·¨è¼¯æ¨¡å¼ä¸è™•ç†
      card.dataset.prio = prio; // å·¦å´è‰²æ¢å³æ™‚æ›´æ–°
      const chips = card.querySelectorAll('.prio-chip');
      chips.forEach(c=>{
        const isActive = (c.dataset.prio === prio);
        c.classList.toggle('active', isActive);
        c.setAttribute('aria-pressed', String(isActive));
      });
      markDirty();
    }

    /* ====== Expand / Collapse ====== */
    function toggleExpand(btn){
      const desc = btn.parentElement.querySelector('.c-desc');
      if(!desc) return;
      const isExp = desc.classList.toggle('expanded');
      if(isExp){
        autoResizeTextarea(desc);
        btn.innerText = "â–² æ”¶åˆ";
      }else{
        resetTextareaToCollapsed(desc);
        btn.innerText = "â–¼ å±•é–‹";
      }
    }
    function autoResizeTextarea(el){
      if(!el) return;
      el.classList.add('expanded');
      el.style.overflow = 'hidden';
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight) + 'px';
    }
    function resetTextareaToCollapsed(el){
      if(!el) return;
      el.classList.remove('expanded');
      el.style.overflow = 'hidden';
      el.style.height = '56px';
    }
    function expandAllCards(){
      document.querySelectorAll('.card .c-desc').forEach(desc=>{
        autoResizeTextarea(desc);
        const btn = desc.parentElement.querySelector('.expand-btn');
        if(btn) btn.innerText = "â–² æ”¶åˆ";
      });
    }
    function collapseAllCards(){
      document.querySelectorAll('.card .c-desc').forEach(desc=>{
        resetTextareaToCollapsed(desc);
        const btn = desc.parentElement.querySelector('.expand-btn');
        if(btn) btn.innerText = "â–¼ å±•é–‹";
      });
    }

    /* ====== é–å®šé‚è¼¯ ====== */
    function toggleEditMode(){
      const isEdit = document.body.getAttribute('data-edit') === 'true';
      document.body.setAttribute('data-edit', String(!isEdit));
      updateLocks();
      enableDnD();
    }
    function updateLocks(){
      const isEdit = document.body.getAttribute('data-edit') === 'true';
      document.querySelectorAll('.global-lock, .card textarea, .card select, .m-keep').forEach(el=>el.disabled = !isEdit);
      // å„ªå…ˆç´š chip äº’å‹•ç”± CSS æ§åˆ¶ï¼ˆæª¢è¦–æ¨¡å¼ pointer-events:noneï¼‰
    }

    /* ====== å„²å­˜ ====== */
    function saveCurrentToVariable(){
      const getCardObj = (c)=>({
        title: c.querySelector('.c-title').value,
        desc: c.querySelector('.c-desc').value,
        cat: c.querySelector('.m-cat').value,
        owner: c.querySelector('.m-own').value,
        keep: c.querySelector('.m-keep')?.checked,
        priority: c.dataset.prio || (c.querySelector('.prio-chip.active')?.dataset?.prio) || 'ä¸­',
        images: Array.from(c.querySelectorAll('.attachments .thumb img')).map(i=>i.src)
      });
      const getCards = id => Array.from(document.getElementById(id).querySelectorAll('.card')).map(getCardObj);

      meetings[currentDay] = {
        chair: document.getElementById('mChair').value,
        recorder: document.getElementById('mRecorder').value,
        morning: document.getElementById('mRepMorning').value,
        afternoon: document.getElementById('mRepAfternoon').value,
        attendees: Array.from(document.querySelectorAll('.tag')).map(t=>t.dataset.name),
        cards: { col_record:getCards('col_record'), col_tracking:getCards('col_tracking'), col_target:getCards('col_target') }
      };
      localStorage.setItem('MeetingV27_Data', JSON.stringify(meetings));
    }
    function saveCurrentData(){
      saveCurrentToVariable();
      unsavedChanges = false;
      showToast("ğŸ’¾ å·²å„²å­˜åˆ°æœ¬æ©Ÿ","ok");
      toggleEditMode();
    }

    /* ====== å…¶å®ƒ UI æ§åˆ¶ ====== */
    function openSearchModal(){ document.getElementById('searchModal').style.display='flex'; }
    function closeSearchModal(){ document.getElementById('searchModal').style.display='none'; }
    function openModal(){ document.getElementById('dateModal').style.display='flex'; }
    function closeModal(){ document.getElementById('dateModal').style.display='none'; }
    function confirmNewMeeting(){
      const d = document.getElementById('newMeetingDate').value;
      if(d){ loadMeeting(d); closeModal(); markDirty(); }
    }
    function handleDateChange(){ loadMeeting(document.getElementById('mDateDisplay').value); }
    function toggleTheme(){
      const b = document.body;
      b.setAttribute('data-theme', b.getAttribute('data-theme')==='dark'?'light':'dark');
    }

    /* ====== å…¨åŸŸæœå°‹ï¼ˆé˜²æŠ–ï¼‹åˆ†æ‰¹é¡¯ç¤ºï¼‰ ====== */
    function performGlobalSearch(reset=false){
      const q = document.getElementById('globalSearchInput').value.trim().toLowerCase();
      const resBox = document.getElementById('searchResults');
      if(reset){ searchOffset = 0; resBox.innerHTML = ""; }
      const all = [];
      Object.keys(meetings).sort().reverse().forEach(date=>{
        const m = meetings[date];
        const cards = [...(m.cards?.col_record||[]), ...(m.cards?.col_tracking||[]), ...(m.cards?.col_target||[])];
        cards.forEach(c=>{
          const t = (c.title||'').toLowerCase();
          const d = (c.desc||'').toLowerCase();
          if(!q || t.includes(q) || d.includes(q)) all.push({date, title:c.title||'(ç„¡æ¨™é¡Œ)'});
        });
      });
      const slice = all.slice(searchOffset, searchOffset+SEARCH_PAGE);
      slice.forEach(it=>{
        const item = document.createElement('div');
        item.innerHTML = `<strong>[${it.date}] ${esc(it.title)}</strong><br><button onclick="loadMeeting('${it.date}');closeSearchModal();">å‰å¾€</button><hr>`;
        resBox.appendChild(item);
      });
      searchOffset += slice.length;
      const moreBtnId = 'btnSearchMore';
      let more = document.getElementById(moreBtnId);
      if(searchOffset < all.length){
        if(!more){
          more = document.createElement('button'); more.id = moreBtnId;
          more.textContent = 'è¼‰å…¥æ›´å¤š...'; more.style.margin='8px 0';
          more.onclick = ()=> performGlobalSearch(false);
          resBox.appendChild(more);
        }
      }else{
        if(more){ more.remove(); }
      }
    }
    function debounce(fn, delay){ let t=null; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); }; }

    /* ====== Drag & Dropï¼ˆç·¨è¼¯æ¨¡å¼å•Ÿç”¨ï¼‰ ====== */
    let dragSrc = null;
    function enableDnD(){
      const isEdit = document.body.getAttribute('data-edit') === 'true';
      document.querySelectorAll('.card').forEach(c=>{
        c.setAttribute('draggable', isEdit?'true':'false');
        c.removeEventListener('dragstart', onDragStart);
        c.removeEventListener('dragend', onDragEnd);
        if(isEdit){
          c.addEventListener('dragstart', onDragStart);
          c.addEventListener('dragend', onDragEnd);
        }
      });
      document.querySelectorAll('.column').forEach(col=>{
        col.removeEventListener('dragover', onDragOver);
        col.removeEventListener('drop', onDrop);
        if(isEdit){
          col.addEventListener('dragover', onDragOver);
          col.addEventListener('drop', onDrop);
        }
      });
    }
    function onDragStart(e){
      dragSrc = e.currentTarget;
      dragSrc.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain','');
    }
    function onDragEnd(e){
      if(dragSrc){ dragSrc.classList.remove('dragging'); dragSrc = null; markDirty(); updateEmptyStates(); }
    }
    function onDragOver(e){
      e.preventDefault();
      const col = e.currentTarget;
      const container = col.querySelector(`#${col.dataset.col}`);
      const afterEl = getDragAfterElement(container, e.clientY);
      if(afterEl==null){
        container.appendChild(dragSrc);
      }else{
        container.insertBefore(dragSrc, afterEl);
      }
    }
    function onDrop(e){ e.preventDefault(); }
    function getDragAfterElement(container, y){
      const els = [...container.querySelectorAll('.card:not(.dragging)')];
      return els.reduce((closest, child)=>{
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height/2;
        if(offset < 0 && offset > closest.offset){
          return { offset, element: child };
        }else{
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    /* ====== åœ–ç‰‡è™•ç†ï¼ˆBase64 ç¸®åœ–ï¼‰ ====== */
    async function handleImageUpload(file){
      const img = await fileToImage(file);
      const {canvas, ctx, targetW, targetH} = sizedCanvas(img, IMG_MAX_WH);
      ctx.drawImage(img, 0, 0, targetW, targetH);
      return canvas.toDataURL('image/webp', IMG_QUALITY);
    }
    function fileToImage(file){
      return new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onload = ()=>{
          const img = new Image();
          img.onload = ()=> resolve(img);
          img.onerror = reject;
          img.src = fr.result;
        };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }
    function sizedCanvas(img, maxWH){
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      let w = img.width, h = img.height;
      if(w>h && w>maxWH){ h = Math.round(h*maxWH/w); w=maxWH; }
      else if(h>=w && h>maxWH){ w = Math.round(w*maxWH/h); h=maxWH; }
      canvas.width = w; canvas.height = h;
      return {canvas, ctx, targetW:w, targetH:h};
    }
    function addThumb(container, url){
      const th = document.createElement('div'); th.className='thumb';
      th.innerHTML = `${url}<button class="remove" title="ç§»é™¤" onclick="this.parentElement.remove(); markDirty();">Ã—</button>`;
      container.appendChild(th);
    }

    /* ====== å…±åŒå°å·¥å…· ====== */
    function markDirty(){ unsavedChanges = true; }
    function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    /* ====== Modal æ§åˆ¶ï¼ˆè¦†è“‹åŒåä»¥ç¬¦åˆå‰é¢ onclickï¼‰ ====== */
    function openSearchModal(){ document.getElementById('searchModal').style.display='flex'; }
    function closeSearchModal(){ document.getElementById('searchModal').style.display='none'; }
    function openModal(){ document.getElementById('dateModal').style.display='flex'; }
    function closeModal(){ document.getElementById('dateModal').style.display='none'; }

    /* ====== è¼”åŠ© ====== */
    window.onload = init;
  </script>
</body>
</html>
