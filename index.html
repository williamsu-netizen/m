<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å®¢æœæœƒè­°ç®¡ç†ç³»çµ± 27.2.1 - é›²ç«¯åŒæ­¥ä¿®æ­£ç‰ˆ</title>
    <style>
        :root {
            --bg: #f1f5f9; --card-bg: #ffffff; --text-main: #0f172a; --text-muted: #64748b;
            --border: #e2e8f0; --sidebar-bg: #ffffff; --accent: #0284c7; --input-bg: #f8fafc;
            --danger: #ef4444;
        }
        [data-theme="dark"] {
            --bg: #0f172a; --card-bg: #1e293b; --text-main: #f8fafc; --text-muted: #94a3b8;
            --border: #334155; --sidebar-bg: #1e293b; --accent: #38bdf8; --input-bg: #0f172a;
        }

        * { box-sizing: border-box; transition: 0.2s ease; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 80px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 20px 0; overflow-y: auto; flex-shrink: 0; }
        .side-icon { width: 50px; height: 50px; border-radius: 12px; background: var(--bg); margin-bottom: 15px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border); color: var(--text-muted); font-size: 0.7rem; text-align: center; }
        .side-icon.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .side-add { border: 2px dashed var(--text-muted); font-size: 1.5rem; }

        .main { flex: 1; padding: 25px; display: flex; flex-direction: column; overflow-x: hidden; }
        .header-section { background: var(--card-bg); border-radius: 20px; padding: 20px; margin-bottom: 25px; border: 1px solid var(--border); }
        
        .info-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .status-row { display: grid; grid-template-columns: 1fr 450px; gap: 25px; padding-top: 15px; border-top: 1px solid var(--border); }

        .input-group label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px; font-weight: bold; }
        .input-group select, .input-group input { background: var(--input-bg); border: 1px solid var(--border); color: var(--text-main); padding: 10px; border-radius: 8px; width: 100%; outline: none; font-size: 0.9rem; }

        .attendee-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; min-height: 42px; padding: 6px; background: var(--input-bg); border-radius: 10px; border: 1px dashed var(--border); }
        .tag { background: rgba(56, 189, 248, 0.1); color: var(--accent); padding: 5px 14px; border-radius: 50px; font-size: 0.85rem; border: 1px solid var(--accent); display: flex; align-items: center; gap: 8px; font-weight: bold; position: relative;}
        
        /* å´æ¬„èˆ‡æŒ‰éˆ•ä¿®æ­£ */
        .board { display: flex; flex-wrap: wrap; gap: 20px; flex: 1; overflow-y: auto; align-content: flex-start; }
        .column { background: rgba(0,0,0,0.02); border-radius: 20px; flex: 1 1 350px; padding: 20px; display: flex; flex-direction: column; border: 1px solid var(--border); min-height: 450px; }
        .column-title { font-weight: bold; margin-bottom: 20px; color: var(--accent); border-bottom: 2px solid var(--accent); padding-bottom: 8px; }

        /* --- å¡ç‰‡èˆ‡ç§»é™¤æŒ‰éˆ•ä½ç½®ä¿®æ­£ --- */
        .card { background: var(--card-bg); border-radius: 15px; padding: 18px; margin-bottom: 15px; border: 1px solid var(--border); position: relative; display: flex; flex-direction: column; overflow: hidden;}
        
        /* ç§»é™¤æŒ‰éˆ•ç§»è‡³å³ä¸Šè§’ä¸”ç¨ç«‹é¡¯ç¤º */
        .del-x { 
            cursor: pointer; color: var(--danger); font-weight: bold; display: none; 
            position: absolute; top: 10px; right: 10px; z-index: 10;
            background: rgba(239, 68, 68, 0.1); padding: 2px 8px; border-radius: 5px;
        }
        body[data-edit="true"] .del-x { display: block !important; }

        .card textarea { width: 100%; background: transparent; border: none; color: var(--text-main); resize: none; font-family: inherit; outline: none; line-height: 1.6; }
        .card .c-title { font-size: 1rem; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 5px; padding-right: 60px; min-height: 35px; }
        
        /* --- ä¿®æ­£æ»‘å‹•æ²è»¸ --- */
        .card .c-desc { 
            font-size: 0.9rem; 
            height: 65px; 
            overflow-y: auto; /* æ ¸å¿ƒï¼šå…è¨±å‚ç›´æ»‘å‹• */
            transition: height 0.3s ease-in-out;
            margin-bottom: 5px;
            padding-right: 5px;
        }
        /* è‡ªå®šç¾©æ²è»¸æ¨£å¼ */
        .card .c-desc::-webkit-scrollbar { width: 4px; }
        .card .c-desc::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        .card .c-desc.expanded { 
            height: 250px; /* å±•é–‹å¾Œçµ¦å®šæœ€å¤§é«˜åº¦ï¼Œè¶…å‡ºå‰‡æ»‘å‹• */
            overflow-y: auto;
        }

        .expand-btn {
            font-size: 0.8rem; color: var(--accent); text-align: center; cursor: pointer; padding: 4px; 
            margin-top: auto; border-top: 1px dashed var(--border); font-weight: bold; user-select: none;
        }

        .card-meta { display: flex; align-items: center; gap: 10px; margin-top: 5px; padding-top: 10px; border-top: 1px solid var(--border); flex-wrap: wrap; }
        .meta-item { display: flex; align-items: center; gap: 5px; flex: 1; min-width: 140px; }
        .meta-label { font-size: 0.75rem; color: var(--text-muted); font-weight: bold; }
        .meta-select { background: var(--input-bg); border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; font-size: 0.75rem; padding: 4px; flex: 1; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 20px; width: 320px; text-align: center; }
        .fab-container { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; z-index: 900; }
        .fab { padding: 12px 25px; border-radius: 50px; font-weight: bold; border: none; cursor: pointer; box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
        .btn-theme { background: #64748b; color: white; }
        .btn-edit { background: #f59e0b; color: white; }
        .btn-sync { background: #0284c7; color: white; box-shadow: 0 0 15px rgba(2, 132, 199, 0.4); }
    </style>
</head>
<body data-theme="dark" data-edit="false">

<div class="modal-overlay" id="dateModal">
    <div class="modal-content">
        <h3 style="color:var(--accent)">ğŸ“… é¸æ“‡æ–°æœƒè­°æ—¥æœŸ</h3>
        <input type="date" id="newMeetingDate" style="padding:8px;">
        <br>
        <button onclick="confirmNewMeeting()" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:50px; margin-top:15px; cursor:pointer;">å»ºç«‹å ±å‘Š</button>
        <p style="cursor:pointer; font-size:0.8rem; color:var(--text-muted);" onclick="closeModal()">å–æ¶ˆ</p>
    </div>
</div>

<div class="sidebar" id="dateSidebar">
    <div class="side-icon side-add" id="btnSideAdd" onclick="openModal()">+</div>
</div>

<div class="main">
    <div class="header-section">
        <div id="syncStatus" style="font-size: 0.8rem; color: var(--accent); margin-bottom: 10px;">â˜ï¸ æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</div>
        <div class="info-row">
            <div class="input-group"><label>ğŸ“… å ±å‘Šæ—¥æœŸ</label><input type="text" id="mDateDisplay" readonly style="font-weight:bold; color:var(--accent);"></div>
            <div class="input-group"><label>ğŸ‘¤ ä¸»å¸­</label><select id="mChair" class="global-lock"></select></div>
            <div class="input-group"><label>ğŸ“ ç´€éŒ„</label><select id="mRecorder" class="global-lock"></select></div>
        </div>
        <div class="status-row">
            <div class="attendance-section">
                <div class="input-group">
                    <label>ğŸ‘¥ å‡ºå¸­äººå“¡</label>
                    <select id="mAttendeeSelect" class="global-lock" onchange="addAttendee(this.value); this.value='';">
                        <option value="">-- è«‹æŒ‘é¸äººå“¡ --</option>
                        <option value="è˜‡æ¸…æº">è˜‡æ¸…æº</option><option value="æ›¾é›ªå¦®">æ›¾é›ªå¦®</option>
                        <option value="é»ƒå©·éˆº">é»ƒå©·éˆº</option><option value="è”¡ç­‘ç">è”¡ç­‘ç</option>
                        <option value="è•­ç¿Šç¿">è•­ç¿Šç¿</option><option value="é™³ç«è«­">é™³ç«è«­</option>
                        <option value="æå®¶æ§¿">æå®¶æ§¿</option><option value="ä¿Šç”Ÿéƒ¨é•·">ä¿Šç”Ÿéƒ¨é•·</option>
                    </select>
                </div>
                <div id="attendeeList" class="attendee-list"></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div class="input-group" style="border-left: 4px solid var(--accent); padding-left:12px;"><label>â˜€ï¸ æ—©ç­å ±å‘Š</label><select id="mRepMorning" class="global-lock"></select></div>
                <div class="input-group" style="border-left: 4px solid #15803d; padding-left:12px;"><label>â›… ä¸­ç­å ±å‘Š</label><select id="mRepAfternoon" class="global-lock"></select></div>
            </div>
        </div>
    </div>

    <div class="board">
        <div class="column">
            <div class="column-title">ğŸ“ å¹¹éƒ¨æœƒè­°ç´€éŒ„å…§å®¹</div>
            <div id="col_record"></div>
            <button class="add-btn global-lock" onclick="addNewCard('col_record')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer; color:var(--text-muted);">+ æ–°å¢æ±ºè­°</button>
        </div>
        <div class="column">
            <div class="column-title" style="color:#15803d">ğŸ“ è¿½è¹¤äº‹é …ç›¤é»</div>
            <div id="col_tracking"></div>
            <button class="add-btn global-lock" onclick="addNewCard('col_tracking')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer; color:var(--text-muted);">+ æ–°å¢è¿½è¹¤</button>
        </div>
        <div class="column">
            <div class="column-title" style="color:#b45309">ğŸ“ 2026å¹´åº¦ç›®æ¨™é€²åº¦</div>
            <div id="col_target"></div>
            <button class="add-btn global-lock" onclick="addNewCard('col_target')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer; color:var(--text-muted);">+ æ–°å¢é€²åº¦</button>
        </div>
    </div>
</div>

<div class="fab-container">
    <button class="fab btn-theme" onclick="toggleTheme()">ğŸŒ“ åˆ‡æ›é»‘ç™½</button>
    <button class="fab btn-edit" id="editToggleBtn" onclick="toggleEditMode()">ğŸ”’ é–‹å•Ÿç·¨è¼¯æ¨¡å¼</button>
    <button class="fab btn-sync" onclick="syncToCloud()">â˜ï¸ åŒæ­¥è‡³é›²ç«¯</button>
</div>

<script>
    const CLOUD_API_URL = "https://script.google.com/macros/s/AKfycbxtfU8YUXCQyea1qh8khk1XbUN-zd1XzoGsNJcjruVThrSt3r7uW1XtzAexOK5rQ6sfiA/exec";
    const ownerList = ["å…¨éƒ¨", "è˜‡æ¸…æº", "æ›¾é›ªå¦®", "é»ƒå©·éˆº", "è”¡ç­‘ç", "è•­ç¿Šç¿", "é™³ç«è«­", "æå®¶æ§¿"];
    const categoryList = ["å®¢æœ", "VIP", "å…¨éƒ¨"];
    const cadres = ["è˜‡æ¸…æº", "æ›¾é›ªå¦®", "é»ƒå©·éˆº", "è”¡ç­‘ç", "è•­ç¿Šç¿", "é™³ç«è«­", "æå®¶æ§¿", "ä¿Šç”Ÿéƒ¨é•·"];

    let meetings = { 
        "2026-01-28": { attendees: ["è˜‡æ¸…æº","æ›¾é›ªå¦®","è”¡ç­‘ç","è•­ç¿Šç¿","é™³ç«è«­","æå®¶æ§¿"], chair:"è”¡ç­‘ç", recorder:"è•­ç¿Šç¿", morning:"æ›¾é›ªå¦®", afternoon:"è”¡ç­‘ç", cards: { col_record: [], col_tracking: [], col_target: [] } }
    };
    let currentDay = "2026-01-28";

    async function init() {
        setupSelects();
        await fetchCloudData();
        currentDay = Object.keys(meetings).sort().reverse()[0] || "2026-01-28";
        refreshSidebar(); loadMeeting(currentDay);
        updateLocks();
    }

    async function fetchCloudData() {
        try {
            const res = await fetch(CLOUD_API_URL);
            const data = await res.json();
            if (data && Object.keys(data).length > 0) {
                meetings = data;
                document.getElementById('syncStatus').innerText = "â˜ï¸ é›²ç«¯è³‡æ–™åŒæ­¥å®Œæˆ";
            }
        } catch (e) {
            document.getElementById('syncStatus').innerText = "âš ï¸ ç¬¬ä¸€æ¬¡é€£ç·šï¼Œè«‹é»æ“ŠåŒæ­¥æŒ‰éˆ•";
        }
    }

    async function syncToCloud() {
        saveCurrentToVariable();
        document.getElementById('syncStatus').innerText = "â³ æ­£åœ¨åŒæ­¥è‡³é›²ç«¯...";
        try {
            const res = await fetch(CLOUD_API_URL, { method: 'POST', body: JSON.stringify(meetings) });
            const text = await res.text();
            alert("âœ… " + text);
            document.getElementById('syncStatus').innerText = "â˜ï¸ é›²ç«¯åŒæ­¥å®Œæˆ";
            if (document.body.getAttribute('data-edit') === 'true') toggleEditMode();
        } catch (e) {
            alert("âŒ åŒæ­¥å¤±æ•—ï¼Œè«‹ç¢ºèªæ¬Šé™è¨­å®š");
        }
    }

    function setupSelects() {
        ['mChair', 'mRecorder', 'mRepMorning', 'mRepAfternoon'].forEach(id => {
            const el = document.getElementById(id);
            cadres.forEach(name => { if(name!=="ä¿Šç”Ÿéƒ¨é•·") el.add(new Option(name, name)); });
        });
        cadres.forEach(name => document.getElementById('mAttendeeSelect').add(new Option(name, name)));
    }

    function toggleEditMode() {
        const isEdit = document.body.getAttribute('data-edit') === 'true';
        document.body.setAttribute('data-edit', !isEdit);
        document.getElementById('editToggleBtn').innerText = !isEdit ? "ğŸ”“ é€€å‡ºç·¨è¼¯" : "ğŸ”’ é–‹å•Ÿç·¨è¼¯æ¨¡å¼";
        document.getElementById('editToggleBtn').style.background = !isEdit ? "#ef4444" : "#f59e0b";
        updateLocks();
    }

    function updateLocks() {
        const isEdit = document.body.getAttribute('data-edit') === 'true';
        document.querySelectorAll('.global-lock').forEach(el => el.disabled = !isEdit);
        document.getElementById('btnSideAdd').onclick = isEdit ? openModal : null;
        document.querySelectorAll('.card').forEach(card => {
            card.querySelectorAll('textarea, select').forEach(el => el.disabled = !isEdit);
        });
    }

    function openModal() { document.getElementById('dateModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('dateModal').style.display = 'none'; }
    
    function confirmNewMeeting() {
        const date = document.getElementById('newMeetingDate').value;
        if (date) {
            if (!meetings[date]) {
                const prevData = meetings[currentDay] || {chair:"", recorder:"", morning:"", afternoon:"", cards:{col_record:[], col_tracking:[], col_target:[]}};
                meetings[date] = { attendees: [], chair: prevData.chair, recorder: prevData.recorder, morning: prevData.morning, afternoon: prevData.afternoon, cards: { col_record: [], col_tracking: JSON.parse(JSON.stringify(prevData.cards.col_tracking)), col_target: JSON.parse(JSON.stringify(prevData.cards.col_target)) } };
            }
            currentDay = date; closeModal(); refreshSidebar(); loadMeeting(date);
        }
    }

    function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }

    function refreshSidebar() {
        const bar = document.getElementById('dateSidebar');
        Array.from(bar.querySelectorAll('.side-icon:not(.side-add)')).forEach(el => el.remove());
        Object.keys(meetings).sort().reverse().forEach(date => {
            const btn = document.createElement('div');
            btn.className = `side-icon ${date === currentDay ? 'active' : ''}`;
            btn.innerHTML = date.substring(5).replace('-', '/');
            btn.onclick = () => loadMeeting(date);
            bar.insertBefore(btn, bar.lastElementChild);
        });
    }

    function addAttendee(name) {
        if (!name) return;
        const list = document.getElementById('attendeeList');
        if (Array.from(list.querySelectorAll('.tag')).some(t => t.innerText.includes(name))) return;
        const tag = document.createElement('div'); tag.className = 'tag';
        tag.innerHTML = `${name} <span class="del-x" style="position:static" onclick="this.parentElement.remove()">âœ•</span>`;
        list.appendChild(tag);
        updateLocks();
    }

    function toggleExpand(btn) {
        const descArea = btn.parentElement.querySelector('.c-desc');
        if (descArea.classList.contains('expanded')) {
            descArea.classList.remove('expanded');
            descArea.style.height = '65px';
            btn.innerHTML = 'â–¼ å±•é–‹';
        } else {
            descArea.classList.add('expanded');
            descArea.style.height = '250px'; /* å›ºå®šå±•é–‹é«˜åº¦ï¼Œå…è¨±å…§éƒ¨æ»‘å‹• */
            btn.innerHTML = 'â–² æ”¶åˆ';
        }
    }

    function addNewCard(colId, data = null) {
        const col = document.getElementById(colId); const card = document.createElement('div'); 
        card.className = 'card';
        const d = data || { title: 'äº‹é …åç¨±', desc: 'å…§å®¹è©³æƒ…...' };
        card.innerHTML = `
            <div class="del-x" onclick="this.parentElement.remove()">ç§»é™¤âœ•</div>
            <textarea class="c-title" rows="1">${d.title}</textarea>
            <textarea class="c-desc">${d.desc}</textarea>
            <div class="expand-btn" onclick="toggleExpand(this)">â–¼ å±•é–‹</div>
            <div class="card-meta">
                <div class="meta-item"><span class="meta-label">åˆ†é¡:</span><select class="m-cat meta-select">${categoryList.map(c => `<option value="${c}" ${d.cat===c?'selected':''}>${c}</option>`).join('')}</select></div>
                <div class="meta-item"><span class="meta-label">è² è²¬:</span><select class="m-own meta-select">${ownerList.map(n => `<option value="${n}" ${d.owner===n?'selected':''}>${n}</option>`).join('')}</select></div>
            </div>`;
        col.appendChild(card);
        updateLocks();
    }

    function loadMeeting(date) {
        currentDay = date; document.getElementById('mDateDisplay').value = date; const data = meetings[date];
        document.getElementById('mChair').value = data.chair || ""; document.getElementById('mRecorder').value = data.recorder || "";
        document.getElementById('mRepMorning').value = data.morning || ""; document.getElementById('mRepAfternoon').value = data.afternoon || "";
        document.getElementById('attendeeList').innerHTML = ""; (data.attendees || []).forEach(n => addAttendee(n));
        ['col_record', 'col_tracking', 'col_target'].forEach(id => {
            document.getElementById(id).innerHTML = ""; if (data.cards && data.cards[id]) data.cards[id].forEach(c => addNewCard(id, c));
        });
        refreshSidebar(); updateLocks();
    }

    function saveCurrentToVariable() {
        meetings[currentDay] = {
            chair: document.getElementById('mChair').value, recorder: document.getElementById('mRecorder').value,
            morning: document.getElementById('mRepMorning').value, afternoon: document.getElementById('mRepAfternoon').value,
            attendees: Array.from(document.querySelectorAll('#attendeeList .tag')).map(t => t.innerText.replace('âœ•', '').trim()),
            cards: { col_record: getCardData('col_record'), col_tracking: getCardData('col_tracking'), col_target: getCardData('col_target') }
        };
    }

    function getCardData(id) { 
        return Array.from(document.getElementById(id).querySelectorAll('.card')).map(c => ({ 
            title: c.querySelector('.c-title').value, desc: c.querySelector('.c-desc').value, 
            cat: c.querySelector('.m-cat').value, owner: c.querySelector('.m-own').value 
        })); 
    }

    window.onload = init;
</script>
</body>
</html>
