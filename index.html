<html lang="zh-TW"><head>
    <meta charset="UTF-8">
    <title>å®¢æœæœƒè­°ç³»çµ± v28.3 (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    
    <script id="database-script">
        // åˆå§‹é è¨­è³‡æ–™ (è‹¥é›²ç«¯æœ‰è³‡æ–™ï¼Œå•Ÿå‹•å¾Œæœƒè‡ªå‹•è¦†è“‹)
        window.MEETING_DB = {
          "2026-01-28": {
            "chair": "è”¡ç­‘ç", "recorder": "è•­ç¿Šç¿", "morning": "æ›¾é›ªå¦®", "afternoon": "è”¡ç­‘ç",
            "attendees": ["è˜‡æ¸…æº", "æ›¾é›ªå¦®", "è”¡ç­‘ç", "è•­ç¿Šç¿", "é™³ç«è«­", "æå®¶æ§¿"],
            "cards": { "col_record": [], "col_tracking": [], "col_target": [] }
          }
        };
    </script>
    <style>
        :root { --bg: #f8fafc; --card-bg: #ffffff; --text-main: #334155; --text-muted: #64748b; --border: #e2e8f0; --accent: #0369a1; --input-bg: #f1f5f9; }
        [data-theme="dark"] { --bg: #0f172a; --card-bg: #1e293b; --text-main: #f8fafc; --text-muted: #94a3b8; --border: #334155; --accent: #38bdf8; --input-bg: #0f172a; }
        * { box-sizing: border-box; transition: 0.2s ease; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 80px; background: var(--card-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 20px 0; overflow-y: auto; flex-shrink: 0; }
        .side-icon { width: 50px; height: 50px; border-radius: 12px; background: var(--bg); margin-bottom: 15px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border); color: var(--text-muted); font-size: 0.7rem; text-align: center; }
        .side-icon.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .side-add { border: 2px dashed var(--text-muted); font-size: 1.5rem; }
        .main { flex: 1; padding: 25px; display: flex; flex-direction: column; overflow-x: hidden; }
        .header-section { background: var(--card-bg); border-radius: 20px; padding: 20px; margin-bottom: 25px; border: 1px solid var(--border); }
        .info-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .status-row { display: grid; grid-template-columns: 1fr 450px; gap: 25px; padding-top: 15px; border-top: 1px solid var(--border); }
        .input-group label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px; font-weight: bold; }
        .input-group select, .input-group input { background: var(--input-bg); border: 1px solid var(--border); color: var(--text-main); padding: 10px; border-radius: 8px; width: 100%; outline: none; font-size: 0.9rem; }
        .attendee-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; min-height: 42px; padding: 6px; background: var(--input-bg); border-radius: 10px; border: 1px dashed var(--border); }
        .tag { background: rgba(56, 189, 248, 0.1); color: var(--accent); padding: 5px 14px; border-radius: 50px; font-size: 0.85rem; border: 1px solid var(--accent); display: flex; align-items: center; gap: 8px; font-weight: bold; }
        .del-x { cursor: pointer; color: #ef4444; font-weight: bold; display: none; margin-left: 5px; }
        body[data-edit="true"] .del-x { display: inline-block !important; }
        .board { display: flex; flex-wrap: wrap; gap: 20px; flex: 1; overflow-y: auto; align-content: flex-start; }
        .column { background: rgba(0,0,0,0.02); border-radius: 20px; flex: 1 1 350px; padding: 20px; display: flex; flex-direction: column; border: 1px solid var(--border); min-height: 450px; }
        .column-title { font-weight: bold; margin-bottom: 20px; color: var(--accent); border-bottom: 2px solid var(--accent); padding-bottom: 8px; }
        .card { background: var(--card-bg); border-radius: 15px; padding: 18px; margin-bottom: 15px; border: 1px solid var(--border); position: relative; display: flex; flex-direction: column; }
        .card textarea { width: 100%; background: transparent; border: none; color: var(--text-main); resize: none; font-family: inherit; outline: none; line-height: 1.6; }
        .card .c-title { font-size: 1rem; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 5px; min-height: 35px; }
        .card .c-desc { font-size: 0.9rem; height: 65px; overflow: hidden; transition: height 0.3s ease-in-out; margin-bottom: 5px; }
        .card .c-desc.expanded { overflow: visible; height: auto !important; }
        .expand-btn { font-size: 0.8rem; color: var(--accent); text-align: center; cursor: pointer; padding: 4px; margin-top: auto; border-top: 1px dashed var(--border); font-weight: bold; }
        .fab-container { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; z-index: 900; }
        .fab { padding: 12px 25px; border-radius: 50px; font-weight: bold; border: none; cursor: pointer; box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
        .btn-sync { background: #3b82f6; color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .btn-edit { background: #ef4444; color: white; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 20px; width: 320px; text-align: center; }
    </style>
</head>
<body data-theme="dark" data-edit="false">

<div class="modal-overlay" id="dateModal">
    <div class="modal-content">
        <h3 style="color:var(--accent)">ğŸ“… å»ºç«‹æ–°æœƒè­°æ—¥æœŸ</h3>
        <input type="date" id="newMeetingDate" style="padding:8px; width:100%;">
        <button onclick="confirmNewMeeting()" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:50px; margin-top:15px; cursor:pointer;">å»ºç«‹ä¸¦ç¹¼æ‰¿è³‡æ–™</button>
        <p style="cursor:pointer; font-size:0.8rem; color:var(--text-muted);" onclick="closeModal()">å–æ¶ˆ</p>
    </div>
</div>

<div class="sidebar" id="dateSidebar">
    <div class="side-icon side-add" id="btnSideAdd" onclick="openModal()">+</div>
</div>

<div class="main">
    <div class="header-section">
        <div class="info-row" id="syncStatus" style="font-size: 0.8rem; color: var(--accent); margin-bottom: 10px;">â˜ï¸ æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</div>
        <div class="info-row">
            <div class="input-group"><label>ğŸ“… å ±å‘Šæ—¥æœŸ</label><input type="text" id="mDateDisplay" readonly="" style="font-weight:bold; color:var(--accent);"></div>
            <div class="input-group"><label>ğŸ‘¤ ä¸»å¸­</label><select id="mChair" class="global-lock" disabled=""></select></div>
            <div class="input-group"><label>ğŸ“ ç´€éŒ„</label><select id="mRecorder" class="global-lock" disabled=""></select></div>
        </div>
        <div class="status-row">
            <div class="attendance-section">
                <div class="input-group">
                    <label>ğŸ‘¥ å‡ºå¸­äººå“¡</label>
                    <select id="mAttendeeSelect" class="global-lock" onchange="addAttendee(this.value); this.value='';" disabled="">
                        <option value="">-- è«‹æŒ‘é¸äººå“¡ --</option>
                    </select>
                </div>
                <div id="attendeeList" class="attendee-list"></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div class="input-group"><label>â˜€ï¸ æ—©ç­å ±å‘Š</label><select id="mRepMorning" class="global-lock" disabled=""></select></div>
                <div class="input-group"><label>â›… ä¸­ç­å ±å‘Š</label><select id="mRepAfternoon" class="global-lock" disabled=""></select></div>
            </div>
        </div>
    </div>

    <div class="board">
        <div class="column"><div class="column-title">ğŸ“ å¹¹éƒ¨æœƒè­°ç´€éŒ„å…§å®¹</div><div id="col_record"></div><button class="add-btn global-lock" onclick="addNewCard('col_record')" disabled="">+ æ–°å¢æ±ºè­°</button></div>
        <div class="column"><div class="column-title" style="color:#15803d">ğŸ“ è¿½è¹¤äº‹é …ç›¤é»</div><div id="col_tracking"></div><button class="add-btn global-lock" onclick="addNewCard('col_tracking')" disabled="">+ æ–°å¢è¿½è¹¤</button></div>
        <div class="column"><div class="column-title" style="color:#b45309">ğŸ“ 2026å¹´åº¦ç›®æ¨™é€²åº¦</div><div id="col_target"></div><button class="add-btn global-lock" onclick="addNewCard('col_target')" disabled="">+ æ–°å¢é€²åº¦</button></div>
    </div>
</div>

<div class="fab-container">
    <button class="fab btn-theme" onclick="toggleTheme()">ğŸŒ“ åˆ‡æ›é»‘ç™½</button>
    <button class="fab btn-edit" id="editToggleBtn" onclick="toggleEditMode()">ğŸ”’ ç·¨è¼¯æ¨¡å¼</button>
    <button class="fab btn-sync" onclick="syncDataToCloud()">â˜ï¸ åŒæ­¥è‡³é›²ç«¯</button>
</div>

<script>
    // âš ï¸ é—œéµæ­¥é©Ÿï¼šè«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨åœ¨ Google éƒ¨ç½²å¾—åˆ°çš„ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€
    const CLOUD_API_URL = "åœ¨æ­¤è²¼ä¸Šæ‚¨çš„_GAS_ç¶²å€"; 

    const cadres = ["è˜‡æ¸…æº", "æ›¾é›ªå¦®", "é»ƒå©·éˆº", "è”¡ç­‘ç", "è•­ç¿Šç¿", "é™³ç«è«­", "æå®¶æ§¿", "ä¿Šç”Ÿéƒ¨é•·"];
    let meetings = window.MEETING_DB;
    let currentDay = "";

    async function init() {
        setupSelects();
        await fetchCloudData();
        currentDay = Object.keys(meetings).sort().reverse()[0] || new Date().toISOString().split('T')[0];
        loadMeeting(currentDay);
    }

    async function fetchCloudData() {
        try {
            const res = await fetch(CLOUD_API_URL);
            const data = await res.json();
            if (data && Object.keys(data).length > 0) {
                meetings = data;
                document.getElementById('syncStatus').innerText = "â˜ï¸ é›²ç«¯è³‡æ–™åŒæ­¥å®Œæˆ";
            }
        } catch (e) {
            document.getElementById('syncStatus').innerText = "âš ï¸ é›²ç«¯åˆå§‹ç‚ºç©ºï¼Œè«‹é–‹å§‹å»ºç«‹ä¸¦åŒæ­¥";
        }
    }

    async function syncDataToCloud() {
        saveCurrentToVariable();
        document.getElementById('syncStatus').innerText = "â³ æ­£åœ¨ä¸Šå‚³...";
        try {
            const res = await fetch(CLOUD_API_URL, {
                method: 'POST',
                body: JSON.stringify(meetings)
            });
            const text = await res.text();
            document.getElementById('syncStatus').innerText = "âœ… " + text;
            alert(text);
        } catch (e) {
            alert("åŒæ­¥å¤±æ•—ï¼š" + e);
        }
    }

    function setupSelects() {
        const ids = ['mChair', 'mRecorder', 'mRepMorning', 'mRepAfternoon', 'mAttendeeSelect'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            cadres.forEach(name => { if(name!=="ä¿Šç”Ÿéƒ¨é•·" || id==="mAttendeeSelect") el.add(new Option(name, name)); });
        });
    }

    function loadMeeting(date) {
        currentDay = date;
        document.getElementById('mDateDisplay').value = date;
        const data = meetings[date] || { attendees: [], cards: { col_record: [], col_tracking: [], col_target: [] } };
        
        document.getElementById('mChair').value = data.chair || "";
        document.getElementById('mRecorder').value = data.recorder || "";
        document.getElementById('mRepMorning').value = data.morning || "";
        document.getElementById('mRepAfternoon').value = data.afternoon || "";
        
        document.getElementById('attendeeList').innerHTML = "";
        (data.attendees || []).forEach(n => addAttendee(n));

        ['col_record', 'col_tracking', 'col_target'].forEach(id => {
            document.getElementById(id).innerHTML = "";
            if (data.cards && data.cards[id]) data.cards[id].forEach(c => addNewCard(id, c));
        });
        refreshSidebar();
        updateLocks();
    }

    function saveCurrentToVariable() {
        meetings[currentDay] = {
            chair: document.getElementById('mChair').value,
            recorder: document.getElementById('mRecorder').value,
            morning: document.getElementById('mRepMorning').value,
            afternoon: document.getElementById('mRepAfternoon').value,
            attendees: Array.from(document.querySelectorAll('.tag')).map(t => t.innerText.replace('âœ•', '').trim()),
            cards: {
                col_record: getCardData('col_record'),
                col_tracking: getCardData('col_tracking'),
                col_target: getCardData('col_target')
            }
        };
    }

    function getCardData(id) {
        return Array.from(document.getElementById(id).querySelectorAll('.card')).map(c => ({
            title: c.querySelector('.c-title').value,
            desc: c.querySelector('.c-desc').value,
            cat: c.querySelector('.m-cat').value,
            owner: c.querySelector('.m-own').value
        }));
    }

    function addNewCard(colId, d = { title: 'äº‹é …åç¨±', desc: 'å…§å®¹è©³æƒ…...', cat: 'å…¨éƒ¨', owner: 'å…¨éƒ¨' }) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="del-x" style="position:absolute; top:10px; right:15px; cursor:pointer;" onclick="this.parentElement.remove()">ç§»é™¤âœ•</div>
            <textarea class="c-title" rows="1">${d.title}</textarea>
            <textarea class="c-desc">${d.desc}</textarea>
            <div class="expand-btn" onclick="toggleExpand(this)">â–¼ å±•é–‹</div>
            <div class="card-meta">
                <select class="m-cat">${["å®¢æœ","VIP","æ•¸æ“š","å…¨éƒ¨"].map(c=>`<option ${d.cat===c?'selected':''}>${c}</option>`).join('')}</select>
                <select class="m-own">${cadres.map(n=>`<option ${d.owner===n?'selected':''}>${n}</option>`).join('')}</select>
            </div>`;
        document.getElementById(colId).appendChild(card);
        updateLocks();
    }

    function addAttendee(name) {
        const list = document.getElementById('attendeeList');
        if (Array.from(list.querySelectorAll('.tag')).some(t => t.innerText.includes(name))) return;
        const tag = document.createElement('div'); tag.className = 'tag';
        tag.innerHTML = `${name} <span class="del-x" onclick="this.parentElement.remove()">âœ•</span>`;
        list.appendChild(tag);
    }

    function refreshSidebar() {
        const bar = document.getElementById('dateSidebar');
        Array.from(bar.querySelectorAll('.side-icon:not(.side-add)')).forEach(el => el.remove());
        Object.keys(meetings).sort().reverse().forEach(date => {
            const btn = document.createElement('div');
            btn.className = `side-icon ${date === currentDay ? 'active' : ''}`;
            btn.innerHTML = date.substring(5).replace('-', '/');
            btn.onclick = () => loadMeeting(date);
            bar.insertBefore(btn, bar.lastElementChild);
        });
    }

    function toggleEditMode() {
        const isEdit = document.body.getAttribute('data-edit') === 'false';
        document.body.setAttribute('data-edit', isEdit);
        document.getElementById('editToggleBtn').innerText = isEdit ? "ğŸ”“ æª¢è¦–æ¨¡å¼" : "ğŸ”’ ç·¨è¼¯æ¨¡å¼";
        updateLocks();
    }

    function updateLocks() {
        const isEdit = document.body.getAttribute('data-edit') === 'true';
        document.querySelectorAll('.global-lock, textarea, select, .add-btn').forEach(el => el.disabled = !isEdit);
    }

    function toggleExpand(btn) {
        const desc = btn.parentElement.querySelector('.c-desc');
        desc.classList.toggle('expanded');
        btn.innerText = desc.classList.contains('expanded') ? "â–² æ”¶åˆ" : "â–¼ å±•é–‹";
    }

    function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
    function openModal() { document.getElementById('dateModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('dateModal').style.display = 'none'; }
    function confirmNewMeeting() {
        const date = document.getElementById('newMeetingDate').value;
        if (!date || meetings[date]) return;
        meetings[date] = JSON.parse(JSON.stringify(meetings[currentDay]));
        meetings[date].cards.col_record = [];
        loadMeeting(date);
        closeModal();
    }

    window.onload = init;
</script>
</body></html>
