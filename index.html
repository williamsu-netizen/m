<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>æœƒè­°ç®¡ç† 28.2 - è³‡è¨Šæ ¡æ­£ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    :root{
      --bg:#f1f5f9; --card-bg:#fff; --text-main:#0f172a; --text-muted:#64748b;
      --border:#e2e8f0; --sidebar-bg:#fff; --accent:#0284c7; --input-bg:#f8fafc;
    }
    [data-theme="dark"]{
      --bg:#0f172a; --card-bg:#1e293b; --text-main:#f8fafc; --text-muted:#94a3b8;
      --border:#334155; --sidebar-bg:#1e293b; --accent:#38bdf8; --input-bg:#0f172a;
    }

    html{ font-size:18px; height:100%; }
    body, input, select, textarea, button{ font-size:18px; }
    *{ box-sizing:border-box; transition:.15s ease; }

    body{
      font-family:"PingFang TC","Microsoft JhengHei",sans-serif;
      background:var(--bg); color:var(--text-main);
      margin:0; display:flex; min-height:100dvh; overflow:auto;
    }

    /* === å´é‚Šæ¬„ === */
    .sidebar{
      width:80px; background:var(--sidebar-bg); border-right:1px solid var(--border);
      display:flex; flex-direction:column; align-items:center; padding:20px 0;
      flex-shrink:0; position: sticky; top: 0; height: 100vh; overflow-y: auto;
    }
    .side-icon{
      width:55px; height:50px; border-radius:12px; background:var(--bg); margin-bottom:15px;
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      border:1px solid var(--border); color:var(--text-muted); font-size:0.85rem; user-select:none; text-align:center;
      flex-shrink: 0;
    }
    .side-icon.active{ background:var(--accent); color:#fff; border-color:var(--accent); box-shadow:0 4px 10px rgba(0,0,0,.1); }
    .side-add{ border:2px dashed var(--text-muted); font-size:1.5rem; order: 999; margin-top: 10px; }

    /* === ä¸»å…§å®¹ === */
    .main{ flex:1; min-width:0; padding:20px; display:flex; flex-direction:column; max-width: 100%; }
    .header-section{ background:var(--card-bg); border-radius:16px; padding:20px; margin-bottom:20px; border:1px solid var(--border); }
    .info-row{ display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:12px; }
    .status-row{ display:grid; grid-template-columns: 1.5fr 1fr; gap:20px; padding-top:15px; border-top:1px solid var(--border); }
    .input-group label{ display:block; color:var(--text-muted); margin-bottom:6px; font-weight:bold; }
    .input-group select, .input-group input{
      background:var(--input-bg); border:1px solid var(--border); color:var(--text-main);
      padding:10px; border-radius:8px; width:100%; outline:none;
    }

    /* === æ¨™ç±¤èˆ‡å„ªå…ˆç´š === */
    .attendee-list{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; min-height:42px; padding:6px; background:var(--input-bg); border-radius:10px; border:1px dashed var(--border); }
    .tag{ background:rgba(56,189,248,.1); color:var(--accent); padding:5px 14px; border-radius:50px; font-size:1rem; border:1px solid var(--accent); display:flex; align-items:center; gap:8px; font-weight:bold; }
    .del-x{ cursor:pointer; color:#ef4444; font-weight:bold; display:none; }
    body[data-edit="true"] .del-x{ display:inline-block !important; }

    .p-tag { padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-main); }
    .p-high { background: #fee2e2 !important; color: #ef4444 !important; border-color: #fca5a5; }
    .p-mid { background: #fef3c7 !important; color: #d97706 !important; border-color: #fcd34d; }
    .p-low { background: #dcfce7 !important; color: #16a34a !important; border-color: #86efac; }

    /* === çœ‹æ¿èˆ‡æ‹–æ›³ === */
    .board{ display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; flex:1; align-content:flex-start; margin-bottom:24px; }
    .column{ background:rgba(0,0,0,0.02); border-radius:16px; padding:16px; display:flex; flex-direction:column; border:2px solid transparent; min-height:400px; }
    .column.drag-over { border: 2px dashed var(--accent); background: rgba(2, 132, 199, 0.05); }
    .column-title{ font-weight:bold; margin-bottom:12px; color:var(--accent); border-bottom:2px solid var(--accent); padding-bottom:6px; font-size:20px; }

    .card{ background:var(--card-bg); border-radius:14px; padding:14px; margin-bottom:12px; border:1px solid var(--border); position:relative; cursor: grab; }
    .card:active { cursor: grabbing; }
    .card.dragging { opacity: 0.4; border: 2px solid var(--accent); }
    .card textarea{ width:100%; background:transparent; border:none; color:var(--text-main); resize:none; font-family:inherit; outline:none; line-height:1.6; }
    .card .c-title{ font-size:1rem; font-weight:bold; margin-bottom:6px; border-bottom:1px solid var(--border); padding-bottom:5px; }
    .card .c-desc{ font-size:1rem; height:56px; overflow:hidden; }
    .card .c-desc.expanded{ height:auto; overflow:visible; }
    
    .expand-btn{ font-size:1rem; color:var(--accent); text-align:center; cursor:pointer; padding:4px; margin-top:10px; border-top:1px dashed var(--border); font-weight:bold; }
    .card-meta{ display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin-top:10px; padding-top:10px; border-top:1px solid var(--border); }
    .meta-item{ display:flex; align-items:center; gap:5px; }
    .meta-label{ color:var(--text-muted); font-size: 0.8rem; font-weight:bold; white-space:nowrap; }
    .meta-select { width: 100%; padding: 2px; border-radius: 4px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-main); font-size: 0.85rem; }

    /* === Toast === */
    #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; }
    .toast { background: #0f172a; color: white; padding: 10px 20px; border-radius: 50px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 0.9rem; animation: fadeInOut 2.5s forwards; }
    @keyframes fadeInOut { 0% { opacity: 0; transform: translateY(-20px); } 15% { opacity: 1; transform: translateY(0); } 85% { opacity: 1; } 100% { opacity: 0; } }

    .empty-placeholder { grid-column: 1/-1; text-align: center; padding: 60px; color: var(--text-muted); border: 2px dashed var(--border); border-radius: 20px; margin: 20px 0; }

    .mini-dock{ position:fixed; right:20px; bottom:20px; z-index:900; display:flex; flex-direction:column; gap:10px; }
    .dock-btn{ width:44px; height:44px; border-radius:50%; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.2); position: relative; }
    .dock-search{ background:#0d9488; } .dock-theme{ background:#64748b; } .dock-edit{ background:#f59e0b; } .dock-save{ background:#0284c7; } .dock-sync{ background:#0ea5e9; }
    
    .dock-btn::after{ content: attr(data-tip); position: absolute; right: 54px; top: 50%; transform: translateY(-50%); background: rgba(15, 23, 42, 0.9); color: #fff; padding: 6px 10px; border-radius: 6px; white-space: nowrap; font-size: 0.85rem; opacity: 0; pointer-events: none; }
    .dock-btn:hover::after{ opacity: 1; }

    @media (max-width: 768px) {
      body { flex-direction: column; }
      .sidebar { width: 100%; height: auto; flex-direction: row; border-right: none; border-bottom: 1px solid var(--border); overflow-x: auto; padding: 10px; }
      .side-icon { margin-bottom: 0; margin-right: 10px; }
      .board { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body data-theme="light" data-edit="false">

  <div id="toast-container"></div>

  <div class="modal-overlay" id="searchModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1000; align-items:center; justify-content:center;">
    <div class="modal-content" style="background:var(--card-bg); border-radius:16px; width:90%; max-width:800px; max-height:80vh; overflow:hidden; display:flex; flex-direction:column;">
      <div style="padding:20px; border-bottom:1px solid var(--border);">
        <h3>ğŸ” å…¨åŸŸæœå°‹</h3>
        <div style="display:flex; gap:10px;">
          <input id="globalSearchInput" oninput="debouncedSearch()" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border);" type="search" placeholder="è¼¸å…¥é—œéµå­—è‡ªå‹•æœå°‹..." />
        </div>
      </div>
      <div id="searchResults" style="flex:1; overflow-y:auto; padding:20px;"></div>
      <div style="padding:15px; text-align:right;"><button onclick="closeSearchModal()">é—œé–‰</button></div>
    </div>
  </div>

  <div class="modal-overlay" id="dateModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1000; align-items:center; justify-content:center;">
    <div class="modal-content" style="background:var(--card-bg); border-radius:16px; padding:25px; text-align:center;">
      <h3>ğŸ“… å»ºç«‹æ–°å ±å‘Š</h3>
      <input type="date" id="newMeetingDate" style="width:100%; padding:10px; margin:15px 0; border:1px solid var(--border); border-radius:8px;">
      <button onclick="confirmNewMeeting()" style="width:100%; background:var(--accent); color:#fff; border:none; padding:12px; border-radius:8px; cursor:pointer;">å»ºç«‹å ±å‘Š</button>
      <p style="margin-top:15px; color:var(--text-muted); cursor:pointer;" onclick="closeModal()">å–æ¶ˆ</p>
    </div>
  </div>

  <div class="sidebar" id="dateSidebar">
    <div class="side-icon side-add" id="btnSideAdd" onclick="openModal()">+</div>
  </div>

  <div class="main">
    <div class="header-section">
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-bottom:12px;">
        <button onclick="expandAllCards()" style="background:var(--accent); color:#fff; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:bold;">â–¼ å…¨éƒ¨å±•é–‹</button>
        <button onclick="collapseAllCards()" style="background:#64748b; color:#fff; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:bold;">â–² å…¨éƒ¨æ”¶åˆ</button>
      </div>

      <div id="syncStatus" style="font-size:0.9rem; color:var(--accent); margin-bottom:10px; font-weight:bold;">â˜ï¸ æ­£åœ¨æª¢æŸ¥ç‹€æ…‹...</div>
      
      <div class="info-row">
        <div class="input-group"><label>ğŸ“… å ±å‘Šæ—¥æœŸ</label><input type="date" id="mDateDisplay" class="global-lock" onchange="handleDateChange()"></div>
        <div class="input-group"><label>ğŸ‘¤ ä¸»å¸­</label><select id="mChair" class="global-lock"></select></div>
        <div class="input-group"><label>ğŸ“ ç´€éŒ„</label><select id="mRecorder" class="global-lock"></select></div>
      </div>
      <div class="status-row">
        <div>
          <div class="input-group"><label>ğŸ‘¥ å‡ºå¸­äººå“¡</label><select id="mAttendeeSelect" class="global-lock" onchange="addAttendee(this.value); this.value='';">
            <option value="">-- è«‹æŒ‘é¸äººå“¡ --</option>
            <option value="è˜‡æ¸…æº">è˜‡æ¸…æº</option><option value="æ›¾é›ªå¦®">æ›¾é›ªå¦®</option><option value="é»ƒå©·éˆº">é»ƒå©·éˆº</option><option value="è”¡ç­‘ç">è”¡ç­‘ç</option><option value="è•­ç¿Šç¿">è•­ç¿Šç¿</option><option value="é™³ç«è«­">é™³ç«è«­</option><option value="æå®¶æ§¿">æå®¶æ§¿</option><option value="ä¿Šç”Ÿéƒ¨é•·">ä¿Šç”Ÿéƒ¨é•·</option>
          </select></div>
          <div id="attendeeList" class="attendee-list"></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
          <div class="input-group"><label>â˜€ï¸ æ—©ç­å ±å‘Š</label><select id="mRepMorning" class="global-lock"></select></div>
          <div class="input-group"><label>â›… ä¸­ç­å ±å‘Š</label><select id="mRepAfternoon" class="global-lock"></select></div>
        </div>
      </div>
    </div>

    <div class="board" id="mainBoard">
      <div class="column" data-col="col_record">
        <div class="column-title">ğŸ“ å¹¹éƒ¨æœƒè­°ç´€éŒ„å…§å®¹</div>
        <div id="col_record" class="card-container"></div>
        <button class="global-lock" onclick="addNewCard('col_record')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer; margin-top:10px;">+ æ–°å¢æ±ºè­°</button>
      </div>
      <div class="column" data-col="col_tracking">
        <div class="column-title" style="color:#15803d">ğŸ“ è¿½è¹¤äº‹é …ç›¤é»</div>
        <div id="col_tracking" class="card-container"></div>
        <button class="global-lock" onclick="addNewCard('col_tracking')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer; margin-top:10px;">+ æ–°å¢è¿½è¹¤</button>
      </div>
      <div class="column" data-col="col_target">
        <div class="column-title" style="color:#b45309">ğŸ“ 2026å¹´åº¦ç›®æ¨™é€²åº¦</div>
        <div id="col_target" class="card-container"></div>
        <button class="global-lock" onclick="addNewCard('col_target')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer; margin-top:10px;">+ æ–°å¢é€²åº¦</button>
      </div>
    </div>
  </div>

  <div class="mini-dock" id="miniDock">
    <button class="dock-btn dock-search" data-tip="å…¨åŸŸæœå°‹" onclick="openSearchModal()">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    </button>
    <button class="dock-btn dock-theme" data-tip="åˆ‡æ›ä¸»é¡Œ" onclick="toggleTheme()">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
    </button>
    <button class="dock-btn dock-edit" data-tip="åˆ‡æ›ç·¨è¼¯æ¨¡å¼" onclick="toggleEditMode()">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 113 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
    </button>
    <button class="dock-btn dock-save" data-tip="å„²å­˜åˆ°æœ¬æ©Ÿ" onclick="saveCurrentData()">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
    </button>
    <button class="dock-btn dock-sync" id="btnCloudSync" data-tip="åŒæ­¥åˆ°é›²ç«¯" onclick="saveAndSyncToCloud()">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.5 19a3.5 3.5 0 11-5.83-2.66 7 7 0 1110.59-4.84"/><path d="M12 13v8l-3-3m6 0l-3 3"/></svg>
    </button>
  </div>

  <script>
    const CLOUD_API_URL = "https://script.google.com/macros/s/AKfycbxtfU8YUXCQyea1qh8khk1XbUN-zd1XzoGsNJcjruVThrSt3r7uW1XtzAexOK5rQ6sfiA/exec";
    const cadres = ["è˜‡æ¸…æº","æ›¾é›ªå¦®","é»ƒå©·éˆº","è”¡ç­‘ç","è•­ç¿Šç¿","é™³ç«è«­","æå®¶æ§¿","ä¿Šç”Ÿéƒ¨é•·"];
    const ownerList = ["å…¨éƒ¨","è˜‡æ¸…æº","æ›¾é›ªå¦®","é»ƒå©·éˆº","è”¡ç­‘ç","è•­ç¿Šç¿","é™³ç«è«­","æå®¶æ§¿"];
    const categoryList = ["å®¢æœ","VIP","å…¨éƒ¨"];

    let meetings = JSON.parse(localStorage.getItem('MeetingV27_Data')) || {};
    let currentDay = Object.keys(meetings).sort().reverse()[0] || new Date().toISOString().split('T')[0];

    function showToast(msg) {
      const container = document.getElementById('toast-container');
      const t = document.createElement('div');
      t.className = 'toast';
      t.innerText = msg;
      container.appendChild(t);
      setTimeout(() => t.remove(), 2500);
    }

    setInterval(() => {
      if(document.body.getAttribute('data-edit') === 'true') {
        saveCurrentToVariable();
      }
    }, 30000);

    window.addEventListener('beforeunload', (e) => {
      if(document.body.getAttribute('data-edit') === 'true') {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    async function fetchCloudData(){
      const status = document.getElementById('syncStatus');
      try{
        const res = await fetch(CLOUD_API_URL, { mode:'cors' });
        const data = await res.json();
        if(data && Object.keys(data).length > 0){
          meetings = data;
          status.innerText = "â˜ï¸ é›²ç«¯åŒæ­¥å®Œæˆ";
          localStorage.setItem('MeetingV27_Data', JSON.stringify(meetings));
          refreshSidebar();
          loadMeeting(currentDay);
        }
      }catch(e){ status.innerText = "âš ï¸ ä½¿ç”¨æœ¬åœ°æš«å­˜ (é›²ç«¯æœªé€£ç·š)"; }
    }

    async function saveAndSyncToCloud(){
      saveCurrentToVariable();
      const status = document.getElementById('syncStatus');
      status.innerText = "â³ åŒæ­¥ä¸­...";
      try{
        await fetch(CLOUD_API_URL, { method:'POST', body:JSON.stringify(meetings), mode:'cors' });
        showToast("âœ… åŒæ­¥æˆåŠŸ");
        status.innerText = "â˜ï¸ é›²ç«¯åŒæ­¥å®Œæˆ";
      }catch(e){ showToast("âŒ åŒæ­¥å¤±æ•—"); }
    }

    function init(){
      ['mChair','mRecorder','mRepMorning','mRepAfternoon'].forEach(id=>{
        const el = document.getElementById(id); el.add(new Option('', ''));
        cadres.forEach(name=>{ if(name!=='ä¿Šç”Ÿéƒ¨é•·') el.add(new Option(name, name)); });
      });
      fetchCloudData().then(() => {
        refreshSidebar();
        loadMeeting(currentDay);
        updateLocks();
        initDragAndDrop();
      });
    }

    function refreshSidebar(){
      const bar = document.getElementById('dateSidebar');
      Array.from(bar.querySelectorAll('.side-icon:not(.side-add)')).forEach(el=>el.remove());
      Object.keys(meetings).sort().reverse().forEach(date=>{
        const btn = document.createElement('div');
        btn.className = `side-icon ${date===currentDay ? 'active' : ''}`;
        btn.innerText = date.split('-').slice(1).join('/');
        btn.title = date;
        btn.onclick = () => loadMeeting(date);
        bar.insertBefore(btn, bar.lastElementChild);
      });
    }

    function loadMeeting(date){
      currentDay = date;
      if(!meetings[date]) meetings[date] = { attendees:[], cards:{col_record:[], col_tracking:[], col_target:[]} };
      
      const data = meetings[date];
      document.getElementById('mDateDisplay').value = date;
      document.getElementById('mChair').value = data.chair || '';
      document.getElementById('mRecorder').value = data.recorder || '';
      document.getElementById('mRepMorning').value = data.morning || '';
      document.getElementById('mRepAfternoon').value = data.afternoon || '';

      const list = document.getElementById('attendeeList');
      list.innerHTML = ""; (data.attendees || []).forEach(n=>renderAttendee(n));

      ['col_record','col_tracking','col_target'].forEach(id=>{
        const cont = document.getElementById(id); cont.innerHTML = "";
        (data.cards[id] || []).forEach(c=>addNewCard(id, c));
      });
      refreshSidebar();
      updateLocks();
      checkEmptyState();
      collapseAllCards();
    }

    function checkEmptyState() {
      const mainBoard = document.getElementById('mainBoard');
      const existing = document.getElementById('empty-msg');
      const hasCards = document.querySelectorAll('.card').length > 0;
      if (!hasCards) {
        if (!existing) {
          const div = document.createElement('div');
          div.id = 'empty-msg';
          div.className = 'empty-placeholder';
          div.innerHTML = `<h3>â˜• å°šæœªéŒ„å…¥ç´€éŒ„</h3><p>æ­¤æ—¥æœŸç›®å‰æ˜¯ç©ºçš„ã€‚é»æ“Šå³ä¸‹è§’ã€Œæ©˜è‰²ç·¨è¼¯æŒ‰éˆ•ã€å¾Œå³å¯é–‹å§‹æ–°å¢é …ç›®ï¼</p>`;
          mainBoard.appendChild(div);
        }
      } else if (existing) {
        existing.remove();
      }
    }

    function addNewCard(colId, data=null){
      const col = document.getElementById(colId);
      const card = document.createElement('div'); 
      card.className='card';
      card.draggable = true;
      
      const d = data || { title:'', desc:'', cat:'å…¨éƒ¨', owner:'å…¨éƒ¨', keep:true, priority: 'mid' };
      const keepCheck = colId==='col_tracking' ? `<label class="meta-label"><input type="checkbox" class="m-keep" ${d.keep?'checked':''}>ä¿ç•™</label>` : '<div></div>';
      
      card.innerHTML = `
        <div class="del-x" style="position:absolute; top:10px; right:15px;" onclick="this.parentElement.remove(); checkEmptyState();">âœ•</div>
        <textarea class="c-title" placeholder="æ¨™é¡Œ">${d.title}</textarea>
        <textarea class="c-desc" placeholder="å…§å®¹...">${d.desc}</textarea>
        <div class="expand-btn" onclick="toggleExpand(this)">â–¼ å±•é–‹</div>
        <div class="card-meta">
          <div class="meta-item">
            <span class="meta-label">å„ªå…ˆ:</span>
            <select class="p-tag p-${d.priority||'mid'}" onchange="this.className='p-tag p-'+this.value">
              <option value="high" ${d.priority==='high'?'selected':''}>é«˜</option>
              <option value="mid" ${d.priority==='mid'?'selected':''}>ä¸­</option>
              <option value="low" ${d.priority==='low'?'selected':''}>ä½</option>
            </select>
          </div>
          <div class="meta-item">
            <span class="meta-label">åˆ†é¡:</span>
            <select class="m-cat meta-select">
              ${categoryList.map(c => `<option ${d.cat===c?'selected':''}>${c}</option>`).join('')}
            </select>
          </div>
          <div class="meta-item">
            <span class="meta-label">è² è²¬:</span>
            <select class="m-own meta-select">
              ${ownerList.map(o=>`<option ${d.owner===o?'selected':''}>${o}</option>`).join('')}
            </select>
          </div>
          <div class="meta-item">${keepCheck}</div>
        </div>`;
      
      col.appendChild(card);
      const desc = card.querySelector('.c-desc');
      desc.addEventListener('input', ()=> autoResizeTextarea(desc));
      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragend', handleDragEnd);

      updateLocks();
      resetTextareaToCollapsed(desc);
      checkEmptyState();
    }

    let draggedItem = null;
    function handleDragStart(e) {
      if(document.body.getAttribute('data-edit') !== 'true') { e.preventDefault(); return; }
      draggedItem = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    function handleDragEnd() {
      this.classList.remove('dragging');
      document.querySelectorAll('.column').forEach(c => c.classList.remove('drag-over'));
      draggedItem = null;
    }
    function initDragAndDrop() {
      const columns = document.querySelectorAll('.column');
      columns.forEach(col => {
        col.addEventListener('dragover', e => { e.preventDefault(); col.classList.add('drag-over'); });
        col.addEventListener('dragleave', () => col.classList.remove('drag-over'));
        col.addEventListener('drop', e => {
          e.preventDefault();
          const targetColId = col.dataset.col;
          const container = document.getElementById(targetColId);
          container.appendChild(draggedItem);
          showToast("å·²ç§»å‹•ä½ç½®");
        });
      });
    }

    function saveCurrentToVariable(){
      const getCards = id => Array.from(document.getElementById(id).querySelectorAll('.card')).map(c=>({
        title: c.querySelector('.c-title').value,
        desc: c.querySelector('.c-desc').value,
        cat: c.querySelector('.m-cat').value,
        owner: c.querySelector('.m-own').value,
        keep: c.querySelector('.m-keep')?.checked,
        priority: c.querySelector('.p-tag').value
      }));
      meetings[currentDay] = {
        chair: document.getElementById('mChair').value,
        recorder: document.getElementById('mRecorder').value,
        morning: document.getElementById('mRepMorning').value,
        afternoon: document.getElementById('mRepAfternoon').value,
        attendees: Array.from(document.querySelectorAll('.tag')).map(t=>t.dataset.name),
        cards: { col_record:getCards('col_record'), col_tracking:getCards('col_tracking'), col_target:getCards('col_target') }
      };
      localStorage.setItem('MeetingV27_Data', JSON.stringify(meetings));
    }

    function saveCurrentData(){ saveCurrentToVariable(); showToast("âœ… æœ¬åœ°å„²å­˜æˆåŠŸ"); toggleEditMode(); }

    function renderAttendee(name){
      const list = document.getElementById('attendeeList');
      const tag = document.createElement('div'); tag.className='tag'; tag.dataset.name=name;
      tag.innerHTML = `<span>${name}</span><span class="del-x" onclick="this.parentElement.remove()">âœ•</span>`;
      list.appendChild(tag);
    }
    
    function addAttendee(name){ if(name) renderAttendee(name); }
    
    function toggleEditMode(){
      const isEdit = document.body.getAttribute('data-edit') === 'true';
      document.body.setAttribute('data-edit', !isEdit);
      showToast(!isEdit ? "ğŸ”“ ç·¨è¼¯æ¨¡å¼å·²é–‹å•Ÿ" : "ğŸ”’ ç·¨è¼¯æ¨¡å¼å·²é—œé–‰");
      updateLocks();
    }

    function updateLocks(){
      const isEdit = document.body.getAttribute('data-edit') === 'true';
      document.querySelectorAll('.global-lock, .card textarea, .card select, .m-keep, .p-tag').forEach(el=>el.disabled = !isEdit);
    }

    function toggleExpand(btn){
      const desc = btn.parentElement.querySelector('.c-desc');
      if(!desc) return;
      if(desc.classList.toggle('expanded')){ autoResizeTextarea(desc); btn.innerText = "â–² æ”¶åˆ"; }
      else{ resetTextareaToCollapsed(desc); btn.innerText = "â–¼ å±•é–‹"; }
    }

    function autoResizeTextarea(el){
      el.classList.add('expanded');
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight) + 'px';
    }

    function resetTextareaToCollapsed(el){
      el.classList.remove('expanded');
      el.style.height = '56px';
    }

    function expandAllCards(){
      document.querySelectorAll('.card .c-desc').forEach(desc=>{
        autoResizeTextarea(desc);
        const btn = desc.parentElement.querySelector('.expand-btn');
        if(btn) btn.innerText = "â–² æ”¶åˆ";
      });
    }

    function collapseAllCards(){
      document.querySelectorAll('.card .c-desc').forEach(desc=>{
        resetTextareaToCollapsed(desc);
        const btn = desc.parentElement.querySelector('.expand-btn');
        if(btn) btn.innerText = "â–¼ å±•é–‹";
      });
    }

    let searchTimer;
    function debouncedSearch(){
      clearTimeout(searchTimer);
      searchTimer = setTimeout(performGlobalSearch, 300);
    }

    function performGlobalSearch(){
      const q = document.getElementById('globalSearchInput').value.toLowerCase();
      const resBox = document.getElementById('searchResults');
      resBox.innerHTML = "";
      if(!q) return;

      Object.keys(meetings).forEach(date=>{
        const m = meetings[date];
        const allCards = [...m.cards.col_record, ...m.cards.col_tracking, ...m.cards.col_target];
        allCards.forEach(c=>{
          if(c.title.toLowerCase().includes(q) || c.desc.toLowerCase().includes(q)){
            const item = document.createElement('div');
            item.style = "padding:10px; border-bottom:1px solid var(--border); cursor:pointer";
            item.innerHTML = `<strong>[${date}] ${c.title}</strong><div style="font-size:0.8rem; color:var(--text-muted)">${c.desc.substring(0,30)}...</div>`;
            item.onclick = () => { loadMeeting(date); closeSearchModal(); };
            resBox.appendChild(item);
          }
        });
      });
    }

    function openSearchModal(){ document.getElementById('searchModal').style.display='flex'; }
    function closeSearchModal(){ document.getElementById('searchModal').style.display='none'; }
    function openModal(){ document.getElementById('dateModal').style.display='flex'; }
    function closeModal(){ document.getElementById('dateModal').style.display='none'; }
    function confirmNewMeeting(){
      const d = document.getElementById('newMeetingDate').value;
      if(d){ loadMeeting(d); closeModal(); showToast("å·²å»ºç«‹æ–°æ—¥æœŸé …ç›®"); }
    }
    function handleDateChange(){ loadMeeting(document.getElementById('mDateDisplay').value); }
    function toggleTheme(){
      const b = document.body;
      const target = b.getAttribute('data-theme')==='dark'?'light':'dark';
      b.setAttribute('data-theme', target);
    }

    window.onload = init;
  </script>
</body>
</html>
