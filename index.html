<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å®¢æœæœƒè­°ç®¡ç†ç³»çµ± 27.1 - å±•é–‹æ”¶åˆ + é›²ç«¯åŒæ­¥</title>
  <style>
    :root {
      --bg: #f1f5f9; --card-bg: #ffffff; --text-main: #0f172a; --text-muted: #64748b;
      --border: #e2e8f0; --sidebar-bg: #ffffff; --accent: #0284c7; --input-bg: #f8fafc;

      /* âœ… FAB èˆ‡å…§å®¹åº•éƒ¨å®‰å…¨é–“è·ï¼ˆä¸è¦å†ç”¨å›ºå®š 120pxï¼‰ */
      --fab-size: 52px;              /* ä¸»æŒ‰éˆ•ç›´å¾‘ */
      --fab-gap:  12px;              /* èˆ‡é‚Šç·£è·é›¢ */
      --fab-safe: calc(var(--fab-size) + var(--fab-gap) + 8px); /* å…§å®¹åº•éƒ¨æœ€å°ç•™ç™½ */
    }
    [data-theme="dark"] {
      --bg: #0f172a; --card-bg: #1e293b; --text-main: #f8fafc; --text-muted: #94a3b8;
      --border: #334155; --sidebar-bg: #1e293b; --accent: #38bdf8; --input-bg: #0f172a;
    }

    /* ====== å­—é«”å¤§å°è¦ç¯„ ====== */
    html { font-size: 18px; }              /* å…¶ä»–é è¨­ 18px */
    body, input, select, textarea, button { font-size: 18px; }

    * { box-sizing: border-box; transition: 0.2s ease; }
    body {
      font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg); color: var(--text-main);
      margin: 0; display: flex; height: 100vh; overflow: hidden;
    }

    /* å´é‚Šæ¬„ */
    .sidebar { width: 80px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 20px 0; overflow-y: auto; flex-shrink: 0; }
    .side-icon { width: 50px; height: 50px; border-radius: 12px; background: var(--bg); margin-bottom: 15px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border); color: var(--text-muted); font-size: 1rem; text-align: center; }
    .side-icon.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .side-add { border: 2px dashed var(--text-muted); font-size: 1.5rem; }

    .main {
      flex: 1; padding: 25px; display: flex; flex-direction: column; overflow-x: hidden;
      /* âŒ ä¸å†ä½¿ç”¨å›ºå®š padding-bottomï¼Œæ”¹ç”± .board::after æä¾›å‹•æ…‹å®‰å…¨é–“è· */
    }
    .header-section { background: var(--card-bg); border-radius: 20px; padding: 20px; margin-bottom: 25px; border: 1px solid var(--border); }

    .info-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 10px; }
    .status-row { display: grid; grid-template-columns: 1fr 450px; gap: 25px; padding-top: 15px; border-top: 1px solid var(--border); }

    .input-group label { display: block; color: var(--text-muted); margin-bottom: 6px; font-weight: bold; font-size: 18px; }
    .input-group select, .input-group input { background: var(--input-bg); border: 1px solid var(--border); color: var(--text-main); padding: 10px; border-radius: 8px; width: 100%; outline: none; }
    .input-group select:disabled, .input-group input:disabled { opacity: 0.7; cursor: not-allowed; }

    .attendee-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; min-height: 42px; padding: 6px; background: var(--input-bg); border-radius: 10px; border: 1px dashed var(--border); }
    .tag { background: rgba(56, 189, 248, 0.1); color: var(--accent); padding: 5px 14px; border-radius: 50px; font-size: 1rem; border: 1px solid var(--accent); display: flex; align-items: center; gap: 8px; font-weight: bold; }

    .del-x { cursor: pointer; color: #ef4444; font-weight: bold; display: none; margin-left: 5px; }
    body[data-edit="true"] .del-x { display: inline-block !important; }

    .board { display: flex; flex-wrap: wrap; gap: 20px; flex: 1; overflow-y: auto; align-content: flex-start; }
    .board::after{
      /* âœ… ç”¨å½å…ƒç´ ç•™å‡ºèˆ‡ FAB å¤§å°ç›¸ç¬¦çš„å®‰å…¨é–“è·ï¼Œé¿å…è¢«æ“‹ä½†ä¸è£½é€ å¤§ç™½å¸¶ */
      content:""; display:block; width:100%; height: var(--fab-safe);
      /* å’ŒèƒŒæ™¯åŒè‰²ï¼Œçœ‹èµ·ä¾†å°±æ˜¯æ­£å¸¸åº•éƒ¨ï¼›ä¸æœƒåƒå›ºå®š 120px é‚£æ¨£èª‡å¼µ */
    }
    .column { background: rgba(0,0,0,0.02); border-radius: 20px; flex: 1 1 350px; padding: 20px; display: flex; flex-direction: column; border: 1px solid var(--border); min-height: 450px; }
    .column-title { font-weight: bold; margin-bottom: 20px; color: var(--accent); border-bottom: 2px solid var(--accent); padding-bottom: 8px; font-size: 20px; } /* æ¨™é¡Œ 20px */

    /* å¡ç‰‡ & å±•é–‹ */
    .card { background: var(--card-bg); border-radius: 15px; padding: 18px; margin-bottom: 15px; border: 1px solid var(--border); position: relative; display: flex; flex-direction: column; }
    .card textarea { width: 100%; background: transparent; border: none; color: var(--text-main); resize: none; font-family: inherit; outline: none; line-height: 1.6; }
    .card textarea:disabled { color: var(--text-main); opacity: 1; cursor: default; }

    .card .c-title { font-size: 1rem; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 5px; min-height: 35px; }
    .card .c-desc { font-size: 1rem; height: 65px; overflow: hidden; transition: height 0.3s ease-in-out; margin-bottom: 5px; }
    .card .c-desc.expanded { overflow: visible; }

    .expand-btn { font-size: 1rem; color: var(--accent); text-align: center; cursor: pointer; padding: 4px; margin-top: auto; border-top: 1px dashed var(--border); font-weight: bold; user-select: none; opacity: 0.8; }
    .expand-btn:hover { opacity: 1; background: rgba(0,0,0,0.02); }

    .card-meta { display: flex; align-items: center; gap: 10px; margin-top: 5px; padding-top: 10px; border-top: 1px solid var(--border); flex-wrap: wrap; }
    .meta-item { display: flex; align-items: center; gap: 5px; flex: 1; min-width: 140px; }
    .meta-label { color: var(--text-muted); font-weight: bold; white-space: nowrap; font-size: 18px; }
    .meta-select { background: var(--input-bg); border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; font-size: 1rem; padding: 4px; flex: 1; cursor: pointer; }
    .meta-select:disabled { cursor: not-allowed; opacity: 0.8; color: var(--text-main); }

    .add-btn-locked { opacity: 0.5; cursor: not-allowed !important; pointer-events: none; }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
    .modal-content { background: var(--card-bg); padding: 30px; border-radius: 20px; width: 320px; text-align: center; }
    .modal-content h3 { font-size: 20px; margin: 0 0 10px; color: var(--accent); } /* æ¨™é¡Œ 20px */

    /* ====== å±•é–‹å¼ FAB Dockï¼ˆå«ä¸»é¡Œåˆ‡æ›ï¼‰ ====== */
    .fab-dock { position: fixed; bottom: var(--fab-gap); right: var(--fab-gap); z-index: 900; }
    .fab-main {
      width: var(--fab-size); height: var(--fab-size); border-radius: 50%;
      background: #0ea5e9; color: #fff; border: none; cursor: pointer;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      font-weight: 900; font-size: 1.1rem;
      transform: scale(0.96); opacity: .95;
    }
    .fab-main:hover { transform: scale(1.0); opacity: 1; }
    .fab-items {
      position: absolute; bottom: calc(var(--fab-size) + 8px); right: 0;
      display: grid; gap: 8px;
      pointer-events: none; /* é è¨­ä¸å¯é»ï¼Œå±•é–‹æ™‚å¯é» */
    }
    .fab-item {
      padding: 8px 14px; border-radius: 12px; border: none; cursor: pointer;
      color: #fff; font-weight: 700; font-size: .9rem;
      box-shadow: 0 6px 12px rgba(0,0,0,0.18);
      transform: translateY(8px) scale(.9); opacity: 0;
      transition: transform .18s ease, opacity .18s ease;
      display: flex; align-items: center; gap: 8px;
    }
    .fab-item.theme { background: #64748b; } /* ğŸŒ— ä¸»é¡Œåˆ‡æ› */
    .fab-item.edit  { background: #f59e0b; }
    .fab-item.save  { background: #0284c7; }
    .fab-item.sync  { background: #0ea5e9; }
    .fab-item:disabled { opacity: .6; cursor: not-allowed; }

    .fab-dock.open .fab-items { pointer-events: auto; }
    .fab-dock.open .fab-item { transform: translateY(0) scale(1); opacity: 1; }
    .fab-dock.open .fab-item:nth-child(1) { transition-delay: .00s; }
    .fab-dock.open .fab-item:nth-child(2) { transition-delay: .03s; }
    .fab-dock.open .fab-item:nth-child(3) { transition-delay: .06s; }
    .fab-dock.open .fab-item:nth-child(4) { transition-delay: .09s; }

    /* ğŸ“± å°è¢å¹•æ™‚ï¼Œå¤šç•™ä¸€é»åº•éƒ¨ç·©è¡ */
    @media (max-height: 740px) {
      :root { --fab-safe: calc(var(--fab-size) + var(--fab-gap) + 24px); }
    }
  </style>
</head>
<body data-theme="light" data-edit="false">

  <!-- æ—¥æœŸå»ºç«‹ -->
  <div class="modal-overlay" id="dateModal">
    <div class="modal-content">
      <h3>ğŸ“… é¸æ“‡æ–°æœƒè­°æ—¥æœŸ</h3>
      <input type="date" id="newMeetingDate" style="padding:8px;">
      <br>
      <button onclick="confirmNewMeeting()" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:50px; margin-top:15px; cursor:pointer;">å»ºç«‹å ±å‘Š</button>
      <p style="cursor:pointer; font-size:0.9rem; color:var(--text-muted);" onclick="closeModal()">å–æ¶ˆ</p>
    </div>
  </div>

  <div class="sidebar" id="dateSidebar">
    <div class="side-icon side-add" id="btnSideAdd" onclick="openModal()">+</div>
  </div>

  <div class="main">
    <div class="header-section">
      <!-- é›²ç«¯ç‹€æ…‹åˆ— -->
      <div id="syncStatus" style="font-size:0.9rem; color:var(--accent); margin-bottom:10px;">â˜ï¸ æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</div>

      <div class="info-row">
        <div class="input-group">
          <label>ğŸ“… å ±å‘Šæ—¥æœŸ</label>
          <input type="date" id="mDateDisplay" class="global-lock" onfocus="onDateFocus()" onchange="handleDateChange()" style="font-weight:bold; color:var(--accent);" />
        </div>
        <div class="input-group"><label>ğŸ‘¤ ä¸»å¸­</label><select id="mChair" class="global-lock"></select></div>
        <div class="input-group"><label>ğŸ“ ç´€éŒ„</label><select id="mRecorder" class="global-lock"></select></div>
      </div>

      <div class="status-row">
        <div class="attendance-section">
          <div class="input-group">
            <label>ğŸ‘¥ å‡ºå¸­äººå“¡ (éœ€è§£é–å¾Œæ–°å¢)</label>
            <select id="mAttendeeSelect" class="global-lock" onchange="addAttendee(this.value); this.value='';">
              <option value="">-- è«‹æŒ‘é¸äººå“¡ --</option>
              <option value="è˜‡æ¸…æº">è˜‡æ¸…æº</option><option value="æ›¾é›ªå¦®">æ›¾é›ªå¦®</option>
              <option value="é»ƒå©·éˆº">é»ƒå©·éˆº</option><option value="è”¡ç­‘ç">è”¡ç­‘ç</option>
              <option value="è•­ç¿Šç¿">è•­ç¿Šç¿</option><option value="é™³ç«è«­">é™³ç«è«­</option>
              <option value="æå®¶æ§¿">æå®¶æ§¿</option><option value="ä¿Šç”Ÿéƒ¨é•·">ä¿Šç”Ÿéƒ¨é•·</option>
            </select>
          </div>
          <div id="attendeeList" class="attendee-list"></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
          <div class="input-group" style="border-left:4px solid var(--accent); padding-left:12px;"><label>â˜€ï¸ æ—©ç­å ±å‘Š</label><select id="mRepMorning" class="global-lock"></select></div>
          <div class="input-group" style="border-left:4px solid #15803d; padding-left:12px;"><label>â›… ä¸­ç­å ±å‘Š</label><select id="mRepAfternoon" class="global-lock"></select></div>
        </div>
      </div>
    </div>

    <div class="board">
      <div class="column">
        <div class="column-title">ğŸ“ å¹¹éƒ¨æœƒè­°ç´€éŒ„å…§å®¹</div>
        <div id="col_record"></div>
        <button class="add-btn global-lock" onclick="addNewCard('col_record')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer; color:var(--text-muted);">+ æ–°å¢æ±ºè­°</button>
      </div>
      <div class="column">
        <div class="column-title" style="color:#15803d">ğŸ“ è¿½è¹¤äº‹é …ç›¤é»</div>
        <div id="col_tracking"></div>
        <button class="add-btn global-lock" onclick="addNewCard('col_tracking')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer; color:var(--text-muted);">+ æ–°å¢è¿½è¹¤</button>
      </div>
      <div class="column">
        <div class="column-title" style="color:#b45309">ğŸ“ 2026å¹´åº¦ç›®æ¨™é€²åº¦</div>
        <div id="col_target"></div>
        <button class="add-btn global-lock" onclick="addNewCard('col_target')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer; color:var(--text-muted);">+ æ–°å¢é€²åº¦</button>
      </div>
    </div>
  </div>

  <!-- âœ… å±•é–‹å¼ FAB Dockï¼ˆä¸»æŒ‰éˆ• + å››é¡†å­æŒ‰éˆ•ï¼‰ -->
  <div class="fab-dock" id="fabDock">
    <button class="fab-main" id="fabMain" aria-expanded="false" aria-controls="fabItems" onclick="toggleFabDock()">â˜°</button>
    <div class="fab-items" id="fabItems" role="menu" aria-label="å¿«é€Ÿå‹•ä½œ">
      <button class="fab-item theme" role="menuitem" onclick="closeFabDock(); toggleTheme()">ğŸŒ— åˆ‡æ›é»‘/ç™½ä¸»é¡Œ</button>
      <button class="fab-item edit"  role="menuitem" onclick="closeFabDock(); toggleEditMode()">ğŸ”’ é–‹å•Ÿ/é€€å‡ºç·¨è¼¯</button>
      <button class="fab-item save"  role="menuitem" onclick="closeFabDock(); saveCurrentData()">ğŸ’¾ å„²å­˜åˆ°æœ¬æ©Ÿ</button>
      <button class="fab-item sync"  role="menuitem" id="btnCloudSync" onclick="closeFabDock(); saveAndSyncToCloud()">ğŸ’¾â˜ï¸ å„²å­˜ä¸¦åŒæ­¥</button>
    </div>
  </div>

  <script>
    /* ------------------------  æ—¢æœ‰åŠŸèƒ½ä¿ç•™  ------------------------ */

    // ====== é›²ç«¯ API ======
    const CLOUD_API_URL = "https://script.google.com/macros/s/AKfycbxtfU8YUXCQyea1qh8khk1XbUN-zd1XzoGsNJcjruVThrSt3r7uW1XtzAexOK5rQ6sfiA/exec";

    const ownerList = ["å…¨éƒ¨", "è˜‡æ¸…æº", "æ›¾é›ªå¦®", "é»ƒå©·éˆº", "è”¡ç­‘ç", "è•­ç¿Šç¿", "é™³ç«è«­", "æå®¶æ§¿"];
    const categoryList = ["å®¢æœ", "VIP", "å…¨éƒ¨"];
    const cadres = ["è˜‡æ¸…æº", "æ›¾é›ªå¦®", "é»ƒå©·éˆº", "è”¡ç­‘ç", "è•­ç¿Šç¿", "é™³ç«è«­", "æå®¶æ§¿", "ä¿Šç”Ÿéƒ¨é•·"];

    let meetings = JSON.parse(localStorage.getItem('MeetingV27_Data')) || {
      "2026-01-14": {
        attendees: [], chair:"è•­ç¿Šç¿", recorder:"é™³ç«è«­", morning:"è˜‡æ¸…æº", afternoon:"æ›¾é›ªå¦®",
        cards: { col_record: [], col_tracking: [], col_target: [] },
        meta: { recordSeeded: true, trackingSeeded: true }
      }
    };
    let currentDay = Object.keys(meetings).sort().reverse()[0] || "2026-01-14";
    let hasUnsaved = false;
    let _movedRecordToTracking = false; // æœ¬æ¬¡æ˜¯å¦æŠŠå·¦æ¬„ç§»åˆ°è¿½è¹¤ï¼ˆåŒæ­¥å¾Œæ¸…ç©ºå·¦æ¬„ï¼‰

    /* ===== é¦–æ¬¡é–‹å•Ÿï¼šå°‡æ‰€æœ‰å¯æ»¾å‹•å€å¡Šèˆ‡ textarea æ²åˆ°é ‚ç«¯ ===== */
    function scrollAllScrollableToTop() {
      try { if ('scrollRestoration' in history) history.scrollRestoration = 'manual'; } catch {}
      window.scrollTo(0, 0);
      const selectors = ['.sidebar', '#dateSidebar', '.main', '.board', '.column'];
      selectors.forEach(sel => document.querySelectorAll(sel).forEach(el => { try { el.scrollTop = 0; } catch {} }));
      document.querySelectorAll('textarea').forEach(ta => { try { ta.scrollTop = 0; } catch {} });
    }
    function scrollAllScrollableToTopDeferred() { requestAnimationFrame(scrollAllScrollableToTop); }

    function init() {
      // ä¸‹æ‹‰é¸å–®ï¼šå››å€‹æ¬„ä½å…ˆæ’å…¥ä¸€å€‹ç©ºç™½
      ['mChair','mRecorder','mRepMorning','mRepAfternoon'].forEach(id => {
        const el = document.getElementById(id);
        el.add(new Option('', '')); // å¯é¸ç©ºç™½
        cadres.forEach(name => { if (name !== 'ä¿Šç”Ÿéƒ¨é•·') el.add(new Option(name, name)); });
      });

      // æ–°å¢æ—¥æœŸ modal é è¨­å€¼
      const input = document.getElementById('newMeetingDate');
      if (input) {
        const today = new Date(); const yyyy = today.getFullYear(); const mm = String(today.getMonth()+1).padStart(2,'0'); const dd = String(today.getDate()).padStart(2,'0');
        input.value = `${yyyy}-${mm}-${dd}`;
        input.min = "2024-01-01";
      }

      // å…ˆæŠ“é›²ç«¯ï¼ˆå¤±æ•—ç”¨æœ¬åœ°ï¼‰
      fetchCloudData().then(() => {
        currentDay = Object.keys(meetings).sort().reverse()[0] || currentDay;
        refreshSidebar(); loadMeeting(currentDay);
        updateLocks(); bindDirtyWatcher(); scrollAllScrollableToTopDeferred();
      });

      window.addEventListener('pageshow', (e) => { if (e.persisted) scrollAllScrollableToTopDeferred(); });
      window.addEventListener('beforeunload', (e) => { if (hasUnsaved) { e.preventDefault(); e.returnValue = ''; } });

      // FAB Dockï¼šé»å¤–é¢å°±æ”¶åˆ
      document.addEventListener('click', (ev) => {
        const dock = document.getElementById('fabDock');
        if (!dock) return;
        if (!dock.contains(ev.target)) { dock.classList.remove('open'); setFabAria(false); }
      });
    }

    /* ===== é›²ç«¯è®€å– ===== */
    async function fetchCloudData() {
      const status = document.getElementById('syncStatus');
      const controller = new AbortController(); const timer = setTimeout(() => controller.abort(), 15000);
      try {
        const res = await fetch(CLOUD_API_URL, { signal: controller.signal, mode: 'cors', credentials: 'omit' });
        clearTimeout(timer);
        if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
        const data = await res.json();
        if (data && Object.keys(data).length > 0) {
          meetings = data;
          status.innerText = "â˜ï¸ é›²ç«¯åŒæ­¥å®Œæˆ";
          try { localStorage.setItem('MeetingV27_Data', JSON.stringify(meetings)); } catch {}
          return;
        }
        throw new Error('ç©ºè³‡æ–™');
      } catch (e) {
        clearTimeout(timer);
        console.warn('é›²ç«¯æŠ“å–å¤±æ•—ï¼Œæ”¹è¼‰å…¥æœ¬åœ°å‚™ä»½ï¼š', e);
        const backup = localStorage.getItem('MeetingV27_Data');
        if (backup) { meetings = JSON.parse(backup); status.innerText = "ğŸ’¾ å·²è¼‰å…¥æœ¬åœ°å‚™ä»½ (é›²ç«¯æœªé€£ç·š)"; }
        else { status.innerText = "âš ï¸ ä½¿ç”¨æœ¬åœ°æš«å­˜ (å°šæœªåŒæ­¥)"; }
      }
    }

    /* ===== å„²å­˜ ä¸¦ åŒæ­¥è‡³é›²ç«¯ï¼ˆæŒ‰éˆ•ä¸»æµç¨‹ï¼‰ ===== */
    async function saveAndSyncToCloud() {
      // å…ˆã€Œå„²å­˜åˆ°æœ¬æ©Ÿè®Šæ•¸ + localStorageã€
      saveCurrentToVariable();

      // åŒæ­¥æœŸé–“åœç”¨æŒ‰éˆ•ï¼Œé¿å…é‡è¤‡ç™¼é€
      const btn = document.getElementById('btnCloudSync');
      if (btn) { btn.disabled = true; btn.textContent = 'â³ æ­£åœ¨å„²å­˜ä¸¦åŒæ­¥...'; }

      try {
        await syncToCloud(); // é€åˆ°é›²ç«¯ï¼ˆå…§å« payload æº–å‚™èˆ‡å·¦æ¬„æ¸…ç©ºé‚è¼¯ï¼‰
      } finally {
        // å¾©åŸæŒ‰éˆ•
        if (btn) { btn.disabled = false; btn.textContent = 'ğŸ’¾â˜ï¸ å„²å­˜ä¸¦åŒæ­¥'; }
      }
    }

    /* ===== é›²ç«¯ä¸Šå‚³ï¼ˆsimple request é¿å…é æª¢ï¼‰ =====
       è‹¥æœ¬æ¬¡æœ‰ç§»åˆ°è¿½è¹¤ï¼Œé€å‡º payload æ™‚æ¸…ç©ºç•¶å¤© col_recordï¼Œ
       åŒæ­¥æˆåŠŸå¾Œæœ¬æ©Ÿä¹Ÿæ¸…ç©ºï¼Œä¸¦æŠŠ meta.recordSeeded = trueï¼ˆè¡¨ç¤ºå·²æ˜ç¢ºåˆå§‹åŒ–/æ¸…ç©ºï¼‰ã€‚ */
    async function syncToCloud() {
      // ä»¥ç›®å‰ meetings ç‚ºåŸºæº–æº–å‚™ payload
      const payload = JSON.parse(JSON.stringify(meetings));
      if (_movedRecordToTracking && payload[currentDay]?.cards) {
        payload[currentDay].cards.col_record = [];
        payload[currentDay].meta = payload[currentDay].meta || {};
        payload[currentDay].meta.recordSeeded = true; // é¿å…ä¹‹å¾Œå†è¢«ç¹¼æ‰¿
      }

      const status = document.getElementById('syncStatus');
      status.innerText = "â³ æ­£åœ¨åŒæ­¥è‡³é›²ç«¯...";
      const controller = new AbortController(); const timer = setTimeout(() => controller.abort(), 15000);

      try {
        const res = await fetch(CLOUD_API_URL, {
          method: 'POST',
          body: JSON.stringify(payload),     // ä¸å¸¶ Content-Type â†’ simple request
          signal: controller.signal,
          mode: 'cors',
          credentials: 'omit'
        });
        clearTimeout(timer);
        if (!res.ok) {
          const txt = await res.text().catch(()=> ''); throw new Error(`HTTP ${res.status} ${res.statusText} ${txt}`);
        }
        const text = await res.text();
        alert("âœ… " + text);
        status.innerText = "â˜ï¸ é›²ç«¯åŒæ­¥å®Œæˆ";

        // åŒæ­¥æˆåŠŸå¾ŒåŒæ­¥æœ¬æ©Ÿç‹€æ…‹
        if (_movedRecordToTracking && meetings[currentDay]?.cards) {
          meetings[currentDay].cards.col_record = [];
          meetings[currentDay].meta = meetings[currentDay].meta || {};
          meetings[currentDay].meta.recordSeeded = true; // å·²æ¸…ç©ºï¼å·²åˆå§‹åŒ–
          _movedRecordToTracking = false;
          loadMeeting(currentDay); // ç«‹åˆ»é‡ç¹ªå·¦æ¬„ç‚ºç©º
        }

        try { localStorage.setItem('MeetingV27_Data', JSON.stringify(meetings)); } catch {}
        if (document.body.getAttribute('data-edit') === 'true') toggleEditMode();
      } catch (e) {
        clearTimeout(timer);
        console.error(e);
        let msg = "âŒ åŒæ­¥å¤±æ•—ã€‚";
        if (e.name === 'AbortError') msg += "ï¼ˆé€¾æ™‚æœªå›æ‡‰ï¼‰";
        else if (String(e).includes('TypeError') || String(e.message).includes('Failed to fetch')) msg += "ï¼ˆCORS/æ¬Šé™æˆ–ç¶²è·¯è¢«é˜»æ“‹ï¼‰";
        alert(msg + " è©³ç´°ï¼š" + (e.message || e));
        status.innerText = "âš ï¸ ä½¿ç”¨æœ¬åœ°æš«å­˜ (å°šæœªåŒæ­¥)";
      }
    }

    /* ===== ç·¨è¼¯é– ===== */
    function toggleEditMode() {
      const isEdit = document.body.getAttribute('data-edit') === 'true';
      document.body.setAttribute('data-edit', !isEdit);
      const editBtn = document.getElementById('editToggleBtn'); // å…¼å®¹èˆŠæŒ‰éˆ•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (editBtn) {
        editBtn.innerText = !isEdit ? "ğŸ”“ é€€å‡ºç·¨è¼¯ (å·²é–å®š)" : "ğŸ”’ é–‹å•Ÿç·¨è¼¯æ¨¡å¼";
        editBtn.style.background = !isEdit ? "#ef4444" : "#f59e0b";
      }
      updateLocks();
    }
    function updateLocks() {
      const isEdit = document.body.getAttribute('data-edit') === 'true';
      document.querySelectorAll('.global-lock').forEach(el => {
        el.disabled = !isEdit;
        if (el.tagName === 'BUTTON') el.classList.toggle('add-btn-locked', !isEdit);
      });
      const addBtn = document.getElementById('btnSideAdd');
      addBtn.classList.toggle('add-btn-locked', !isEdit);
      addBtn.onclick = isEdit ? openModal : null;

      document.querySelectorAll('.card').forEach(card => {
        card.querySelectorAll('textarea, select, input[type="checkbox"]').forEach(el => el.disabled = !isEdit);
        const delBtn = card.querySelector('.del-x'); if (delBtn) delBtn.style.display = isEdit ? 'block' : 'none';
      });
      document.querySelectorAll('.attendee-list .del-x').forEach(x => x.style.display = isEdit ? 'inline-block' : 'none');
    }

    /* ===== Modal & ä¸»é¡Œ ===== */
    function openModal() { document.getElementById('dateModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('dateModal').style.display = 'none'; }
    function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }

    /* ===== æ‰¾ä¸Šä¸€å€‹æœƒè­°æ—¥ & ç¹¼æ‰¿ï¼ˆåªåœ¨ã€Œå°šæœªåˆå§‹åŒ–ã€æ™‚ç™¼ç”Ÿä¸€æ¬¡ï¼‰ ===== */
    function findPreviousDate(currentIso) {
      const dates = Object.keys(meetings).filter(d => d < currentIso).sort().reverse();
      return dates[0] || null;
    }
    // è¿½è¹¤ï¼šåªç¹¼æ‰¿ keep=trueï¼›åªåœ¨ trackingSeeded !== true æ™‚åšä¸€æ¬¡
    function maybeSeedTracking(targetDate) {
      const m = meetings[targetDate]; if (!m) return;
      m.meta = m.meta || {};
      if (m.meta.trackingSeeded === true) return; // å·²åˆå§‹åŒ–éå°±ä¸ç¹¼æ‰¿

      const prevDate = findPreviousDate(targetDate); if (!prevDate) { m.meta.trackingSeeded = true; return; }
      const prev = meetings[prevDate]; const prevTracking = prev?.cards?.col_tracking || [];
      const inherit = prevTracking
        .filter(it => (it.keep === undefined ? true : !!it.keep))
        .map(it => ({ ...it, keep: (it.keep === undefined ? true : !!it.keep) }));
      m.cards = m.cards || {};
      if (!m.cards.col_tracking || m.cards.col_tracking.length === 0) {
        m.cards.col_tracking = JSON.parse(JSON.stringify(inherit));
      }
      m.meta.trackingSeeded = true; // æ¨™è¨˜å·²åˆå§‹åŒ–
    }
    // å¹¹éƒ¨æœƒè­°ç´€éŒ„ï¼šåªåœ¨ recordSeeded !== true æ™‚åšä¸€æ¬¡ï¼ˆé¦–æ¬¡å»ºç«‹æ—¥æœŸï¼‰
    function maybeSeedRecord(targetDate) {
      const m = meetings[targetDate]; if (!m) return;
      m.meta = m.meta || {};
      if (m.meta.recordSeeded === true) return; // å·²åˆå§‹åŒ–éå°±ä¸ç¹¼æ‰¿

      const prevDate = findPreviousDate(targetDate); if (!prevDate) { m.meta.recordSeeded = true; return; }
      const prev = meetings[prevDate]; const prevRecords = prev?.cards?.col_record || [];
      m.cards = m.cards || {};
      if (!m.cards.col_record || m.cards.col_record.length === 0) {
        m.cards.col_record = JSON.parse(JSON.stringify(prevRecords));
      }
      m.meta.recordSeeded = true; // æ¨™è¨˜å·²åˆå§‹åŒ–ï¼ˆä¹‹å¾Œå°±ä¸å†è‡ªå‹•è£œï¼‰
    }

    /* ===== å»ºç«‹/åˆ‡æ›æ—¥æœŸ ===== */
    function confirmNewMeeting() {
      const date = document.getElementById('newMeetingDate').value; if (!date) return;
      if (document.body.getAttribute('data-edit') === 'true' && hasUnsaved) saveCurrentToVariable();

      if (!meetings[date]) {
        const prev = meetings[currentDay] || {
          attendees: [], chair:'', recorder:'', morning:'', afternoon:'',
          cards:{ col_record:[], col_tracking:[], col_target:[] },
          meta:{}
        };
        meetings[date] = {
          attendees: [],
          chair: prev.chair || '',
          recorder: prev.recorder || '',
          morning: prev.morning || '',
          afternoon: prev.afternoon || '',
          cards: { col_record: [], col_tracking: [], col_target: JSON.parse(JSON.stringify(prev.cards?.col_target || [])) },
          meta: { recordSeeded: false, trackingSeeded: false } // æ–°æ—¥æœŸï¼šå°šæœªåˆå§‹åŒ– â†’ æœƒå„åšä¸€æ¬¡ç¹¼æ‰¿
        };
      }

      currentDay = date;
      // æ–°æ—¥æœŸç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚åšä¸€æ¬¡ç¹¼æ‰¿
      maybeSeedRecord(date);
      maybeSeedTracking(date);

      closeModal(); refreshSidebar(); loadMeeting(date);
    }

    function refreshSidebar() {
      const bar = document.getElementById('dateSidebar');
      Array.from(bar.querySelectorAll('.side-icon:not(.side-add)')).forEach(el => el.remove());
      Object.keys(meetings).sort().reverse().forEach(date => {
        const btn = document.createElement('div');
        btn.className = `side-icon ${date === currentDay ? 'active' : ''}`;
        btn.innerHTML = date.substring(5).replace('-', '/');
        btn.onclick = () => loadMeeting(date);
        bar.insertBefore(btn, bar.lastElementChild);
      });
    }

    function ensureOption(selectEl, value) {
      // å…è¨±ç©ºç™½
      const found = Array.from(selectEl.options).some(o => o.value === (value ?? ""));
      if (!found) selectEl.add(new Option(value ?? "", value ?? ""));
    }

    const _origLoadMeeting = function(date) {
      currentDay = date;
      if (!meetings[date]) {
        meetings[date] = {
          attendees: [],
          chair: '', recorder: '', morning: '', afternoon: '',
          cards: { col_record: [], col_tracking: [], col_target: [] },
          meta: { recordSeeded: false, trackingSeeded: false }
        };
      }

      // åªåœ¨ã€Œå°šæœªåˆå§‹åŒ–ã€æ™‚å„åšä¸€æ¬¡ç¹¼æ‰¿
      maybeSeedRecord(date);
      maybeSeedTracking(date);

      const data = meetings[date];
      document.getElementById('mDateDisplay').value = date;

      const mChair = document.getElementById('mChair');
      const mRecorder = document.getElementById('mRecorder');
      const mRepMorning = document.getElementById('mRepMorning');
      const mRepAfternoon = document.getElementById('mRepAfternoon');

      ensureOption(mChair, data.chair ?? "");        mChair.value = data.chair ?? "";
      ensureOption(mRecorder, data.recorder ?? "");  mRecorder.value = data.recorder ?? "";
      ensureOption(mRepMorning, data.morning ?? ""); mRepMorning.value = data.morning ?? "";
      ensureOption(mRepAfternoon, data.afternoon ?? ""); mRepAfternoon.value = data.afternoon ?? "";

      const list = document.getElementById('attendeeList');
      list.innerHTML = ""; (data.attendees || []).forEach(n => addAttendee(n));

      ['col_record', 'col_tracking', 'col_target'].forEach(id => {
        const cont = document.getElementById(id); cont.innerHTML = "";
        if (data.cards && data.cards[id]) data.cards[id].forEach(c => addNewCard(id, c));
      });

      refreshSidebar(); updateLocks();
      hasUnsaved = false;
    };

    function loadMeeting(date) {
      if (document.body.getAttribute('data-edit') === 'true' && hasUnsaved) saveCurrentToVariable();
      _origLoadMeeting(date); bindDirtyWatcher();
    }

    /* ===== å ±å‘Šæ—¥æœŸä¿®æ”¹ï¼šæ¬ç§»/è¦†å¯« ===== */
    let _dateBeforeEdit = null;
    function onDateFocus() { _dateBeforeEdit = currentDay; }
    function handleDateChange() {
      const input = document.getElementById('mDateDisplay');
      const newDate = (input.value || '').trim(); const oldDate = _dateBeforeEdit || currentDay;

      if (!newDate || newDate === oldDate) { input.value = oldDate; return; }
      if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate)) { alert('â— è«‹è¼¸å…¥æ­£ç¢ºçš„æ—¥æœŸæ ¼å¼ï¼ˆYYYY-MM-DDï¼‰'); input.value = oldDate; return; }
      if (document.body.getAttribute('data-edit') !== 'true') { alert('è«‹å…ˆé–‹å•Ÿç·¨è¼¯æ¨¡å¼å†ä¿®æ”¹æ—¥æœŸã€‚'); input.value = oldDate; return; }

      saveCurrentToVariable();
      if (meetings[newDate]) {
        const ok = confirm(`æ—¥æœŸ ${newDate} å·²å­˜åœ¨ã€‚\nè¦è¦†å¯«è©²æ—¥æœŸè³‡æ–™å—ï¼Ÿ\nï¼ˆè¦†å¯«å¾Œï¼Œä»¥ç›®å‰ç•«é¢å…§å®¹ç‚ºä¸»ï¼‰`);
        if (!ok) { input.value = oldDate; return; }
      }
      const snapshot = meetings[oldDate];
      meetings[newDate] = snapshot; if (newDate !== oldDate) delete meetings[oldDate];

      currentDay = newDate; hasUnsaved = true;
      refreshSidebar(); loadMeeting(newDate);
      try { localStorage.setItem('MeetingV27_Data', JSON.stringify(meetings)); } catch {}
    }

    /* ===== å‡ºå¸­åå–®ï¼ˆç²¾æº–ï¼‰ ===== */
    function addAttendee(name) {
      if (!name) return;
      const list = document.getElementById('attendeeList');
      const exists = Array.from(list.querySelectorAll('.tag')).some(t => t.dataset.name === name);
      if (exists) return;
      const tag = document.createElement('div'); tag.className = 'tag'; tag.dataset.name = name;
      const text = document.createElement('span'); text.textContent = name;
      const del = document.createElement('span'); del.className = 'del-x'; del.textContent = 'âœ•'; del.onclick = () => { tag.remove(); markDirty(); };
      tag.appendChild(text); tag.appendChild(del); list.appendChild(tag);
      updateLocks(); markDirty();
    }
    function getAttendees() { return Array.from(document.querySelectorAll('.attendee-list .tag')).map(t => t.dataset.name); }

    /* ===== å¡ç‰‡ï¼šå±•é–‹/æ”¶åˆ ===== */
    function toggleExpand(btn) {
      const descArea = btn.parentElement.querySelector('.c-desc'); if (!descArea) return;
      if (descArea.classList.contains('expanded')) { descArea.classList.remove('expanded'); descArea.style.height = '65px'; btn.innerHTML = 'â–¼ å±•é–‹'; }
      else { descArea.classList.add('expanded'); descArea.style.height = descArea.scrollHeight + 'px'; btn.innerHTML = 'â–² æ”¶åˆ'; }
    }

    /* ===== å¹¹éƒ¨æœƒè­°ç´€éŒ„ â†’ è¿½è¹¤ï¼ˆåŒæ­¥æ™‚æ¸…ç©ºå·¦æ¬„ï¼Œä¸¦æ¨™è¨˜ä¸å†ç¹¼æ‰¿ï¼‰ ===== */
    function moveToTracking(btn) {
      const card = btn.closest('.card'); if (!card) return;
      const data = {
        title: card.querySelector('.c-title')?.value || '',
        desc:  card.querySelector('.c-desc')?.value || '',
        cat:   card.querySelector('.m-cat')?.value || 'å…¨éƒ¨',
        owner: card.querySelector('.m-own')?.value || 'å…¨éƒ¨',
        keep:  true
      };
      card.remove(); addNewCard('col_tracking', data);
      _movedRecordToTracking = true; markDirty(); updateLocks();
    }

    function addNewCard(colId, data = null) {
      const col = document.getElementById(colId); const card = document.createElement('div'); card.className = 'card';
      const d = data || { title: 'äº‹é …åç¨±', desc: 'å…§å®¹è©³æƒ…...', cat: 'å…¨éƒ¨', owner: 'å…¨éƒ¨', keep: (colId==='col_tracking' ? true : undefined) };
      const keepBlock = (colId === 'col_tracking')
        ? `<div class="meta-item"><label class="meta-label" style="display:flex; align-items:center; gap:6px;">
             <input type="checkbox" class="m-keep global-lock" ${(d.keep === undefined || d.keep) ? 'checked' : ''} />ä¿ç•™åˆ°ä¸‹æ¬¡
           </label></div>` : '';
      const moveBlock = (colId === 'col_record')
        ? `<div class="meta-item" style="justify-content:flex-end;">
             <button class="global-lock" style="padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--input-bg); cursor:pointer;" onclick="moveToTracking(this)">â¡ ç§»åˆ°è¿½è¹¤</button>
           </div>` : '';
      card.innerHTML = `
        <div class="del-x" style="position:absolute; top:10px; right:15px; cursor:pointer;" onclick="this.parentElement.remove(); markDirty();">ç§»é™¤âœ•</div>
        <textarea class="c-title" rows="1">${d.title ?? ''}</textarea>
        <textarea class="c-desc">${d.desc ?? ''}</textarea>
        <div class="expand-btn" onclick="toggleExpand(this)">â–¼ å±•é–‹</div>
        <div class="card-meta">
          <div class="meta-item"><span class="meta-label">é …ç›®åˆ†é¡:</span>
            <select class="m-cat meta-select">${categoryList.map(c => `<option value="${c}" ${d.cat===c?'selected':''}>${c}</option>`).join('')}</select>
          </div>
          <div class="meta-item"><span class="meta-label">è² è²¬äººå“¡:</span>
            <select class="m-own meta-select">${ownerList.map(n => `<option value="${n}" ${d.owner===n?'selected':''}>${n}</option>`).join('')}</select>
          </div>
          ${keepBlock}${moveBlock}
        </div>`;
      col.appendChild(card); updateLocks();
      card.querySelectorAll('textarea, select, input[type="checkbox"]').forEach(el => { el.addEventListener('input', markDirty); el.addEventListener('change', markDirty); });
    }

    /* ===== å„²å­˜ï¼ˆæœ¬æ©Ÿ/è®Šæ•¸ï¼‰ â€”â€” è‹¥ä½¿ç”¨è€…æ‰‹å‹•æ¸…ç©ºå·¦æ¬„ï¼Œè¦–ç‚ºå·²åˆå§‹åŒ–ï¼Œé¿å…å†ç¹¼æ‰¿ ===== */
    function getCardData(id) {
      return Array.from(document.getElementById(id).querySelectorAll('.card')).map(c => {
        const base = {
          title: c.querySelector('.c-title')?.value || '',
          desc:  c.querySelector('.c-desc')?.value || '',
          cat:   c.querySelector('.m-cat')?.value || 'å…¨éƒ¨',
          owner: c.querySelector('.m-own')?.value || 'å…¨éƒ¨'
        };
        if (id === 'col_tracking') base.keep = !!(c.querySelector('.m-keep')?.checked);
        return base;
      });
    }
    function saveCurrentToVariable() {
      const rec = getCardData('col_record');
      const trk = getCardData('col_tracking');
      const tgt = getCardData('col_target');

      meetings[currentDay] = meetings[currentDay] || {};
      meetings[currentDay].cards = meetings[currentDay].cards || {};
      meetings[currentDay].meta  = meetings[currentDay].meta  || {};

      meetings[currentDay].chair     = document.getElementById('mChair').value;
      meetings[currentDay].recorder  = document.getElementById('mRecorder').value;
      meetings[currentDay].morning   = document.getElementById('mRepMorning').value;
      meetings[currentDay].afternoon = document.getElementById('mRepAfternoon').value;
      meetings[currentDay].attendees = getAttendees();
      meetings[currentDay].cards.col_record = rec;
      meetings[currentæ¸…æºï¼Œæˆ‘çœ‹ä½ çš„æˆªåœ–ï¼Œåº•éƒ¨é‚£ä¸€å¤§ç‰‡ã€Œç™½ï¼ˆæ·ºç°ï¼‰ã€æ˜¯æˆ‘å€‘ä¹‹å‰ç‚ºäº†é¿å…æµ®å‹•æŒ‰éˆ•æ“‹ä½å…§å®¹ï¼Œçµ¦ `.main` åŠ äº†æ¯”è¼ƒå¤§çš„ **`padding-bottom: 120px`** é€ æˆçš„ã€‚  
æˆ‘å¹«ä½ æ”¹æˆ**æ›´ç²¾æº–ä¸”ä¸çªå…€**çš„åšæ³•ï¼š

- å°‡ `.main` çš„åº•éƒ¨ç•™ç™½ç¸®å°ç‚º **32px**ï¼ˆä¸€èˆ¬æƒ…æ³å·²è¶³å¤ ï¼‰ã€‚  
- é‡å°å°è¢å¹•ï¼ˆæ‰‹æ©Ÿ/çª„è¦–çª—ï¼‰æ‰ç¨å¾®æ”¾å¤§åˆ° **64px**ã€‚  
- FAB Dock æœ¬èº«å›ºå®šåœ¨å³ä¸‹è§’ï¼ˆä¸ä½”ç‰ˆé¢ï¼‰ã€‚  
- å…¶é¤˜åŠŸèƒ½å®Œå…¨ä¿ç•™ï¼ˆå±•é–‹å¼ FABï¼šä¸»é¡Œåˆ‡æ›ï¼é–‹å•Ÿç·¨è¼¯ï¼å„²å­˜æœ¬æ©Ÿï¼å„²å­˜ä¸¦åŒæ­¥ã€åˆå§‹åŒ–ç¹¼æ‰¿ä¸€æ¬¡ã€åŒæ­¥å¾Œæ¸…ç©ºå¹¹éƒ¨ç´€éŒ„ã€å¯ä¿®æ”¹æ—¥æœŸã€å››å€‹ä¸‹æ‹‰å«ç©ºç™½ã€å­—ç´šè¦ç¯„â€¦ï¼‰ã€‚

ä¸‹é¢æ˜¯**å®Œæ•´ã€å¯ç›´æ¥è²¼ä¸Šçš„ `index.html`**ï¼ˆå·²å¥—ç”¨ä¿®æ­£ï¼‰ã€‚  
> ä¸»è¦è®Šæ›´é»ï¼š`.main { padding-bottom: 120px; }` â†’ `32px`ï¼Œä¸¦åŠ ä¸Š `@media` åœ¨çª„è¢å¹•ç”¨ `64px`ã€‚

---

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å®¢æœæœƒè­°ç®¡ç†ç³»çµ± 27.1 - å±•é–‹æ”¶åˆ + é›²ç«¯åŒæ­¥</title>
  <style>
    :root {
      --bg: #f1f5f9; --card-bg: #ffffff; --text-main: #0f172a; --text-muted: #64748b;
      --border: #e2e8f0; --sidebar-bg: #ffffff; --accent: #0284c7; --input-bg: #f8fafc;
    }
    [data-theme="dark"] {
      --bg: #0f172a; --card-bg: #1e293b; --text-main: #f8fafc; --text-muted: #94a3b8;
      --border: #334155; --sidebar-bg: #1e293b; --accent: #38bdf8; --input-bg: #0f172a;
    }

    /* ====== å­—é«”å¤§å°è¦ç¯„ ====== */
    html { font-size: 18px; }  /* å…¶ä»–é è¨­ 18px */
    body, input, select, textarea, button { font-size: 18px; }

    * { box-sizing: border-box; transition: 0.2s ease; }
    body {
      font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg); color: var(--text-main);
      margin: 0; display: flex; height: 100vh; overflow: hidden;
    }

    /* å´é‚Šæ¬„ */
    .sidebar {
      width: 80px; background: var(--sidebar-bg); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; align-items: center; padding: 20px 0;
      overflow-y: auto; flex-shrink: 0;
    }
    .side-icon {
      width: 50px; height: 50px; border-radius: 12px; background: var(--bg); margin-bottom: 15px;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      border: 1px solid var(--border); color: var(--text-muted); font-size: 1rem; text-align: center;
    }
    .side-icon.active { background: var(--accent); color: #fff; border-color: var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .side-add { border: 2px dashed var(--text-muted); font-size: 1.5rem; }

    .main {
      flex: 1; padding: 25px; display: flex; flex-direction: column; overflow-x: hidden;
      /* âœ… ç¸®å°åº•éƒ¨é ç•™ç©ºé–“ï¼Œé¿å…å‡ºç¾å¤§å¡Šç•™ç™½ */
      padding-bottom: 32px;
    }
    @media (max-width: 768px) {
      .main { padding-bottom: 64px; } /* å°è¢å¹•ç•¥å¾®æ”¾å¤§ç•™ç™½ */
    }

    .header-section { background: var(--card-bg); border-radius: 20px; padding: 20px; margin-bottom: 25px; border: 1px solid var(--border); }

    .info-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 10px; }
    .status-row { display: grid; grid-template-columns: 1fr 450px; gap: 25px; padding-top: 15px; border-top: 1px solid var(--border); }

    .input-group label { display: block; color: var(--text-muted); margin-bottom: 6px; font-weight: bold; font-size: 18px; }
    .input-group select, .input-group input {
      background: var(--input-bg); border: 1px solid var(--border); color: var(--text-main);
      padding: 10px; border-radius: 8px; width: 100%; outline: none;
    }
    .input-group select:disabled, .input-group input:disabled { opacity: 0.7; cursor: not-allowed; }

    .attendee-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; min-height: 42px; padding: 6px; background: var(--input-bg); border-radius: 10px; border: 1px dashed var(--border); }
    .tag { background: rgba(56,189,248,0.1); color: var(--accent); padding: 5px 14px; border-radius: 50px; font-size: 1rem; border: 1px solid var(--accent); display: flex; align-items: center; gap: 8px; font-weight: bold; }

    .del-x { cursor: pointer; color: #ef4444; font-weight: bold; display: none; margin-left: 5px; }
    body[data-edit="true"] .del-x { display: inline-block !important; }

    .board { display: flex; flex-wrap: wrap; gap: 20px; flex: 1; overflow-y: auto; align-content: flex-start; }
    .column { background: rgba(0,0,0,0.02); border-radius: 20px; flex: 1 1 350px; padding: 20px; display: flex; flex-direction: column; border: 1px solid var(--border); min-height: 450px; }
    .column-title { font-weight: bold; margin-bottom: 20px; color: var(--accent); border-bottom: 2px solid var(--accent); padding-bottom: 8px; font-size: 20px; } /* æ¨™é¡Œ 20px */

    /* å¡ç‰‡ & å±•é–‹ */
    .card { background: var(--card-bg); border-radius: 15px; padding: 18px; margin-bottom: 15px; border: 1px solid var(--border); position: relative; display: flex; flex-direction: column; }
    .card textarea { width: 100%; background: transparent; border: none; color: var(--text-main); resize: none; font-family: inherit; outline: none; line-height: 1.6; }
    .card textarea:disabled { color: var(--text-main); opacity: 1; cursor: default; }

    .card .c-title { font-size: 1rem; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 5px; min-height: 35px; }
    .card .c-desc { font-size: 1rem; height: 65px; overflow: hidden; transition: height 0.3s ease-in-out; margin-bottom: 5px; }
    .card .c-desc.expanded { overflow: visible; }

    .expand-btn { font-size: 1rem; color: var(--accent); text-align: center; cursor: pointer; padding: 4px; margin-top: auto; border-top: 1px dashed var(--border); font-weight: bold; user-select: none; opacity: 0.8; }
    .expand-btn:hover { opacity: 1; background: rgba(0,0,0,0.02); }

    .card-meta { display: flex; align-items: center; gap: 10px; margin-top: 5px; padding-top: 10px; border-top: 1px solid var(--border); flex-wrap: wrap; }
    .meta-item { display: flex; align-items: center; gap: 5px; flex: 1; min-width: 140px; }
    .meta-label { color: var(--text-muted); font-weight: bold; white-space: nowrap; font-size: 18px; }
    .meta-select { background: var(--input-bg); border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; font-size: 1rem; padding: 4px; flex: 1; cursor: pointer; }
    .meta-select:disabled { cursor: not-allowed; opacity: 0.8; color: var(--text-main); }

    .add-btn-locked { opacity: 0.5; cursor: not-allowed !important; pointer-events: none; }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
    .modal-content { background: var(--card-bg); padding: 30px; border-radius: 20px; width: 320px; text-align: center; }
    .modal-content h3 { font-size: 20px; margin: 0 0 10px; color: var(--accent); } /* æ¨™é¡Œ 20px */

    /* ====== å±•é–‹å¼ FAB Dockï¼ˆå«ä¸»é¡Œåˆ‡æ›ï¼‰ ====== */
    .fab-dock { position: fixed; bottom: 12px; right: 12px; z-index: 900; }
    .fab-main {
      width: 52px; height: 52px; border-radius: 50%;
      background: #0ea5e9; color: #fff; border: none; cursor: pointer;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      font-weight: 900; font-size: 1.1rem; transform: scale(0.96); opacity: .95;
    }
    .fab-main:hover { transform: scale(1.0); opacity: 1; }

    .fab-items {
      position: absolute; bottom: 60px; right: 0; display: grid; gap: 8px;
      pointer-events: none; /* é è¨­ä¸å¯é»ï¼Œå±•é–‹æ™‚å¯é» */
    }
    .fab-item {
      padding: 8px 14px; border-radius: 12px; border: none; cursor: pointer;
      color: #fff; font-weight: 700; font-size: .9rem; box-shadow: 0 6px 12px rgba(0,0,0,0.18);
      transform: translateY(8px) scale(.9); opacity: 0; transition: transform .18s ease, opacity .18s ease;
      display: flex; align-items: center; gap: 8px;
    }
    .fab-item.theme { background: #64748b; }
    .fab-item.edit  { background: #f59e0b; }
    .fab-item.save  { background: #0284c7; }
    .fab-item.sync  { background: #0ea5e9; }
    .fab-item:disabled { opacity: .6; cursor: not-allowed; }

    .fab-dock.open .fab-items { pointer-events: auto; }
    .fab-dock.open .fab-item { transform: translateY(0) scale(1); opacity: 1; }
    .fab-dock.open .fab-item:nth-child(1) { transition-delay: .00s; }
    .fab-dock.open .fab-item:nth-child(2) { transition-delay: .03s; }
    .fab-dock.open .fab-item:nth-child(3) { transition-delay: .06s; }
    .fab-dock.open .fab-item:nth-child(4) { transition-delay: .09s; }
  </style>
</head>
<body data-theme="light" data-edit="false">

  <!-- æ—¥æœŸå»ºç«‹ -->
  <div class="modal-overlay" id="dateModal">
    <div class="modal-content">
      <h3>ğŸ“… é¸æ“‡æ–°æœƒè­°æ—¥æœŸ</h3>
      <input type="date" id="newMeetingDate" style="padding:8px;">
      <br>
      <button onclick="confirmNewMeeting()" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:50px; margin-top:15px; cursor:pointer;">å»ºç«‹å ±å‘Š</button>
      <p style="cursor:pointer; font-size:0.9rem; color:var(--text-muted);" onclick="closeModal()">å–æ¶ˆ</p>
    </div>
  </div>

  <div class="sidebar" id="dateSidebar">
    <div class="side-icon side-add" id="btnSideAdd" onclick="openModal()">+</div>
  </div>

  <div class="main">
    <div class="header-section">
      <!-- é›²ç«¯ç‹€æ…‹åˆ— -->
      <div id="syncStatus" style="font-size:0.9rem; color:var(--accent); margin-bottom:10px;">â˜ï¸ æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</div>

      <div class="info-row">
        <div class="input-group">
          <label>ğŸ“… å ±å‘Šæ—¥æœŸ</label>
          <input type="date" id="mDateDisplay" class="global-lock" onfocus="onDateFocus()" onchange="handleDateChange()" style="font-weight:bold; color:var(--accent);" />
        </div>
        <div class="input-group"><label>ğŸ‘¤ ä¸»å¸­</label><select id="mChair" class="global-lock"></select></div>
        <div class="input-group"><label>ğŸ“ ç´€éŒ„</label><select id="mRecorder" class="global-lock"></select></div>
      </div>

      <div class="status-row">
        <div class="attendance-section">
          <div class="input-group">
            <label>ğŸ‘¥ å‡ºå¸­äººå“¡ (éœ€è§£é–å¾Œæ–°å¢)</label>
            <select id="mAttendeeSelect" class="global-lock" onchange="addAttendee(this.value); this.value='';">
              <option value="">-- è«‹æŒ‘é¸äººå“¡ --</option>
              <option value="è˜‡æ¸…æº">è˜‡æ¸…æº</option><option value="æ›¾é›ªå¦®">æ›¾é›ªå¦®</option>
              <option value="é»ƒå©·éˆº">é»ƒå©·éˆº</option><option value="è”¡ç­‘ç">è”¡ç­‘ç</option>
              <option value="è•­ç¿Šç¿">è•­ç¿Šç¿</option><option value="é™³ç«è«­">é™³ç«è«­</option>
              <option value="æå®¶æ§¿">æå®¶æ§¿</option><option value="ä¿Šç”Ÿéƒ¨é•·">ä¿Šç”Ÿéƒ¨é•·</option>
            </select>
          </div>
          <div id="attendeeList" class="attendee-list"></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
          <div class="input-group" style="border-left:4px solid var(--accent); padding-left:12px;"><label>â˜€ï¸ æ—©ç­å ±å‘Š</label><select id="mRepMorning" class="global-lock"></select></div>
          <div class="input-group" style="border-left:4px solid #15803d; padding-left:12px;"><label>â›… ä¸­ç­å ±å‘Š</label><select id="mRepAfternoon" class="global-lock"></select></div>
        </div>
      </div>
    </div>

    <div class="board">
      <div class="column">
        <div class="column-title">ğŸ“ å¹¹éƒ¨æœƒè­°ç´€éŒ„å…§å®¹</div>
        <div id="col_record"></div>
        <button class="add-btn global-lock" onclick="addNewCard('col_record')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer; color:var(--text-muted);">+ æ–°å¢æ±ºè­°</button>
      </div>
      <div class="column">
        <div class="column-title" style="color:#15803d">ğŸ“ è¿½è¹¤äº‹é …ç›¤é»</div>
        <div id="col_tracking"></div>
        <button class="add-btn global-lock" onclick="addNewCard('col_tracking')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer; color:var(--text-muted);">+ æ–°å¢è¿½è¹¤</button>
      </div>
      <div class="column">
        <div class="column-title" style="color:#b45309">ğŸ“ 2026å¹´åº¦ç›®æ¨™é€²åº¦</div>
        <div id="col_target"></div>
        <button class="add-btn global-lock" onclick="addNewCard('col_target')" style="width:100%; border:1px dashed var(--text-muted); background:none; padding:10px; cursor:pointer; color:var(--text-muted);">+ æ–°å¢é€²åº¦</button>
      </div>
    </div>
  </div>

  <!-- âœ… å±•é–‹å¼ FAB Dockï¼ˆä¸»æŒ‰éˆ• + å››é¡†å­æŒ‰éˆ•ï¼‰ -->
  <div class="fab-dock" id="fabDock">
    <button class="fab-main" id="fabMain" aria-expanded="false" aria-controls="fabItems" onclick="toggleFabDock()">â˜°</button>
    <div class="fab-items" id="fabItems" role="menu" aria-label="å¿«é€Ÿå‹•ä½œ">
      <button class="fab-item theme" role="menuitem" onclick="closeFabDock(); toggleTheme()">ğŸŒ— åˆ‡æ›é»‘/ç™½ä¸»é¡Œ</button>
      <button class="fab-item edit"  role="menuitem" onclick="closeFabDock(); toggleEditMode()">ğŸ”’ é–‹å•Ÿ/é€€å‡ºç·¨è¼¯</button>
      <button class="fab-item save"  role="menuitem" onclick="closeFabDock(); saveCurrentData()">ğŸ’¾ å„²å­˜åˆ°æœ¬æ©Ÿ</button>
      <button class="fab-item sync"  role="menuitem" id="btnCloudSync" onclick="closeFabDock(); saveAndSyncToCloud()">ğŸ’¾â˜ï¸ å„²å­˜ä¸¦åŒæ­¥</button>
    </div>
  </div>

  <script>
    /* ------------------------  æ—¢æœ‰åŠŸèƒ½ä¿ç•™  ------------------------ */

    // ====== é›²ç«¯ API ======
    const CLOUD_API_URL = "https://script.google.com/macros/s/AKfycbxtfU8YUXCQyea1qh8khk1XbUN-zd1XzoGsNJcjruVThrSt3r7uW1XtzAexOK5rQ6sfiA/exec";

    const ownerList = ["å…¨éƒ¨", "è˜‡æ¸…æº", "æ›¾é›ªå¦®", "é»ƒå©·éˆº", "è”¡ç­‘ç", "è•­ç¿Šç¿", "é™³ç«è«­", "æå®¶æ§¿"];
    const categoryList = ["å®¢æœ", "VIP", "å…¨éƒ¨"];
    const cadres = ["è˜‡æ¸…æº", "æ›¾é›ªå¦®", "é»ƒå©·éˆº", "è”¡ç­‘ç", "è•­ç¿Šç¿", "é™³ç«è«­", "æå®¶æ§¿", "ä¿Šç”Ÿéƒ¨é•·"];

    let meetings = JSON.parse(localStorage.getItem('MeetingV27_Data')) || {
      "2026-01-14": {
        attendees: [], chair:"è•­ç¿Šç¿", recorder:"é™³ç«è«­", morning:"è˜‡æ¸…æº", afternoon:"æ›¾é›ªå¦®",
        cards: { col_record: [], col_tracking: [], col_target: [] },
        meta: { recordSeeded: true, trackingSeeded: true }
      }
    };
    let currentDay = Object.keys(meetings).sort().reverse()[0] || "2026-01-14";
    let hasUnsaved = false;
    let _movedRecordToTracking = false; // æœ¬æ¬¡æ˜¯å¦æŠŠå·¦æ¬„ç§»åˆ°è¿½è¹¤ï¼ˆåŒæ­¥å¾Œæ¸…ç©ºå·¦æ¬„ï¼‰

    /* ===== é¦–æ¬¡é–‹å•Ÿï¼šå°‡æ‰€æœ‰å¯æ»¾å‹•å€å¡Šèˆ‡ textarea æ²åˆ°é ‚ç«¯ ===== */
    function scrollAllScrollableToTop() {
      try { if ('scrollRestoration' in history) history.scrollRestoration = 'manual'; } catch {}
      window.scrollTo(0, 0);
      const selectors = ['.sidebar', '#dateSidebar', '.main', '.board', '.column'];
      selectors.forEach(sel => document.querySelectorAll(sel).forEach(el => { try { el.scrollTop = 0; } catch {} }));
      document.querySelectorAll('textarea').forEach(ta => { try { ta.scrollTop = 0; } catch {} });
    }
    function scrollAllScrollableToTopDeferred() { requestAnimationFrame(scrollAllScrollableToTop); }

    function init() {
      // ä¸‹æ‹‰é¸å–®ï¼šå››å€‹æ¬„ä½å…ˆæ’å…¥ä¸€å€‹ç©ºç™½
      ['mChair','mRecorder','mRepMorning','mRepAfternoon'].forEach(id => {
        const el = document.getElementById(id);
        el.add(new Option('', '')); // å¯é¸ç©ºç™½
        cadres.forEach(name => { if (name !== 'ä¿Šç”Ÿéƒ¨é•·') el.add(new Option(name, name)); });
      });

      // æ–°å¢æ—¥æœŸ modal é è¨­å€¼
      const input = document.getElementById('newMeetingDate');
      if (input) {
        const today = new Date(); const yyyy = today.getFullYear(); const mm = String(today.getMonth()+1).padStart(2,'0'); const dd = String(today.getDate()).padStart(2,'0');
        input.value = `${yyyy}-${mm}-${dd}`;
        input.min = "2024-01-01";
      }

      // å…ˆæŠ“é›²ç«¯ï¼ˆå¤±æ•—ç”¨æœ¬åœ°ï¼‰
      fetchCloudData().then(() => {
        currentDay = Object.keys(meetings).sort().reverse()[0] || currentDay;
        refreshSidebar(); loadMeeting(currentDay);
        updateLocks(); bindDirtyWatcher(); scrollAllScrollableToTopDeferred();
      });

      window.addEventListener('pageshow', (e) => { if (e.persisted) scrollAllScrollableToTopDeferred(); });
      window.addEventListener('beforeunload', (e) => { if (hasUnsaved) { e.preventDefault(); e.returnValue = ''; } });

      // FAB Dockï¼šé»å¤–é¢å°±æ”¶åˆ
      document.addEventListener('click', (ev) => {
        const dock = document.getElementById('fabDock');
        if (!dock) return;
        if (!dock.contains(ev.target)) { dock.classList.remove('open'); setFabAria(false); }
      });
    }

    /* ===== é›²ç«¯è®€å– ===== */
    async function fetchCloudData() {
      const status = document.getElementById('syncStatus');
      const controller = new AbortController(); const timer = setTimeout(() => controller.abort(), 15000);
      try {
        const res = await fetch(CLOUD_API_URL, { signal: controller.signal, mode: 'cors', credentials: 'omit' });
        clearTimeout(timer);
        if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
        const data = await res.json();
        if (data && Object.keys(data).length > 0) {
          meetings = data;
          status.innerText = "â˜ï¸ é›²ç«¯åŒæ­¥å®Œæˆ";
          try { localStorage.setItem('MeetingV27_Data', JSON.stringify(meetings)); } catch {}
          return;
        }
        throw new Error('ç©ºè³‡æ–™');
      } catch (e) {
        clearTimeout(timer);
        console.warn('é›²ç«¯æŠ“å–å¤±æ•—ï¼Œæ”¹è¼‰å…¥æœ¬åœ°å‚™ä»½ï¼š', e);
        const backup = localStorage.getItem('MeetingV27_Data');
        if (backup) { meetings = JSON.parse(backup); status.innerText = "ğŸ’¾ å·²è¼‰å…¥æœ¬åœ°å‚™ä»½ (é›²ç«¯æœªé€£ç·š)"; }
        else { status.innerText = "âš ï¸ ä½¿ç”¨æœ¬åœ°æš«å­˜ (å°šæœªåŒæ­¥)"; }
      }
    }

    /* ===== å„²å­˜ ä¸¦ åŒæ­¥è‡³é›²ç«¯ï¼ˆæŒ‰éˆ•ä¸»æµç¨‹ï¼‰ ===== */
    async function saveAndSyncToCloud() {
      // å…ˆã€Œå„²å­˜åˆ°æœ¬æ©Ÿè®Šæ•¸ + localStorageã€
      saveCurrentToVariable();

      // åŒæ­¥æœŸé–“åœç”¨æŒ‰éˆ•ï¼Œé¿å…é‡è¤‡ç™¼é€
      const btn = document.getElementById('btnCloudSync');
      if (btn) { btn.disabled = true; btn.textContent = 'â³ æ­£åœ¨å„²å­˜ä¸¦åŒæ­¥...'; }

      try {
        await syncToCloud(); // é€åˆ°é›²ç«¯ï¼ˆå…§å« payload æº–å‚™èˆ‡å·¦æ¬„æ¸…ç©ºé‚è¼¯ï¼‰
      } finally {
        // å¾©åŸæŒ‰éˆ•
        if (btn) { btn.disabled = false; btn.textContent = 'ğŸ’¾â˜ï¸ å„²å­˜ä¸¦åŒæ­¥'; }
      }
    }

    /* ===== é›²ç«¯ä¸Šå‚³ï¼ˆsimple request é¿å…é æª¢ï¼‰ =====
       è‹¥æœ¬æ¬¡æœ‰ç§»åˆ°è¿½è¹¤ï¼Œé€å‡º payload æ™‚æ¸…ç©ºç•¶å¤© col_recordï¼Œ
       åŒæ­¥æˆåŠŸå¾Œæœ¬æ©Ÿä¹Ÿæ¸…ç©ºï¼Œä¸¦æŠŠ meta.recordSeeded = trueï¼ˆè¡¨ç¤ºå·²æ˜ç¢ºåˆå§‹åŒ–/æ¸…ç©ºï¼‰ã€‚ */
    async function syncToCloud() {
      // ä»¥ç›®å‰ meetings ç‚ºåŸºæº–æº–å‚™ payload
      const payload = JSON.parse(JSON.stringify(meetings));
      if (_movedRecordToTracking && payload[currentDay]?.cards) {
        payload[currentDay].cards.col_record = [];
        payload[currentDay].meta = payload[currentDay].meta || {};
        payload[currentDay].meta.recordSeeded = true; // é¿å…ä¹‹å¾Œå†è¢«ç¹¼æ‰¿
      }

      const status = document.getElementById('syncStatus');
      status.innerText = "â³ æ­£åœ¨åŒæ­¥è‡³é›²ç«¯...";
      const controller = new AbortController(); const timer = setTimeout(() => controller.abort(), 15000);

      try {
        const res = await fetch(CLOUD_API_URL, {
          method: 'POST',
          body: JSON.stringify(payload),     // ä¸å¸¶ Content-Type â†’ simple request
          signal: controller.signal,
          mode: 'cors',
          credentials: 'omit'
        });
        clearTimeout(timer);
        if (!res.ok) {
          const txt = await res.text().catch(()=> ''); throw new Error(`HTTP ${res.status} ${res.statusText} ${txt}`);
        }
        const text = await res.text();
        alert("âœ… " + text);
        status.innerText = "â˜ï¸ é›²ç«¯åŒæ­¥å®Œæˆ";

        // åŒæ­¥æˆåŠŸå¾ŒåŒæ­¥æœ¬æ©Ÿç‹€æ…‹
        if (_movedRecordToTracking && meetings[currentDay]?.cards) {
          meetings[currentDay].cards.col_record = [];
          meetings[currentDay].meta = meetings[currentDay].meta || {};
          meetings[currentDay].meta.recordSeeded = true; // å·²æ¸…ç©ºï¼å·²åˆå§‹åŒ–
          _movedRecordToTracking = false;
          loadMeeting(currentDay); // ç«‹åˆ»é‡ç¹ªå·¦æ¬„ç‚ºç©º
        }

        try { localStorage.setItem('MeetingV27_Data', JSON.stringify(meetings)); } catch {}
        if (document.body.getAttribute('data-edit') === 'true') toggleEditMode();
      } catch (e) {
        clearTimeout(timer);
        console.error(e);
        let msg = "âŒ åŒæ­¥å¤±æ•—ã€‚";
        if (e.name === 'AbortError') msg += "ï¼ˆé€¾æ™‚æœªå›æ‡‰ï¼‰";
        else if (String(e).includes('TypeError') || String(e.message).includes('Failed to fetch')) msg += "ï¼ˆCORS/æ¬Šé™æˆ–ç¶²è·¯è¢«é˜»æ“‹ï¼‰";
        alert(msg + " è©³ç´°ï¼š" + (e.message || e));
        status.innerText = "âš ï¸ ä½¿ç”¨æœ¬åœ°æš«å­˜ (å°šæœªåŒæ­¥)";
      }
    }

    /* ===== ç·¨è¼¯é– ===== */
    function toggleEditMode() {
      const isEdit = document.body.getAttribute('data-edit') === 'true';
      document.body.setAttribute('data-edit', !isEdit);
      const editBtn = document.getElementById('editToggleBtn'); // å…¼å®¹èˆŠæŒ‰éˆ•ï¼ˆè‹¥å­˜åœ¨ï¼‰
      if (editBtn) {
        editBtn.innerText = !isEdit ? "ğŸ”“ é€€å‡ºç·¨è¼¯ (å·²é–å®š)" : "ğŸ”’ é–‹å•Ÿç·¨è¼¯æ¨¡å¼";
        editBtn.style.background = !isEdit ? "#ef4444" : "#f59e0b";
      }
      updateLocks();
    }
    function updateLocks() {
      const isEdit = document.body.getAttribute('data-edit') === 'true';
      document.querySelectorAll('.global-lock').forEach(el => {
        el.disabled = !isEdit;
        if (el.tagName === 'BUTTON') el.classList.toggle('add-btn-locked', !isEdit);
      });
      const addBtn = document.getElementById('btnSideAdd');
      addBtn.classList.toggle('add-btn-locked', !isEdit);
      addBtn.onclick = isEdit ? openModal : null;

      document.querySelectorAll('.card').forEach(card => {
        card.querySelectorAll('textarea, select, input[type="checkbox"]').forEach(el => el.disabled = !isEdit);
        const delBtn = card.querySelector('.del-x'); if (delBtn) delBtn.style.display = isEdit ? 'block' : 'none';
      });
      document.querySelectorAll('.attendee-list .del-x').forEach(x => x.style.display = isEdit ? 'inline-block' : 'none');
    }

    /* ===== Modal & ä¸»é¡Œ ===== */
    function openModal() { document.getElementById('dateModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('dateModal').style.display = 'none'; }
    function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }

    /* ===== æ‰¾ä¸Šä¸€å€‹æœƒè­°æ—¥ & ç¹¼æ‰¿ï¼ˆåªåœ¨ã€Œå°šæœªåˆå§‹åŒ–ã€æ™‚ç™¼ç”Ÿä¸€æ¬¡ï¼‰ ===== */
    function findPreviousDate(currentIso) {
      const dates = Object.keys(meetings).filter(d => d < currentIso).sort().reverse();
      return dates[0] || null;
    }
    // è¿½è¹¤ï¼šåªç¹¼æ‰¿ keep=trueï¼›åªåœ¨ trackingSeeded !== true æ™‚åšä¸€æ¬¡
    function maybeSeedTracking(targetDate) {
      const m = meetings[targetDate]; if (!m) return;
      m.meta = m.meta || {};
      if (m.meta.trackingSeeded === true) return; // å·²åˆå§‹åŒ–éå°±ä¸ç¹¼æ‰¿

      const prevDate = findPreviousDate(targetDate); if (!prevDate) { m.meta.trackingSeeded = true; return; }
      const prev = meetings[prevDate]; const prevTracking = prev?.cards?.col_tracking || [];
      const inherit = prevTracking
        .filter(it => (it.keep === undefined ? true : !!it.keep))
        .map(it => ({ ...it, keep: (it.keep === undefined ? true : !!it.keep) }));
      m.cards = m.cards || {};
      if (!m.cards.col_tracking || m.cards.col_tracking.length === 0) {
        m.cards.col_tracking = JSON.parse(JSON.stringify(inherit));
      }
      m.meta.trackingSeeded = true; // æ¨™è¨˜å·²åˆå§‹åŒ–
    }
    // å¹¹éƒ¨æœƒè­°ç´€éŒ„ï¼šåªåœ¨ recordSeeded !== true æ™‚åšä¸€æ¬¡ï¼ˆé¦–æ¬¡å»ºç«‹æ—¥æœŸï¼‰
    function maybeSeedRecord(targetDate) {
      const m = meetings[targetDate]; if (!m) return;
      m.meta = m.meta || {};
      if (m.meta.recordSeeded === true) return; // å·²åˆå§‹åŒ–éå°±ä¸ç¹¼æ‰¿

      const prevDate = findPreviousDate(targetDate); if (!prevDate) { m.meta.recordSeeded = true; return; }
      const prev = meetings[prevDate]; const prevRecords = prev?.cards?.col_record || [];
      m.cards = m.cards || {};
      if (!m.cards.col_record || m.cards.col_record.length === 0) {
        m.cards.col_record = JSON.parse(JSON.stringify(prevRecords));
      }
      m.meta.recordSeeded = true; // æ¨™è¨˜å·²åˆå§‹åŒ–ï¼ˆä¹‹å¾Œå°±ä¸å†è‡ªå‹•è£œï¼‰
    }

    /* ===== å»ºç«‹/åˆ‡æ›æ—¥æœŸ ===== */
    function confirmNewMeeting() {
      const date = document.getElementById('newMeetingDate').value; if (!date) return;
      if (document.body.getAttribute('data-edit') === 'true' && hasUnsaved) saveCurrentToVariable();

      if (!meetings[date]) {
        const prev = meetings[currentDay] || {
          attendees: [], chair:'', recorder:'', morning:'', afternoon:'',
          cards:{ col_record:[], col_tracking:[], col_target:[] },
          meta:{}
        };
        meetings[date] = {
          attendees: [],
          chair: prev.chair || '',
          recorder: prev.recorder || '',
          morning: prev.morning || '',
          afternoon: prev.afternoon || '',
          cards: { col_record: [], col_tracking: [], col_target: JSON.parse(JSON.stringify(prev.cards?.col_target || [])) },
          meta: { recordSeeded: false, trackingSeeded: false } // æ–°æ—¥æœŸï¼šå°šæœªåˆå§‹åŒ– â†’ æœƒå„åšä¸€æ¬¡ç¹¼æ‰¿
        };
      }

      currentDay = date;
      // æ–°æ—¥æœŸç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚åšä¸€æ¬¡ç¹¼æ‰¿
      maybeSeedRecord(date);
      maybeSeedTracking(date);

      closeModal(); refreshSidebar(); loadMeeting(date);
    }

    function refreshSidebar() {
      const bar = document.getElementById('dateSidebar');
      Array.from(bar.querySelectorAll('.side-icon:not(.side-add)')).forEach(el => el.remove());
      Object.keys(meetings).sort().reverse().forEach(date => {
        const btn = document.createElement('div');
        btn.className = `side-icon ${date === currentDay ? 'active' : ''}`;
        btn.innerHTML = date.substring(5).replace('-', '/');
        btn.onclick = () => loadMeeting(date);
        bar.insertBefore(btn, bar.lastElementChild);
      });
    }

    function ensureOption(selectEl, value) {
      // å…è¨±ç©ºç™½
      const found = Array.from(selectEl.options).some(o => o.value === (value ?? ""));
      if (!found) selectEl.add(new Option(value ?? "", value ?? ""));
    }

    const _origLoadMeeting = function(date) {
      currentDay = date;
      if (!meetings[date]) {
        meetings[date] = {
          attendees: [], chair: '', recorder: '', morning: '', afternoon: '',
          cards: { col_record: [], col_tracking: [], col_target: [] },
          meta: { recordSeeded: false, trackingSeeded: false }
