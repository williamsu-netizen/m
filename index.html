<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>æœƒè­°ç®¡ç† 29.1 - æ‰‹å‹•é‡‘é‘°å®‰å…¨ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    :root{ --bg:#f1f5f9; --card-bg:#fff; --text-main:#0f172a; --text-muted:#64748b; --border:#e2e8f0; --sidebar-bg:#fff; --accent:#0284c7; --input-bg:#f8fafc; }
    [data-theme="dark"]{ --bg:#0f172a; --card-bg:#1e293b; --text-main:#f8fafc; --text-muted:#94a3b8; --border:#334155; --sidebar-bg:#1e293b; --accent:#38bdf8; --input-bg:#0f172a; }
    html{ font-size:18px; height:100%; } body, input, select, textarea, button{ font-size:18px; } *{ box-sizing:border-box; transition:.15s ease; }
    body{ font-family:"PingFang TC","Microsoft JhengHei",sans-serif; background:var(--bg); color:var(--text-main); margin:0; display:flex; min-height:100dvh; overflow:auto; }
    
    .sidebar{ width:80px; background:var(--sidebar-bg); border-right:1px solid var(--border); display:flex; flex-direction:column; align-items:center; padding:20px 0; position: sticky; top: 0; height: 100vh; overflow-y: auto; }
    .side-icon{ width:55px; height:50px; border-radius:12px; background:var(--bg); margin-bottom:15px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px solid var(--border); color:var(--text-muted); font-size:0.85rem; position: relative; }
    .side-icon.active{ background:var(--accent); color:#fff; border-color:var(--accent); }
    .side-add{ border:2px dashed var(--text-muted) !important; font-size:1.5rem !important; color:var(--text-muted) !important; }
    
    .main{ flex:1; padding:20px; display:flex; flex-direction:column; }
    .header-section{ background:var(--card-bg); border-radius:16px; padding:20px; margin-bottom:20px; border:1px solid var(--border); }
    .info-row, .status-row{ display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:12px; }
    .input-group label{ display:block; color:var(--text-muted); margin-bottom:6px; font-weight:bold; }
    .input-group input, .input-group select{ background:var(--input-bg); border:1px solid var(--border); color:var(--text-main); padding:10px; border-radius:8px; width:100%; outline:none; }
    
    .attendee-list{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; min-height:42px; padding:6px; background:var(--input-bg); border-radius:10px; border:1px dashed var(--border); }
    .tag{ background:rgba(56,189,248,.1); color:var(--accent); padding:5px 14px; border-radius:50px; font-size:1rem; border:1px solid var(--accent); display:flex; align-items:center; gap:8px; font-weight:bold; }
    
    .board{ display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; flex:1; align-content:flex-start; }
    .column{ background:rgba(0,0,0,0.02); border-radius:16px; padding:16px; display:flex; flex-direction:column; min-height:400px; }
    .column-title{ font-weight:bold; margin-bottom:12px; color:var(--accent); border-bottom:2px solid var(--accent); padding-bottom:6px; font-size:20px; }
    
    .card{ background:var(--card-bg); border-radius:14px; padding:14px; margin-bottom:12px; border:1px solid var(--border); position:relative; }
    .card textarea{ width:100%; background:transparent; border:none; color:var(--text-main); resize:none; font-family:inherit; outline:none; line-height:1.6; overflow:hidden; }
    .card .c-title{ font-weight:bold; border-bottom:1px solid var(--border); margin-bottom:8px; padding-bottom:4px; }
    .card textarea.c-desc{ height:56px; }
    .card textarea.expanded{ height: auto; min-height: 56px; }
    
    .expand-btn{ font-size:0.9rem; color:var(--accent); text-align:center; cursor:pointer; padding:4px; margin-top:8px; border-top:1px dashed var(--border); font-weight:bold; }
    .card-meta{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; padding-top:10px; border-top:1px solid var(--border); }
    .p-tag { padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; border: 1px solid var(--border); }
    .p-high { background: #fee2e2 !important; color: #ef4444 !important; }
    .p-mid { background: #fef3c7 !important; color: #d97706 !important; }
    .p-low { background: #dcfce7 !important; color: #16a34a !important; }
    
    .move-btn { position:absolute; top:5px; right:35px; color:var(--accent); cursor:pointer; font-size:1.1rem; }

    #passwordGate { position: fixed; inset: 0; z-index: 2000; background: linear-gradient(135deg, rgba(15,23,42,.95), rgba(2,132,199,.9)); display: flex; align-items: center; justify-content: center; }
    .gate-panel { width: 92%; max-width: 440px; background: #fff; border-radius: 16px; padding: 22px; text-align: center; }
    .mini-dock{ position:fixed; right:20px; bottom:20px; z-index:900; display:flex; flex-direction:column; gap:10px; }
    .dock-btn{ width:44px; height:44px; border-radius:50%; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.2); }
    body[data-edit="false"] .del-x, body[data-edit="false"] .column button, body[data-edit="false"] .move-btn { display: none; }
  </style>
</head>
<body data-theme="light" data-edit="false">

  <div id="passwordGate">
    <div class="gate-panel">
      <h3>ğŸ” ç³»çµ±å®‰å…¨é©—è­‰</h3>
      <div style="display:flex; gap:8px; align-items:center; margin-top:15px;">
        <input type="password" id="gatePwd" style="flex:1; padding:12px; border-radius:10px; border:1px solid #ddd;" placeholder="è¼¸å…¥ç™»å…¥å¯†ç¢¼..." />
        <button onclick="toggleGatePwd()" style="background:none; border:none; cursor:pointer; font-size:1.3rem;" id="lockBtn">ğŸ”’</button>
      </div>
      <button onclick="verifyPassword()" style="width:100%; margin-top:15px; padding:12px; background:var(--accent); color:white; border:none; border-radius:8px; font-weight:bold;">é©—è­‰é€²å…¥</button>
      <div id="gateMsg" style="color:red; margin-top:10px;"></div>
    </div>
  </div>

  <div class="sidebar" id="dateSidebar">
    <div class="side-icon side-add" onclick="openModal()">+</div>
  </div>

  <div class="main">
    <div class="header-section">
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-bottom:12px;">
        <button onclick="expandAllCards()" style="background:var(--accent); color:#fff; border:none; padding:8px 14px; border-radius:8px; cursor:pointer;">â–¼ å…¨éƒ¨å±•é–‹</button>
        <button onclick="collapseAllCards()" style="background:#64748b; color:#fff; border:none; padding:8px 14px; border-radius:8px; cursor:pointer;">â–² å…¨éƒ¨æ”¶åˆ</button>
      </div>
      <div id="syncStatus" style="font-weight:bold; color:var(--accent); margin-bottom:10px;">â˜ï¸ æ­£åœ¨é€£ç·šä¸­...</div>
      
      <div class="info-row">
        <div class="input-group"><label>ğŸ“… å ±å‘Šæ—¥æœŸ</label><div style="display:flex; gap:5px;"><input type="date" id="mDateDisplay" onchange="handleDateChange()"><button class="icon-btn" onclick="editCurrentDate()">âœï¸</button></div></div>
        <div class="input-group"><label>ğŸ‘¤ ä¸»å¸­</label><select id="mChair"></select></div>
        <div class="input-group"><label>ğŸ“ ç´€éŒ„</label><select id="mRecorder"></select></div>
      </div>
      
      <div class="status-row">
        <div class="input-group"><label>ğŸ‘¥ å‡ºå¸­äººå“¡</label><select id="mAttendeeSelect" onchange="addAttendee(this.value); this.value='';"><option value="">-- æŒ‘é¸äººå“¡ --</option></select><div id="attendeeList" class="attendee-list"></div></div>
        <div class="input-group"><label>â˜€ï¸ æ—©ç­å ±å‘Š</label><select id="mRepMorning"></select></div>
        <div class="input-group"><label>â›… ä¸­ç­å ±å‘Š</label><select id="mRepAfternoon"></select></div>
      </div>
    </div>
    
    <div class="board" id="mainBoard">
      <div class="column" data-col="col_record"><div class="column-title">ğŸ“ å¹¹éƒ¨æœƒè­°ç´€éŒ„å…§å®¹</div><div id="col_record"></div><button onclick="addNewCard('col_record')">+ æ–°å¢æ±ºè­°</button></div>
      <div class="column" data-col="col_tracking"><div class="column-title" style="color:#15803d">ğŸ“ è¿½è¹¤äº‹é …ç›¤é»</div><div id="col_tracking"></div><button onclick="addNewCard('col_tracking')">+ æ–°å¢è¿½è¹¤</button></div>
      <div class="column" data-col="col_target"><div class="column-title" style="color:#b45309">ğŸ“ 2026å¹´åº¦ç›®æ¨™é€²åº¦</div><div id="col_target"></div><button onclick="addNewCard('col_target')">+ æ–°å¢é€²åº¦</button></div>
    </div>
  </div>

  <div class="mini-dock">
    <button class="dock-btn" style="background:#0d9488;" onclick="openSearchModal()">ğŸ”</button>
    <button class="dock-btn" style="background:#64748b;" onclick="toggleTheme()">ğŸŒ“</button>
    <button class="dock-btn" style="background:#f59e0b;" onclick="toggleEditMode()">âœï¸</button>
    <button class="dock-btn" style="background:#0284c7;" onclick="saveCurrentData()">ğŸ’¾</button>
    <button class="dock-btn" style="background:#0ea5e9;" onclick="saveAndSyncToCloud()">â˜ï¸</button>
  </div>

  <div id="dateModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1500; align-items:center; justify-content:center;"><div style="background:white; padding:25px; border-radius:16px; text-align:center;"><h3>ğŸ“… å»ºç«‹æ–°å ±å‘Š</h3><input type="date" id="newMeetingDate" style="width:100%; padding:10px; margin:15px 0;"><button onclick="confirmNewMeeting()" style="width:100%; padding:10px; background:var(--accent); color:white; border:none; border-radius:8px;">å»ºç«‹å ±å‘Š</button><p onclick="closeModal()" style="cursor:pointer; color:gray; margin-top:10px;">å–æ¶ˆ</p></div></div>

  <script>
    const VIEW_PWD_HASH = "7234cfd49e296717944942d5971c4defe963b303081a989cb241e5e60e53587d"; 
    const CLOUD_API_URL = "https://script.google.com/macros/s/AKfycbxtfU8YUXCQyea1qh8khk1XbUN-zd1XzoGsNJcjruVThrSt3r7uW1XtzAexOK5rQ6sfiA/exec";
    
    // ã€ä¿®æ”¹é»ï¼šå‹•æ…‹å–å¾— Tokenã€‘
    let API_TOKEN = sessionStorage.getItem('SESSION_TOKEN');

    const cadres = ["è˜‡æ¸…æº","æ›¾é›ªå¦®","é»ƒå©·éˆº","è”¡ç­‘ç","è•­ç¿Šç¿","é™³ç«è«­","æå®¶æ§¿","ä¿Šç”Ÿéƒ¨é•·"];
    const categories = ["å®¢æœ","VIP","å…¨éƒ¨"];

    let meetings = JSON.parse(localStorage.getItem('MeetingV27_Data')) || {};
    let currentDay = "";

    function toggleGatePwd(){ const el = document.getElementById('gatePwd'); const btn = document.getElementById('lockBtn'); el.type = el.type==='password'?'text':'password'; btn.textContent = el.type==='password'?'ğŸ”’':'ğŸ”“'; }
    
    function verifyPassword(){ 
      const v = document.getElementById('gatePwd').value.trim(); 
      if(CryptoJS.SHA256(v).toString() === VIEW_PWD_HASH){ 
        
        // é©—è­‰éé–€ç¦å¾Œï¼Œè‹¥æ²’ Token å‰‡è©¢å•
        if(!API_TOKEN){
          API_TOKEN = prompt("è«‹è¼¸å…¥é›²ç«¯é‡‘é‘° (Token)ï¼š");
          if(API_TOKEN){
            sessionStorage.setItem('SESSION_TOKEN', API_TOKEN);
          } else {
            alert("æœªè¼¸å…¥é‡‘é‘°ï¼Œå°‡ç„¡æ³•åŒæ­¥é›²ç«¯ã€‚");
          }
        }
        
        document.getElementById('passwordGate').style.display='none'; 
        startApp(); 
      } else { 
        document.getElementById('gateMsg').innerText="å¯†ç¢¼éŒ¯èª¤"; 
      } 
    }
    
    function startApp(){ coreInit(); fetchCloudData(); }
    function coreInit(){ 
      ['mChair','mRecorder','mRepMorning','mRepAfternoon','mAttendeeSelect'].forEach(id => {
        const el = document.getElementById(id); if(!el) return;
        el.innerHTML = id==='mAttendeeSelect'?'<option value="">-- æŒ‘é¸äººå“¡ --</option>':'<option value=""></option>';
        cadres.forEach(n => el.add(new Option(n, n)));
      });
    }

    async function fetchCloudData(){
      if(!API_TOKEN) {
        document.getElementById('syncStatus').innerText="âš ï¸ æœªè¼¸å…¥é‡‘é‘°ï¼Œåƒ…é™é›¢ç·šç€è¦½";
        return;
      }
      try {
        const res = await fetch(`${CLOUD_API_URL}?token=${encodeURIComponent(API_TOKEN)}&t=${Date.now()}`);
        const text = await res.text();
        if(text === "é©—è­‰å¤±æ•—") throw new Error("Token éŒ¯èª¤");
        
        meetings = JSON.parse(text) || {};
        const dates = Object.keys(meetings).sort().reverse();
        if(dates.length > 0) loadMeeting(dates[0]);
        renderSidebar(); document.getElementById('syncStatus').innerText="â˜ï¸ é›²ç«¯åŒæ­¥å®Œæˆ";
      } catch(e){ 
        document.getElementById('syncStatus').innerText="âš ï¸ é€£ç·šå¤±æ•—æˆ–é‡‘é‘°éŒ¯èª¤"; 
      }
    }

    function loadMeeting(date){
      currentDay = date; const data = meetings[date] || { attendees:[], cards:{col_record:[], col_tracking:[], col_target:[]} };
      document.getElementById('mDateDisplay').value = date;
      document.getElementById('mChair').value = data.chair || '';
      document.getElementById('mRecorder').value = data.recorder || '';
      document.getElementById('mRepMorning').value = data.morning || '';
      document.getElementById('mRepAfternoon').value = data.afternoon || '';
      document.getElementById('attendeeList').innerHTML = "";
      (data.attendees || []).forEach(n => renderAttendee(n));
      ['col_record','col_tracking','col_target'].forEach(id => {
        const cont = document.getElementById(id); cont.innerHTML = "";
        const arr = (data.cards && data.cards[id]) ? data.cards[id] : [];
        arr.forEach(c => addNewCard(id, c, true));
      });
      renderSidebar(); updateLocks(); collapseAllCards();
    }

    function addNewCard(colId, data=null, isR=false){
      const col = document.getElementById(colId); const card = document.createElement('div'); card.className='card';
      const d = data || { title:'', desc:'', priority:'mid', owner:'å…¨éƒ¨', cat:'å…¨éƒ¨', keep:true };
      const keepHtml = colId==='col_tracking' ? `<label style="font-size:0.8rem;"><input type="checkbox" class="m-keep" ${d.keep?'checked':''}>ä¿ç•™</label>` : '<div></div>';
      const moveBtnHtml = colId==='col_record' ? `<div class="move-btn" title="æ¬ç§»è‡³è¿½è¹¤äº‹é …" onclick="moveToTracking(this)">ğŸšš</div>` : '';

      card.innerHTML = `
        <div class="del-x" style="position:absolute; top:5px; right:10px; color:red; cursor:pointer;" onclick="this.parentElement.remove()">âœ•</div>
        ${moveBtnHtml}
        <textarea class="c-title" placeholder="æ¨™é¡Œ">${d.title}</textarea>
        <textarea class="c-desc" placeholder="å…§å®¹...">${d.desc}</textarea>
        <div class="expand-btn" onclick="toggleExpand(this)">â–¼ å±•é–‹</div>
        <div class="card-meta">
          <select class="p-tag p-${d.priority}" onchange="this.className='p-tag p-'+this.value"><option value="high" ${d.priority==='high'?'selected':''}>é«˜</option><option value="mid" ${d.priority==='mid'?'selected':''}>ä¸­</option><option value="low" ${d.priority==='low'?'selected':''}>ä½</option></select>
          <select class="m-cat">${categories.map(c=>`<option ${d.cat===c?'selected':''}>${c}</option>`).join('')}</select>
          <select class="m-own"><option>å…¨éƒ¨</option>${cadres.map(n=>`<option ${d.owner===n?'selected':''}>${n}</option>`).join('')}</select>
          ${keepHtml}
        </div>`;
      col.appendChild(card);
      const descArea = card.querySelector('.c-desc');
      descArea.addEventListener('input', function() { if(this.classList.contains('expanded')) { this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'; } });
      if(!isR) updateLocks();
    }

    function moveToTracking(btn) {
      const card = btn.parentElement;
      const data = {
        title: card.querySelector('.c-title').value,
        desc: card.querySelector('.c-desc').value,
        priority: card.querySelector('.p-tag').value,
        cat: card.querySelector('.m-cat').value,
        owner: card.querySelector('.m-own').value,
        keep: true 
      };
      addNewCard('col_tracking', data, false);
      card.remove();
    }

    function confirmNewMeeting(){ 
      const newDate = document.getElementById('newMeetingDate').value; 
      if(!newDate) return;
      const sortedDates = Object.keys(meetings).sort().reverse();
      const lastDate = sortedDates[0];
      if(lastDate && !meetings[newDate]) {
        const lastData = meetings[lastDate];
        meetings[newDate] = JSON.parse(JSON.stringify(lastData)); 
      } else {
        meetings[newDate] = { attendees:[], chair:'', recorder:'', morning:'', afternoon:'', cards:{col_record:[], col_tracking:[], col_target:[]} };
      }
      loadMeeting(newDate); 
      closeModal(); 
    }

    function toggleExpand(btn){ 
      const desc = btn.parentElement.querySelector('.c-desc'); 
      if(desc.classList.toggle('expanded')){ 
        desc.style.height = 'auto'; desc.style.height = desc.scrollHeight + 'px'; btn.innerText = "â–² æ”¶åˆ"; 
      } else { desc.style.height = '56px'; btn.innerText = "â–¼ å±•é–‹"; } 
    }

    function expandAllCards(){ document.querySelectorAll('.c-desc').forEach(d=>{ d.classList.add('expanded'); d.style.height = 'auto'; d.style.height = d.scrollHeight + 'px'; d.parentElement.querySelector('.expand-btn').innerText = "â–² æ”¶åˆ"; }); }
    function collapseAllCards(){ document.querySelectorAll('.c-desc').forEach(d=>{ d.classList.remove('expanded'); d.style.height = '56px'; d.parentElement.querySelector('.expand-btn').innerText = "â–¼ å±•é–‹"; }); }

    function saveToVar(){
      const getC = id => Array.from(document.getElementById(id).querySelectorAll('.card')).map(c => ({
        title: c.querySelector('.c-title').value, desc: c.querySelector('.c-desc').value,
        priority: c.querySelector('.p-tag').value, cat: c.querySelector('.m-cat').value,
        owner: c.querySelector('.m-own').value, keep: c.querySelector('.m-keep')?.checked || false
      }));
      meetings[currentDay] = {
        chair: document.getElementById('mChair').value, recorder: document.getElementById('mRecorder').value,
        morning: document.getElementById('mRepMorning').value, afternoon: document.getElementById('mRepAfternoon').value,
        attendees: Array.from(document.querySelectorAll('.tag')).map(t => t.dataset.name),
        cards: { col_record: getC('col_record'), col_tracking: getC('col_tracking'), col_target: getC('col_target') }
      };
      localStorage.setItem('MeetingV27_Data', JSON.stringify(meetings));
    }

    async function saveAndSyncToCloud(){ 
      if(!API_TOKEN) { alert("ç„¡é‡‘é‘°ï¼Œç„¡æ³•åŒæ­¥"); return; }
      saveToVar(); 
      try { 
        await fetch(CLOUD_API_URL+"?token="+encodeURIComponent(API_TOKEN), { method:'POST', mode:'no-cors', body:JSON.stringify(meetings)}); 
        alert("åŒæ­¥è«‹æ±‚å·²ç™¼é€ï¼"); 
      } catch(e){ alert("å¤±æ•—"); } 
    }

    function renderAttendee(n){ const tag = document.createElement('div'); tag.className='tag'; tag.dataset.name=n; tag.innerHTML=`<span>${n}</span><span class="del-x" onclick="this.parentElement.remove()">âœ•</span>`; document.getElementById('attendeeList').appendChild(tag); }
    function addAttendee(n){ if(n) renderAttendee(n); }
    function toggleEditMode(){ const isE = document.body.getAttribute('data-edit')==='true'; document.body.setAttribute('data-edit', !isE); updateLocks(); renderSidebar(); }
    function updateLocks(){ const isE = document.body.getAttribute('data-edit')==='true'; document.querySelectorAll('input, select, textarea, .column button').forEach(el => el.disabled = !isE); }
    function renderSidebar(){ const bar = document.getElementById('dateSidebar'); const add = bar.querySelector('.side-add'); bar.innerHTML = ""; bar.appendChild(add); Object.keys(meetings).sort().reverse().forEach(d => { const btn = document.createElement('div'); btn.className=`side-icon ${d===currentDay?'active':''}`; btn.innerText=d.slice(5); btn.onclick=()=>loadMeeting(d); bar.appendChild(btn); }); }
    function openModal(){ document.getElementById('dateModal').style.display='flex'; }
    function closeModal(){ document.getElementById('dateModal').style.display='none'; }
    function editCurrentDate(){ const n = document.getElementById('mDateDisplay').value; if(n && n!==currentDay){ saveToVar(); meetings[n]=meetings[currentDay]; delete meetings[currentDay]; loadMeeting(n); } }
    function saveCurrentData(){ saveToVar(); alert("å­˜æª”æˆåŠŸ"); }
    function toggleTheme(){ document.body.setAttribute('data-theme', document.body.getAttribute('data-theme')==='dark'?'light':'dark'); }
    
    window.onload = () => { document.getElementById('passwordGate').style.display='flex'; };
  </script>
</body>
</html>
